<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRAMATIQUÊS - Prática de Gramática Portuguesa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Slab:wght@700&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0; /* Cinza claro sólido */
        }
        .title-font {
            font-family: 'Roboto Slab', serif;
        }
        /* Nova classe para a fonte "Modo Concurseiro" */
        .concurseiro-font {
            font-family: 'Pacifico', cursive; /* Usando Pacifico como alternativa a Bodega Script */
        }
        .option-btn {
            transition: all 0.2s ease-in-out;
            /* Novos estilos para os botões de opção */
            background-color: #e0f7fa; /* light-blue-50 */
            border-color: #81d4fa; /* light-blue-200 */
            color: #006064; /* deep-teal-800 */
        }
        .option-btn:hover {
            background-color: #b2ebf2; /* light-blue-100 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .correct {
            background-color: #22c55e !important; /* green-500 */
            color: white !important;
            border-color: #16a34a; /* green-600 */
            transform: scale(1.02);
        }
        .incorrect {
            background-color: #ef4444 !important; /* red-500 */
            color: white !important;
            border-color: #dc2626; /* red-600 */
        }
        .disabled {
            pointer-events: none;
            opacity: 0.9;
        }
        .topic-card {
            page-break-inside: avoid;
            break-inside: avoid;
            /* Novos estilos para os cartões de tópico */
            border-left: 8px solid #0ea5e9; /* sky-500 */
            transition: all 0.2s ease-in-out;
        }
        .topic-card:hover {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-3px);
        }
        .topic-list-grid { /* Alterado de #topic-list para .topic-list-grid */
            column-count: 1;
        }
        @media (min-width: 768px) {
            .topic-list-grid { /* Alterado de #topic-list para .topic-list-grid */
                column-count: 2;
            }
        }
        /* Estilos para o Modal */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-container {
            transition: all 0.3s ease;
            /* Ajustes para o tamanho e rolagem dos modais */
            max-height: 90vh; /* Limita a altura máxima para caber na tela */
            overflow-y: auto; /* Adiciona rolagem vertical se o conteúdo exceder a altura */
        }
        /* Estilos para o spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilo para o popup de informações */
        .info-popup {
            position: absolute;
            bottom: 1.5rem; /* Ajustado para descer mais */
            right: 0.5rem; /* Mantido no canto direito */
            background-color: #fff;
            padding: 0.6rem 0.8rem; /* Reduzido em aproximadamente 20% */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-size: 0.7rem; /* Reduzido em aproximadamente 20% */
            color: #475569; /* slate-600 */
            z-index: 50; /* Garante que fique acima de outros elementos */
        }
        /* Ajuste para a tela inicial para permitir posicionamento absoluto do popup */
        #home-screen {
            position: relative; /* Necessário para posicionar o popup absolutamente dentro dela */
            overflow: hidden; /* Para garantir que o fundo de texto não vaze */
        }
        /* Estilo para o fundo de texto transparente */
        .text-background-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Permite cliques nos elementos abaixo */
            z-index: 1; /* Garante que fique atrás do conteúdo principal */
            color: rgba(100, 100, 100, 0.08); /* Cinza muito claro com mais transparência */
            font-size: 1.8rem; /* Ligeiramente maior */
            line-height: 1.8;
            text-align: center;
            overflow: hidden;
            word-break: break-all;
            white-space: pre-wrap; /* Preserva espaços em branco e quebras de linha */
            user-select: none; /* Impede seleção de texto */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05); /* Sombra sutil para efeito 3D */
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 100px,
                rgba(220, 220, 220, 0.03) 100px, /* Ajuste para mais transparência no gradiente também */
                rgba(220, 220, 220, 0.03) 200px
            );
        }
        /* Estilo para o ícone do professor no modal */
        .professor-icon {
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
            color: #4f46e5; /* indigo-600 */
        }
        /* Estilo para o ícone de ajuda */
        .help-icon {
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
            color: #fff; /* white */
        }
        /* Estilo para o iframe do YouTube */
        .video-responsive {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            max-width: 100%;
            background: #000;
            border-radius: 0.5rem;
        }
        .video-responsive iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        .difficulty-label.selected,
        .response-mode-label.selected { /* Adicionado para o modo de resposta */
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border-color: #3b82f6;
        }

        /* Estilos para a Tela Final */
        #final-screen {
            background: linear-gradient(to bottom right, #e0f2fe, #bbdefb); /* Gradiente azul claro */
            border-radius: 1.5rem; /* Cantos mais arredondados */
            padding: 3rem; /* Mais padding */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); /* Sombra mais pronunciada */
            animation: fadeInScale 0.5s ease-out forwards;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        #final-screen h2 {
            color: #1e40af; /* Azul mais escuro */
            font-size: 3.5rem; /* Título maior */
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        #final-screen #final-topic {
            color: #1d4ed8; /* Azul médio */
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
        }

        #final-screen .text-lg.text-slate-600 {
            color: #475569; /* Cinza slate */
            font-weight: 500;
        }

        #final-screen #final-score {
            color: #059669; /* Verde esmeralda */
            font-size: 7rem; /* Pontuação gigante */
            font-weight: 800;
            margin-bottom: 2rem;
            text-shadow: 3px 33px 6px rgba(0, 0, 0, 0.2);
        }

        #final-screen #final-time {
            color: #64748b; /* Cinza mais escuro */
            font-size: 1.25rem;
            margin-bottom: 2.5rem;
        }

        #final-screen .flex button {
            padding: 1rem 2rem;
            border-radius: 9999px; /* Botões completamente arredondados */
            font-size: 1.1rem;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #final-screen #restart-quiz {
            background-color: #2563eb; /* Azul vibrante */
            color: white;
            border: 2px solid #1d4ed8;
        }
        #final-screen #restart-quiz:hover {
            background-color: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
        }

        #final-screen #back-to-menu-final,
        #final-screen #back-to-home-from-final {
            background-color: #cbd5e1; /* Cinza mais claro */
            color: #334155;
            border: 2px solid #94a3b8;
        }
        #final-screen #back-to-menu-final:hover,
        #final-screen #back-to-home-from-final:hover {
            background-color: #94a3b8;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
        }

        /* Novo estilo para o modal de texto */
        .text-modal-content {
            background-color: #fff; /* Fundo branco */
            border: 1px solid #e0e0e0; /* Borda sutil */
            border-radius: 8px;
            padding: 1.5rem;
            line-height: 1.6;
            font-size: 1rem;
            color: #333; /* Cor do texto mais escura */
            max-height: 70vh; /* Altura máxima para rolagem */
            overflow-y: auto; /* Habilita a rolagem vertical */
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05); /* Sombra interna sutil */
            position: relative;
            background-image: linear-gradient(to bottom, #f9f9f9 1px, transparent 1px); /* Linhas de caderno */
            background-size: 100% 1.8em; /* Altura da linha */
        }
        .text-modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 40px; /* Margem esquerda para a linha vertical */
            bottom: 0;
            width: 1px;
            background-color: rgba(255, 0, 0, 0.2); /* Linha vertical vermelha clara */
        }
        /* Estilo para o conteúdo do modal de estudo */
        #study-text {
            color: #333; /* Cor do texto mais escura para o conteúdo de estudo */
        }

        /* Estilos para o modal de autenticação */
        .auth-tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem 0.5rem 0 0;
            font-weight: 600;
            color: #64748b; /* slate-500 */
            background-color: #e2e8f0; /* slate-200 */
            transition: all 0.2s ease-in-out;
            border-bottom: 2px solid transparent;
        }
        .auth-tab-button.active {
            color: #3b82f6; /* blue-500 */
            background-color: #fff;
            border-bottom: 2px solid #3b82f6;
        }
        .auth-tab-content {
            padding: 1.5rem;
            background-color: #fff;
            border-radius: 0 0 0.5rem 0.5rem;
        }
        /* Estilo para a descrição do diagrama */
        .diagram-description {
            background-color: #f0f9ff; /* light-blue-50 */
            border-left: 4px solid #0ea5e9; /* sky-500 */
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 0.5rem;
            font-style: italic;
            color: #0c4a6e; /* sky-900 */
            font-size: 0.95rem;
        }
        /* Estilo para o Canvas */
        #diagram-canvas {
            width: 100%; /* Faz o canvas ocupar a largura total do seu contêiner */
            max-width: 400px; /* Limita a largura máxima para não ficar muito grande em desktops */
            height: 300px; /* Altura fixa para o canvas */
            display: block; /* Remove espaço extra abaixo do canvas */
            margin: 0 auto 1.5rem auto; /* Centraliza e adiciona margem inferior */
            background-color: #ffffff; /* Fundo branco para o canvas */
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* Sombra sutil */
        }

        /* Estilos para o pop-up de correção em tempo real */
        .correction-popup {
            position: absolute;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
            padding: 0.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 100;
            font-size: 0.875rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .correction-popup button {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .correction-popup button:hover {
            background-color: #2563eb; /* blue-600 */
        }
        .correction-popup .suggestion {
            font-weight: 600;
            color: #1e40af; /* blue-800 */
        }

        /* Estilos para as textareas de redação */
        .essay-section-textarea {
            min-height: 80px; /* Altura mínima padrão */
            line-height: 1.5; /* Espaçamento entre linhas */
        }

        /* Estilo para o botão de ajuda */
        .help-button-icon {
            color: #6b7280; /* slate-500 */
            cursor: pointer;
            transition: color 0.2s;
        }
        .help-button-icon:hover {
            color: #4f46e5; /* indigo-600 */
        }
        .help-button-icon.disabled {
            pointer-events: none;
            opacity: 0.5;
        }

        /* Novas classes para estilização de texto no modal de estudo */
        .highlight-term {
            color: #dc2626; /* red-600 */
            font-weight: bold;
        }
        .underline-text {
            text-decoration: underline;
            text-decoration-color: #2563eb; /* blue-600 */
            text-decoration-thickness: 2px;
        }
        .important-phrase {
            color: #047857; /* emerald-700 */
            background-color: #d1fae5; /* green-100 */
            padding: 2px 4px;
            border-radius: 4px;
        }

        /* Ajuste para botões de estudo */
        .study-button {
            display: flex;
            align-items: center;
            padding: 0.3rem 0.6rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
        }
        .study-button {
            background-color: #e0f2fe; /* blue-50 */
            color: #2563eb; /* blue-600 */
            border: 1px solid #93c5fd; /* blue-300 */
        }
        .study-button:hover {
            background-color: #bfdbfe; /* blue-100 */
        }
        .study-button svg {
            margin-right: 0.25rem;
        }

    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-3xl mx-auto">
        
        <!-- Tela Inicial (Home Screen) -->
        <div id="home-screen" class="text-center">
            <!-- Fundo de texto transparente -->
            <div class="text-background-overlay">
                Gramática Morfologia Sintaxe Fonética Fonologia Acentuação Ortografia Hífen Fonemas Encontros Vocálicos Substantivo Adjetivo Verbo Artigo Pronome Advérbio Preposição Conjunção Numeral Interjeição Morfema Termos Essenciais Sujeito Predicado Termos Integrantes Objeto Direto Objeto Indireto Complemento Nominal Agente da Passiva Termos Acessórios Adjunto Adnominal Adjunto Adverbial Aposto Vocativo Concordância Verbal Concordância Nominal Regência Verbal Regência Nominal Transitividade Verbal Vozes do Verbo Voz Ativa Voz Passiva Voz Reflexiva Uso da Vírgula Crase Orações Reduzidas Colocação Pronominal Funções do Que e Se Pontuação Português Língua Portuguesa Estudo Prática Aprender Conhecimento
            </div>

            <header class="mb-10 relative z-10">
                <h1 class="text-5xl md:text-6xl font-bold text-slate-700 title-font">GRAMATIQUÊS</h1>
                <!-- Novo elemento para "Modo Concurseiro" com contorno -->
                <div class="inline-block border-2 border-indigo-600 rounded-lg px-4 py-2 mt-2 bg-white shadow-md">
                    <p class="text-indigo-700 text-2xl concurseiro-font">Modo Concurseiro</p>
                </div>
                <p class="text-slate-500 mt-2 text-lg">Aprenda e pratique para a sua aprovação!</p>
            </header>
            <main class="flex justify-center items-center h-64 relative z-10">
                <!-- Ícone SVG com corte lateral no primeiro círculo -->
                <svg class="w-48 h-48 text-sky-600 drop-shadow-lg" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <!-- Círculo externo com corte lateral -->
                    <path d="M 18 4 A 10 10 0 1 0 18 20" stroke="currentColor" stroke-width="2" fill="none"/>
                    <!-- Círculo interno -->
                    <circle cx="12" cy="12" r="5" fill="currentColor"/>
                </svg>
            </main>
            <div id="level-selection-section" class="mt-8 relative z-10">
                <h3 class="text-2xl font-bold text-slate-700 mb-4">Selecione a opção:</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 max-w-2xl mx-auto">
                    <!-- Botões para as diferentes matérias -->
                    <button id="level-enem" class="level-select-btn bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg" data-level="enem">
                        Língua Portuguesa
                    </button>
                    <button id="level-pedagogicos" class="level-select-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg" data-level="pedagogicos">
                        Conhecimentos Pedagógicos
                    </button>
                    <button id="level-redacao" class="level-select-btn bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg" data-level="redacao">
                        Redação - Conteúdo
                    </button>
                    <button id="level-redacao-correcao" class="level-select-btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg" data-level="redacao-correcao">
                        Redação - Correção de Texto
                    </button>
                    <button id="level-bonus" class="level-select-btn bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg" data-level="bonus">
                        Direito
                    </button>
                    <button id="level-leis" class="level-select-btn bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg" data-level="leis">
                        Leis e Diretrizes da Educação
                    </button>
                    <!-- Novo botão para Noções de Informática -->
                    <button id="level-informatica" class="level-select-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg" data-level="informatica">
                        Noções de Informática
                    </button>
                </div>
                <button id="enter-app-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition-colors shadow-lg opacity-50 cursor-not-allowed" disabled>
                    Iniciar
                </button>
            </div>
            <footer class="mt-8 relative z-10 text-xs text-slate-500">
                <p>Desenvolvido por: Prof.º Marlon Costa - Língua Portuguesa e Literatura / Gramatiquês Versão 1.0</p>
            </footer>
        </div>

        <!-- Tela de Seleção de Tópico (para níveis não-concurseiro) - Será escondida permanentemente -->
        <div id="topic-selection-screen" class="hidden">
            <header class="text-center mb-10">
                <h1 class="text-5xl md:text-6xl font-bold text-slate-700 title-font">GRAMATIQUÊS</h1>
                <p class="text-slate-500 mt-2 text-lg">Selecione um ou mais tópicos para estudar ou praticar.</p>
            </header>
            <main id="topic-container-quiz" class="space-y-8">
                <!-- Categorias e Tópicos serão inseridos aqui -->
            </main>
            <footer class="mt-8 text-center flex flex-col sm:flex-row justify-center items-center gap-4">
                <div class="flex items-center gap-2">
                    <label for="question-quantity-quiz" class="text-slate-700 font-semibold">Questões:</label>
                    <input type="number" id="question-quantity-quiz" value="10" min="1" class="w-20 p-2 border border-slate-300 rounded-lg text-center">
                </div>
                <button id="start-selected-quiz" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-8 rounded-lg transition-colors shadow-lg opacity-50 cursor-not-allowed" disabled>
                    Iniciar Quiz com Tópicos Selecionados
                </button>
                <button id="back-to-home-from-topics" class="back-to-home bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-3 px-6 rounded-lg transition-colors">
                    Voltar para o Início
                </button>
            </footer>
        </div>

        <!-- Tela de Configuração do Simulado (para nível Concurseiro) -->
        <div id="simulado-setup-screen" class="hidden">
            <header class="text-center mb-10">
                <h1 class="text-5xl md:text-6xl font-bold text-slate-700 title-font">SIMULADO GRAMATIQUÊS</h1>
                <p class="text-slate-500 mt-2 text-lg">Selecione os tópicos e configure seu simulado.</p>
            </header>
            <div class="mb-6 max-w-2xl mx-auto">
                <label for="topic-search-input" class="block text-lg font-semibold text-slate-700 mb-2">
                    Pesquisar Tópico:
                </label>
                <input type="text" id="topic-search-input" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 text-slate-700" placeholder="Digite para pesquisar tópicos...">
            </div>
            <main id="topic-container-simulado" class="space-y-8">
                <!-- As novas categorias de tópicos serão inseridas aqui -->
            </main>
            <div class="mt-8 text-center flex flex-col items-center gap-4">
                <!-- Botões de configuração -->
                <div class="flex flex-wrap justify-center gap-4 w-full max-w-lg mx-auto">
                    <div class="flex flex-col items-center">
                        <button id="btn-num-questions" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg">
                            Nº de Questões
                        </button>
                        <p id="display-num-questions" class="text-black font-bold text-sm mt-1">---</p>
                    </div>
                    <div class="flex flex-col items-center">
                        <button id="btn-difficulty" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg">
                            Nível
                        </button>
                        <p id="display-difficulty" class="text-black font-bold text-sm mt-1">---</p>
                    </div>
                    <div class="flex flex-col items-center">
                        <button id="btn-response-mode" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg">
                            Tipo de Gabarito
                        </button>
                        <p id="display-response-mode" class="text-black font-bold text-sm mt-1">---</p>
                    </div>
                </div>
                
                <button id="start-simulado" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition-colors shadow-lg opacity-50 cursor-not-allowed mt-6">
                    Gerar Simulado
                </button>
                <button id="back-to-home-from-simulado-setup" class="back-to-home bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-3 px-6 rounded-lg transition-colors">
                    Voltar para o Início
                </button>
            </div>
        </div>

        <!-- Tela de Leis e Diretrizes -->
        <div id="laws-screen" class="hidden">
            <header class="text-center mb-10">
                <h1 class="text-5xl md:text-6xl font-bold text-slate-700 title-font">LEIS E DIRETRIZES</h1>
                <p class="text-slate-500 mt-2 text-lg">Consulte os principais documentos da educação brasileira.</p>
            </header>
            <main id="laws-list-container" class="space-y-4 max-w-2xl mx-auto">
                <!-- Lista de leis será inserida aqui -->
            </main>
            <footer class="mt-8 text-center">
                <button id="back-to-home-from-laws" class="back-to-home bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-3 px-6 rounded-lg transition-colors">
                    Voltar para o Início
                </button>
            </footer>
        </div>

        <!-- Tela do Quiz -->
        <div id="quiz-screen" class="hidden">
            <header class="mb-8 p-4 bg-gradient-to-br from-blue-100 to-blue-200 rounded-xl shadow-md max-w-2xl mx-auto">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 id="quiz-topic-title" class="text-2xl font-bold text-sky-700"></h2>
                        <p id="question-counter" class="text-slate-500"></p>
                    </div>
                    <div class="text-right">
                        <p class="text-slate-500">Pontuação</p>
                        <p id="score" class="text-2xl font-bold text-slate-700">0</p>
                    </div>
                </div>
                <!-- Timer para Simulado -->
                <div id="timer-display-container" class="text-center text-lg font-semibold text-slate-700 mb-4 hidden">
                    Tempo: <span id="timer-display">00:00</span>
                </div>
                <!-- Barra de Progresso -->
                <div class="w-full bg-blue-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-sky-500 h-2.5 rounded-full transition-all duration-300 ease-out" style="width: 0%;"></div>
                </div>
            </header>

            <main id="question-container" class="bg-gradient-to-br from-blue-100 to-blue-200 p-6 md:p-8 rounded-xl shadow-md max-w-2xl mx-auto">
                <div id="loading-area" class="flex flex-col justify-center items-center h-40 hidden">
                    <div class="spinner mb-2"></div>
                    <p id="loading-text" class="text-slate-600 font-semibold">Gerando Questões...</p>
                </div>
                <div id="quiz-content">
                    <p id="question-text" class="text-lg md:text-xl mb-6 min-h-[60px]"></p>
                    <!-- Botão "+ Texto" -->
                    <button id="show-text-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg mb-4 hidden">
                        + Texto
                    </button>
                    <div id="options-container" class="flex flex-col space-y-3">
                        <!-- Opções serão inseridas aqui -->
                    </div>
                </div>
            </main>

            <footer class="mt-6 flex flex-wrap justify-center items-center gap-4 max-w-2xl mx-auto">
                <button id="back-to-menu" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg transition-colors">
                    Menu
                </button>
                <!-- Botão "Perguntar ao Gramatiquinho" (visível apenas para quizzes normais) -->
                <button id="ask-friends-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg flex items-center">
                    <span class="help-icon">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                    </span> Perguntar ao Gramatiquinho (<span id="friends-help-count">3</span>)
                </button>
                <!-- Botão "Recurso da Questão" -->
                <button id="appeal-question-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg flex items-center hidden">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                    </svg>
                    Recurso da Questão
                </button>
                <button id="next-question" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg hidden">
                    Próxima Pergunta &rarr;
                </button>
            </footer>
        </div>

        <!-- Tela Final -->
        <div id="final-screen" class="hidden text-center bg-white p-8 rounded-xl shadow-md max-w-2xl mx-auto">
            <h2 class="text-3xl font-bold text-slate-700 mb-2">Quiz Finalizado!</h2>
            <p id="final-topic" class="text-xl text-sky-700 font-semibold mb-4"></p>
            <p class="text-lg text-slate-600 mb-1">Sua pontuação final foi:</p>
            <p id="final-score" class="text-6xl font-bold text-slate-800 mb-4"></p>
            <p id="final-time" class="text-lg text-slate-600 mb-8 hidden"></p> <!-- Tempo final do simulado -->
            <div class="flex flex-wrap justify-center gap-4">
                <button id="restart-quiz" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                    Tentar Novamente
                </button>
                <button id="back-to-menu-final" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-3 px-6 rounded-lg transition-colors">
                    Escolher outro Tópico
                </button>
                <button id="back-to-home-from-final" class="back-to-home bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-3 px-6 rounded-lg transition-colors">
                    Voltar à Tela Inicial
                </button>
            </div>
        </div>

        <!-- Tela de Correção de Redação -->
        <div id="essay-correction-screen" class="hidden">
            <header class="text-center mb-10">
                <h1 class="text-5xl md:text-6xl font-bold text-slate-700 title-font">PRÁTICA DE REDAÇÃO</h1>
                <p class="text-slate-500 mt-2 text-lg">Pratique a estrutura da sua redação e receba feedback.</p>
            </header>
            <main class="bg-white p-6 md:p-8 rounded-xl shadow-md max-w-2xl mx-auto relative">
                <div id="theme-display" class="bg-blue-50 p-3 rounded-lg border border-blue-200 text-blue-800 font-semibold mb-4 hidden">
                    <p class="text-sm text-blue-600">Tema da Redação:</p>
                    <p id="generated-theme-text" class="text-lg"></p>
                </div>
                
                <!-- Botão Gerar Tema (movido para cima) -->
                <div class="flex flex-wrap justify-center gap-4 mb-6">
                    <button id="generate-theme-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg">
                        Gerar Tema de Redação
                    </button>
                </div>

                <!-- Campo de Título Opcional -->
                <div class="mb-6">
                    <label for="essay-title-input" class="block text-lg font-semibold text-slate-700 mb-2">
                        Título (Opcional):
                    </label>
                    <input type="text" id="essay-title-input" class="w-full p-4 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-slate-700" placeholder="Digite o título da sua redação aqui...">
                </div>

                <div class="mb-6">
                    <label for="intro-input" class="block text-lg font-semibold text-slate-700 mb-2">
                        Introdução:
                        <button type="button" class="help-button-icon align-middle" data-section="introducao" title="Dicas de Introdução">
                            <span class="text-xl">🤝</span> Ajuda
                        </button>
                    </label>
                    <textarea id="intro-input" class="essay-section-textarea w-full p-4 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 resize-y text-slate-700" placeholder="Comece sua introdução aqui..."></textarea>
                </div>
                <div class="mb-6">
                    <label for="dev-input" class="block text-lg font-semibold text-slate-700 mb-2">
                        Desenvolvimento:
                        <button type="button" class="help-button-icon align-middle" data-section="desenvolvimento" title="Dicas de Desenvolvimento">
                            <span class="text-xl">🤝</span> Ajuda
                        </button>
                    </label>
                    <textarea id="dev-input" class="essay-section-textarea w-full p-4 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 resize-y text-slate-700" placeholder="Desenvolva seus argumentos aqui..."></textarea>
                </div>
                <div class="mb-6">
                    <label for="conc-input" class="block text-lg font-semibold text-slate-700 mb-2">
                        Conclusão:
                        <button type="button" class="help-button-icon align-middle" data-section="conclusao" title="Dicas de Conclusão">
                            <span class="text-xl">🤝</span> Ajuda
                        </button>
                    </label>
                    <textarea id="conc-input" class="essay-section-textarea w-full p-4 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 resize-y text-slate-700" placeholder="Conclua sua redação aqui..."></textarea>
                </div>
                
                <div id="correction-loading-area" class="flex flex-col justify-center items-center h-20 hidden">
                    <div class="spinner mb-2"></div>
                    <p class="text-slate-600 font-semibold">Analisando sua redação...</p>
                </div>
                
                <!-- Botão Corrigir Redação (movido para aqui) -->
                <div class="flex justify-center mb-6">
                    <button id="correct-essay-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg transition-colors shadow-lg">
                        Corrigir Redação
                    </button>
                </div>

                <div id="essay-feedback" class="bg-slate-50 p-4 rounded-lg border border-slate-200 min-h-[100px] text-slate-700 prose max-w-none">
                    <p class="text-slate-500 italic">Seu feedback aparecerá aqui.</p>
                </div>

                <!-- Botões de refazer redação e download PDF -->
                <div id="post-correction-actions" class="flex flex-wrap justify-center gap-4 mt-6 hidden">
                    <button id="redo-same-theme-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg">
                        Refazer com o mesmo tema
                    </button>
                    <button id="redo-new-theme-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg">
                        Gerar novo tema e refazer
                    </button>
                    <button id="download-essay-pdf-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg">
                        Download PDF
                    </button>
                </div>
                
                <div id="pdf-loading-area" class="flex flex-col justify-center items-center h-20 hidden">
                    <div class="spinner mb-2"></div>
                    <p class="text-slate-600 font-semibold">Gerando PDF...</p>
                </div>

                <!-- Container para popups de correção em tempo real -->
                <div id="realtime-correction-popups"></div>
            </main>
            <footer class="mt-8 text-center">
                <button id="back-to-home-from-essay-correction" class="back-to-home bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-3 px-6 rounded-lg transition-colors">
                    Voltar para o Início
                </button>
            </footer>
        </div>

    </div>

    <!-- Modais -->
    <div id="study-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="study-title">
        <div class="modal-container bg-white w-full max-w-md rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="study-title" class="text-2xl font-bold text-indigo-700 mb-4">
                <span class="professor-icon">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                        </svg>
                </span> <span id="study-modal-title-text"></span>
            </h3>
            <div id="study-content-wrapper">
                <div id="study-loading-area" class="flex flex-col justify-center items-center h-40 hidden">
                    <div class="spinner mb-2"></div>
                    <p class="text-slate-600 font-semibold">Carregando material de estudo...</p>
                </div>
                <div id="study-text" class="text-slate-600 space-y-3 prose max-w-none hidden"></div>
            </div>
            <button id="close-study-modal" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800 transition-colors" aria-label="Fechar explicação">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>

    <div id="appeal-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="appeal-title">
        <div class="modal-container bg-white w-full max-w-md rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="appeal-title" class="text-2xl font-bold text-orange-700 mb-4">
                <svg class="w-6 h-6 inline-block mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                </svg>
                Recurso da Questão
            </h3>
            <p class="text-slate-600 mb-4">Explique por que você acredita que a resposta está incorreta ou que sua resposta deveria ser considerada correta.</p>
            <textarea id="appeal-text-area" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 mb-4 h-32 resize-y" placeholder="Digite seu recurso aqui..."></textarea>
            <div id="appeal-response-container" class="bg-slate-50 p-3 rounded-lg border border-slate-200 hidden">
                <p class="font-semibold text-slate-700 mb-2">Avaliação do Gramatiquinho:</p>
                <div class="flex justify-center items-center h-16 hidden">
                    <div class="spinner"></div>
                </div>
                <p id="appeal-response-text" class="text-slate-600"></p>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="submit-appeal-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-5 rounded-lg transition-colors shadow-lg">
                    Enviar Recurso
                </button>
                <button id="close-appeal-modal-btn" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-5 rounded-lg transition-colors">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <div id="question-distribution-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="distribution-title">
        <div class="modal-container bg-white w-full max-w-md rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="distribution-title" class="text-2xl font-bold text-indigo-700 mb-4">Distribuir Questões por Tópico</h3>
            <p class="text-slate-600 mb-4">Defina quantas questões você quer de cada tópico selecionado. O total deve ser <span id="expected-total-questions" class="font-bold"></span>.</p>
            
            <div id="question-distribution-container" class="max-h-60 overflow-y-auto pr-2 mb-4 space-y-3"></div>

            <div class="flex justify-between items-center mb-4">
                <button id="randomize-distribution-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-md">
                    Distribuir Aleatoriamente
                </button>
                <p class="text-slate-700 font-semibold">Total Atual: <span id="distribution-total-display" class="font-bold text-sky-700">0</span></p>
            </div>
            <p id="distribution-error-message" class="text-red-500 text-sm mb-4 hidden">A soma das questões não corresponde ao total esperado.</p>

            <div class="flex justify-end gap-3 mt-6">
                <button id="confirm-distribution-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg transition-colors shadow-lg opacity-50 cursor-not-allowed" disabled>
                    Confirmar e Iniciar Simulado
                </button>
                <button id="cancel-distribution-btn" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-5 rounded-lg transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="performance-report-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="report-title">
        <div class="modal-container bg-white w-full max-w-md rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="report-title" class="text-2xl font-bold text-indigo-700 mb-4">Relatório de Desempenho</h3>
            <div id="performance-report-content" class="text-slate-600 space-y-2 max-h-60 overflow-y-auto pr-2 mb-4"></div>
            <div class="flex justify-end mt-4">
                <button id="close-report-modal-btn" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-5 rounded-lg transition-colors">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <div id="num-questions-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="num-questions-title">
        <div class="modal-container bg-white w-full max-w-xs rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="num-questions-title" class="text-2xl font-bold text-blue-700 mb-4">Número de Questões</h3>
            <label for="modal-question-quantity-input" class="block text-slate-700 font-semibold mb-2">Quantidade:</label>
            <input type="number" id="modal-question-quantity-input" value="10" min="1" class="w-full p-2 border border-slate-300 rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
            <div class="flex justify-end gap-3 mt-6">
                <button id="confirm-num-questions" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg transition-colors shadow-lg">
                    Confirmar
                </button>
                <button id="cancel-num-questions" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-5 rounded-lg transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="difficulty-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="difficulty-title">
        <div class="modal-container bg-white w-full max-w-xs rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="difficulty-title" class="text-2xl font-bold text-purple-700 mb-4">Nível</h3>
            <div class="flex flex-col gap-3">
                <input type="radio" id="modal-difficulty-iniciante" name="modalDifficulty" value="iniciante" class="hidden">
                <label for="modal-difficulty-iniciante" class="difficulty-label px-4 py-2 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-200 transition-colors text-slate-700 text-center">Iniciante</label>
                <input type="radio" id="modal-difficulty-intermediario" name="modalDifficulty" value="intermediario" class="hidden">
                <label for="modal-difficulty-intermediario" class="difficulty-label px-4 py-2 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-200 transition-colors text-slate-700 text-center">Intermediário</label>
                <input type="radio" id="modal-difficulty-avancado" name="modalDifficulty" value="avancado" class="hidden">
                <label for="modal-difficulty-avancado" class="difficulty-label px-4 py-2 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-200 transition-colors text-slate-700 text-center">Avançado</label>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="confirm-difficulty" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-5 rounded-lg transition-colors shadow-lg">
                    Confirmar
                </button>
                <button id="cancel-difficulty" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-5 rounded-lg transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="response-mode-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="response-mode-title">
        <div class="modal-container bg-white w-full max-w-xs rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="response-mode-title" class="text-2xl font-bold text-orange-700 mb-4">Tipo de Gabarito</h3>
            <div class="flex flex-col gap-3">
                <input type="radio" id="modal-response-mode-certo-errado" name="modalResponseMode" value="certo-errado" class="hidden">
                <label for="modal-response-mode-certo-errado" class="response-mode-label px-4 py-2 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-200 transition-colors text-slate-700 text-center">Certo ou Errado</label>
                <input type="radio" id="modal-response-mode-multipla-escolha" name="modalResponseMode" value="multipla-escolha" class="hidden">
                <label for="modal-response-mode-multipla-escolha" class="response-mode-label px-4 py-2 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-200 transition-colors text-slate-700 text-center">Múltipla Escolha (5 opções)</label>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="confirm-response-mode" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-5 rounded-lg transition-colors shadow-lg">
                    Confirmar
                </button>
                <button id="cancel-response-mode" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-5 rounded-lg transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="text-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="text-modal-title">
        <div class="modal-container bg-white w-full max-w-2xl rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="text-modal-title" class="text-2xl font-bold text-indigo-700 mb-4">Texto de Apoio</h3>
            <div id="text-modal-content" class="text-modal-content"></div>
            <button id="close-text-modal" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800 transition-colors" aria-label="Fechar texto">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>

    <div id="modal-config-redacao" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="config-redacao-title">
        <div class="modal-container bg-white w-full max-w-md rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="config-redacao-title" class="text-2xl font-bold text-purple-700 mb-4">Configurar Redação</h3>
            <div class="mb-4">
                <label for="select-tipo-redacao" class="block text-slate-700 font-semibold mb-2">Tipo de Redação:</label>
                <select id="select-tipo-redacao" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="dissertacao-expositiva">Redação dissertativa expositiva</option>
                    <option value="dissertacao-argumentativa">Redação dissertativa argumentativa (ENEM)</option>
                    <option value="narrativa">Redação narrativa</option>
                    <option value="descritiva">Redação descritiva</option>
                    <option value="injuntiva">Redação injuntiva (ou instrucional)</option>
                    <option value="expositiva">Redação expositiva</option>
                    <option value="carta-pessoal">Carta pessoal</option>
                    <option value="carta-argumentativa">Carta argumentativa</option>
                    <option value="carta-do-leitor">Carta do leitor</option>
                    <option value="relato-ou-relatorio">Relato ou relatório</option>
                    <option value="cronica">Crônica</option>
                    <option value="artigo-de-opiniao">Artigo de opinião</option>
                    <option value="resumo">Resumo</option>
                    <option value="resenha-critica">Resenha crítica</option>
                    <option value="estudo-de-caso">Estudo de caso</option>
                </select>
            </div>
            <div class="mb-4">
                <label for="input-quantidade-linhas" class="block text-slate-700 font-semibold mb-2">Quantidade de linhas:</label>
                <input type="number" id="input-quantidade-linhas" value="30" min="10" max="60" class="w-full p-3 border border-slate-300 rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="confirm-config-redacao" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-5 rounded-lg transition-colors shadow-lg">
                    Confirmar
                </button>
                <button id="cancel-config-redacao" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-5 rounded-lg transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="modal-gerar-tema" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="gerar-tema-title">
        <div class="modal-container bg-white w-full max-w-md rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="gerar-tema-title" class="text-2xl font-bold text-blue-700 mb-4">Gerar Tema de Redação</h3>
            <div class="flex flex-col gap-4 mb-4">
                <button id="btn-temas-atuais" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg">
                    Temas Atuais
                </button>
                <button id="btn-temas-disciplina" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg">
                    Temas Ligados à Disciplina
                </button>
            </div>
            <div id="disciplina-select-container" class="mb-4 hidden">
                <label for="select-disciplina-tema" class="block text-slate-700 font-semibold mb-2">Selecione a Disciplina:</label>
                <select id="select-disciplina-tema" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500"></select>
            </div>
            <div id="current-theme-input-container" class="mb-4 hidden">
                <label for="current-theme-input" class="block text-slate-700 font-semibold mb-2">Que tipo de tema atual?</label>
                <input type="text" id="current-theme-input" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: Meio ambiente, tecnologia, saúde pública...">
            </div>

            <div id="tema-loading-area" class="flex flex-col justify-center items-center h-20 hidden">
                <div class="spinner mb-2"></div>
                <p class="text-slate-600 font-semibold">Gerando tema...</p>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="confirm-gerar-tema" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg transition-colors shadow-lg opacity-50 cursor-not-allowed" disabled>
                    Gerar Tema
                </button>
                <button id="cancel-gerar-tema" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-5 rounded-lg transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="help-tips-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="help-tips-title">
        <div class="modal-container bg-white w-full max-w-md rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="help-tips-title" class="text-2xl font-bold text-indigo-700 mb-4">Dicas para <span id="help-tips-section-name"></span></h3>
            <div id="help-tips-loading-area" class="flex flex-col justify-center items-center h-20 hidden">
                <div class="spinner mb-2"></div>
                <p class="text-slate-600 font-semibold">Gerando dicas...</p>
            </div>
            <div id="help-tips-content" class="text-slate-600 space-y-3 prose max-w-none min-h-[100px] flex items-center justify-center"></div>
            <div class="flex justify-between items-center mt-6">
                <button id="prev-tip-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Anterior
                </button>
                <span id="tip-counter" class="text-slate-600 text-sm"></span>
                <button id="next-tip-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg flex items-center">
                    Próxima
                    <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div class="flex justify-center mt-4">
                <button id="generate-more-tips-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg transition-colors shadow-lg">
                    Gerar Mais Dicas
                </button>
            </div>
            <button id="close-help-tips-modal" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800 transition-colors" aria-label="Fechar dicas">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>


    <script type="module">
        let currentLevel = null;
        let selectedTopics = [];
        let questionQuantity = 10;
        let difficulty = null;
        let responseMode = null;
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let isSimulado = false;
        let timerInterval = null;
        let timeLeft = 0;
        let friendsHelpCount = 3;
        let performanceReport = {};
        let currentQuestionData = null;
        let essayType = 'dissertacao-argumentativa';
        let essayLineQuantity = 30;
        let generatedEssayTheme = '';
        let essayTitle = '';
        let currentTips = [];
        let currentTipIndex = 0;
        let currentHelpSection = '';

        const homeScreen = document.getElementById('home-screen');
        const topicSelectionScreen = document.getElementById('topic-selection-screen');
        const simuladoSetupScreen = document.getElementById('simulado-setup-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const finalScreen = document.getElementById('final-screen');
        const essayCorrectionScreen = document.getElementById('essay-correction-screen');
        const lawsScreen = document.getElementById('laws-screen');
        const levelSelectButtons = document.querySelectorAll('.level-select-btn');
        const enterAppButton = document.getElementById('enter-app-btn');
        const levelSelectionSection = document.getElementById('level-selection-section');
        const topicContainerQuiz = document.getElementById('topic-container-quiz');
        const topicContainerSimulado = document.getElementById('topic-container-simulado');
        const questionQuantityQuizInput = document.getElementById('question-quantity-quiz');
        const startSelectedQuizButton = document.getElementById('start-selected-quiz');
        const btnNumQuestions = document.getElementById('btn-num-questions');
        const displayNumQuestions = document.getElementById('display-num-questions');
        const btnDifficulty = document.getElementById('btn-difficulty');
        const displayDifficulty = document.getElementById('display-difficulty');
        const btnResponseMode = document.getElementById('btn-response-mode');
        const displayResponseMode = document.getElementById('display-response-mode');
        const startSimuladoButton = document.getElementById('start-simulado');
        const quizTopicTitle = document.getElementById('quiz-topic-title');
        const questionCounter = document.getElementById('question-counter');
        const scoreDisplay = document.getElementById('score');
        const nextQuestionButton = document.getElementById('next-question');
        const backToMenuButton = document.getElementById('back-to-menu');
        const askFriendsButton = document.getElementById('ask-friends-btn');
        const friendsHelpCountSpan = document.getElementById('friends-help-count');
        const appealQuestionButton = document.getElementById('appeal-question-btn');
        const showTextButton = document.getElementById('show-text-button');
        const timerDisplayContainer = document.getElementById('timer-display-container');
        const timerDisplay = document.getElementById('timer-display');
        const finalScoreDisplay = document.getElementById('final-score');
        const finalTopicDisplay = document.getElementById('final-topic');
        const finalTimeDisplay = document.getElementById('final-time');
        const restartQuizButton = document.getElementById('restart-quiz');
        const backToMenuFinalButton = document.getElementById('back-to-menu-final');
        const studyModal = document.getElementById('study-modal');
        const studyModalTitleText = document.getElementById('study-modal-title-text');
        const studyLoadingArea = document.getElementById('study-loading-area');
        const studyText = document.getElementById('study-text');
        const closeStudyModalButton = document.getElementById('close-study-modal');
        const appealModal = document.getElementById('appeal-modal');
        const appealTextArea = document.getElementById('appeal-text-area');
        const appealResponseContainer = document.getElementById('appeal-response-container');
        const appealResponseLoading = appealModal.querySelector('.spinner');
        const appealResponseText = document.getElementById('appeal-response-text');
        const submitAppealButton = document.getElementById('submit-appeal-btn');
        const closeAppealModalButton = document.getElementById('close-appeal-modal-btn');
        const questionDistributionModal = document.getElementById('question-distribution-modal');
        const expectedTotalQuestionsSpan = document.getElementById('expected-total-questions');
        const questionDistributionContainer = document.getElementById('question-distribution-container');
        const randomizeDistributionBtn = document.getElementById('randomize-distribution-btn');
        const distributionTotalDisplay = document.getElementById('distribution-total-display');
        const distributionErrorMessage = document.getElementById('distribution-error-message');
        const confirmDistributionBtn = document.getElementById('confirm-distribution-btn');
        const cancelDistributionBtn = document.getElementById('cancel-distribution-btn');
        const performanceReportModal = document.getElementById('performance-report-modal');
        const performanceReportContent = document.getElementById('performance-report-content');
        const closeReportModalBtn = document.getElementById('close-report-modal-btn');
        const numQuestionsModal = document.getElementById('num-questions-modal');
        const modalQuestionQuantityInput = document.getElementById('modal-question-quantity-input');
        const confirmNumQuestionsBtn = document.getElementById('confirm-num-questions');
        const cancelNumQuestionsBtn = document.getElementById('cancel-num-questions');
        const difficultyModal = document.getElementById('difficulty-modal');
        const modalDifficultyRadios = document.querySelectorAll('input[name="modalDifficulty"]'); 
        const confirmDifficultyBtn = document.getElementById('confirm-difficulty');
        const cancelDifficultyBtn = document.getElementById('cancel-difficulty');
        const responseModeModal = document.getElementById('response-mode-modal');
        const modalResponseModeRadios = document.querySelectorAll('input[name="modalResponseMode"]'); 
        const confirmResponseModeBtn = document.getElementById('confirm-response-mode');
        const cancelResponseModeBtn = document.getElementById('cancel-response-mode');
        const textModal = document.getElementById('text-modal');
        const textModalTitle = document.getElementById('text-modal-title');
        const textModalContent = document.getElementById('text-modal-content');
        const closeTextModalButton = document.getElementById('close-text-modal');
        const essayTitleInput = document.getElementById('essay-title-input');
        const introInput = document.getElementById('intro-input');
        const devInput = document.getElementById('dev-input');
        const concInput = document.getElementById('conc-input');
        const correctEssayBtn = document.getElementById('correct-essay-btn');
        const essayFeedback = document.getElementById('essay-feedback');
        const correctionLoadingArea = document.getElementById('correction-loading-area');
        const realtimeCorrectionPopupsContainer = document.getElementById('realtime-correction-popups');
        const postCorrectionActions = document.getElementById('post-correction-actions');
        const redoSameThemeBtn = document.getElementById('redo-same-theme-btn');
        const redoNewThemeBtn = document.getElementById('redo-new-theme-btn');
        const downloadEssayPdfBtn = document.getElementById('download-essay-pdf-btn');
        const pdfLoadingArea = document.getElementById('pdf-loading-area');
        const modalConfigRedacao = document.getElementById('modal-config-redacao');
        const selectTipoRedacao = document.getElementById('select-tipo-redacao');
        const inputQuantidadeLinhas = document.getElementById('input-quantidade-linhas');
        const confirmConfigRedacaoBtn = document.getElementById('confirm-config-redacao');
        const cancelConfigRedacaoBtn = document.getElementById('cancel-config-redacao');
        const generateThemeBtn = document.getElementById('generate-theme-btn');
        const modalGerarTema = document.getElementById('modal-gerar-tema');
        const btnTemasAtuais = document.getElementById('btn-temas-atuais');
        const btnTemasDisciplina = document.getElementById('btn-temas-disciplina');
        const disciplinaSelectContainer = document.getElementById('disciplina-select-container');
        const selectDisciplinaTema = document.getElementById('select-disciplina-tema');
        const currentThemeInputContainer = document.getElementById('current-theme-input-container');
        const currentThemeInput = document.getElementById('current-theme-input');
        const temaLoadingArea = document.getElementById('tema-loading-area');
        const confirmGerarTemaBtn = document.getElementById('confirm-gerar-tema');
        const cancelGerarTemaBtn = document.getElementById('cancel-gerar-tema');
        const themeDisplay = document.getElementById('theme-display');
        const generatedThemeText = document.getElementById('generated-theme-text');
        const helpTipsModal = document.getElementById('help-tips-modal');
        const helpTipsTitle = document.getElementById('help-tips-title');
        const helpTipsSectionName = document.getElementById('help-tips-section-name');
        const helpTipsLoadingArea = document.getElementById('help-tips-loading-area');
        const helpTipsContent = document.getElementById('help-tips-content');
        const prevTipBtn = document.getElementById('prev-tip-btn');
        const nextTipBtn = document.getElementById('next-tip-btn');
        const tipCounter = document.getElementById('tip-counter');
        const closeHelpTipsModalBtn = document.getElementById('close-help-tips-modal');
        const helpButtons = document.querySelectorAll('.help-button-icon');
        const generateMoreTipsBtn = document.getElementById('generate-more-tips-btn');
        // Define loadingText here
        const loadingText = document.querySelector('#loading-area p');

        // DOM elements for quiz screen, now correctly defined
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const progressBar = document.getElementById('progress-bar');
        
        // New: Search input for topics
        const topicSearchInput = document.getElementById('topic-search-input');


        const grammarData = [
            {
                category: "Língua Portuguesa",
                levels: ["enem"], // Removido "redacao" daqui
                subCategories: [
                    {
                        name: "Fonologia e Ortografia",
                        topics: [
                            { id: 'fonemas', name: 'Fonemas e Letras', description: 'Diferença entre fonemas e letras, dígrafos e encontros consonantais.' },
                            { id: 'encontros-vocalicos', name: 'Encontros Vocálicos (Ditongo, Tritongo, Hiato)', description: 'Conceito e identificação de ditongos, tritongos e hiatos.' },
                            { id: 'divisao-silabica', name: 'Divisão Silábica', description: 'Regras de divisão silábicas, incluindo casos especiais.' },
                            { id: 'acentuacao', name: 'Acentuação Gráfica', description: 'Regras de oxítonas, paroxítonas, proparoxítonas, hiatos e ditongos abertos.' },
                            { id: 'ortografia', name: 'Ortografia', description: 'Uso correto das letras (s/z, g/j, x/ch, etc.) e o novo acordo ortográfico.' },
                            { id: 'hifen', name: 'Uso do Hífen', description: 'Regras de uso do hífen em diferentes contextos e o novo acordo ortográfico.' }
                        ]
                    },
                    {
                        name: "Morfologia",
                        topics: [
                            { id: 'substantivo', name: 'Substantivo', description: 'Classificação, flexão de gênero, número e grau dos substantivos.' },
                            { id: 'adjetivo', name: 'Adjetivo', description: 'Classificação, flexão de gênero, número e grau dos adjetivos.' },
                            { id: 'artigo', name: 'Artigo', description: 'Definidos e indefinidos, seu uso e importância.' },
                            { id: 'numeral', name: 'Numeral', description: 'Classificação e uso dos numerais (cardinais, ordinais, multiplicativos, fracionários).' },
                            { id: 'pronome', name: 'Pronome', description: 'Classificação (pessoal, possessivo, demonstrativo, etc.) e seu uso.' },
                            { id: 'verbo', name: 'Verbo', description: 'Conjugação, tempos e modos verbais, verbos regulares e irregulares.' },
                            { id: 'adverbio', name: 'Advérbio', description: 'Classificação (tempo, lugar, modo, etc.) e locução adverbial.' },
                            { id: 'preposicao', name: 'Preposição', description: 'Conceito, classificação e combinação de preposições.' },
                            { id: 'conjuncao', name: 'Conjunção', description: 'Coordenativas e subordinativas, seu papel na conexão de orações.' },
                            { id: 'interjeicao', name: 'Interjeição', description: 'Expressão de emoções e sentimentos.' },
                            { id: 'estrutura-formacao-palavras', name: 'Estrutura e Formação das Palavras', description: 'Estudo de morfemas (radical, afixos, desinências), processos de formação (derivação prefixal, sufixal, parassintética, regressiva, imprópria) e composição (justaposição, aglutinação).' }
                        ]
                    },
                    {
                        name: "Sintaxe",
                        topics: [
                            { id: 'termos-essenciais', name: 'Termos Essenciais da Oração (Sujeito e Predicado)', description: 'Identificação e classificação de sujeito e predicado.' },
                            { id: 'termos-integrantes', name: 'Termos Integrantes da Oração (Objetos, Complemento Nominal, Agente da Passiva)', description: 'Funções sintáticas de objeto direto, indireto, complemento nominal e agente da passiva.' },
                            { id: 'termos-acessorios', name: 'Termos Acessórios da Oração (Adjunto Adnominal, Adjunto Adverbial, Aposto, Vocativo)', description: 'Funções sintáticas de adjunto adnominal, adjunto adverbial, aposto e vocativo.' },
                            { id: 'concordancia-verbal', name: 'Concordância Verbal', description: 'Regras de concordância do verbo com o sujeito.' },
                            { id: 'concordancia-nominal', name: 'Concordância Nominal', description: 'Regras de concordância entre substantivo, adjetivo, artigo, pronome e numeral.' },
                            { id: 'regencia-verbal', name: 'Regência Verbal', description: 'Relação entre o verbo e seus complementos.' },
                            { id: 'regencia-nominal', name: 'Regência Nominal', description: 'Relação entre o nome (substantivo, adjetivo, advérbio) e seu complemento.' },
                            { id: 'crase', name: 'Crase', description: 'Regras de uso do acento grave indicativo de crase.' },
                            { id: 'colocacao-pronominal', name: 'Colocação Pronominal (Próclise, Mesóclise, Ênclise)', description: 'Regras de posicionamento dos pronomes oblíquos átonos.' },
                            { id: 'vozes-verbais', name: 'Vozes Verbais (Ativa, Passiva, Reflexiva)', description: 'Identificação e transformação das vozes verbais.' },
                            { id: 'periodo-simples-composto', name: 'Período Simples e Período Composto', description: 'Diferença entre orações e períodos, coordenação e subordinação.' },
                            { id: 'oracoes-coordenadas', name: 'Orações Coordenadas', description: 'Classificação e uso das orações coordenadas (sindéticas e assindéticas).' },
                            { id: 'oracoes-subordinadas-substantivas', name: 'Orações Subordinadas Substantivas', description: 'Classificação e função das orações subordinadas substantivas.' },
                            { id: 'oracoes-subordinadas-adjetivas', name: 'Orações Subordinadas Adjetivas', description: 'Classificação e função das orações subordinadas adjetivas.' },
                            { id: 'oracoes-subordinadas-adverbiais', name: 'Orações Subordinadas Adverbiais', description: 'Classificação e função das orações subordinadas adverbiais.' },
                            { id: 'oracoes-reduzidas', name: 'Orações Reduzidas', description: 'Conceito e classificação de orações reduzidas (infinitivo, gerúndio, particípio).' },
                            { id: 'funcoes-que-se', name: 'Funções do "Que" e do "Se"', description: 'Análise sintática e morfológica das palavras "que" e "se".' },
                            { id: 'pontuacao', name: 'Pontuação (Vírgula, Ponto e Vírgula, Dois Pontos, Aspas, Parênteses)', description: 'Regras gerais e específicas de pontuação.' }
                        ]
                    },
                    {
                        name: "Semântica e Estilística",
                        topics: [
                            { id: 'sinonimia-antonimia', name: 'Sinonímia e Antonímia', description: 'Relações de sentido entre as palavras.' },
                            { id: 'homonimia-paronimia', name: 'Homonímia e Paronímia', description: 'Palavras com sons ou grafias semelhantes, mas significados diferentes.' },
                            { id: 'polissemia', name: 'Polissemia', description: 'Múltiplos significados de uma mesma palavra.' },
                            { id: 'conotacao-denotacao', name: 'Conotação e Denotação', description: 'Sentido real e figurado das palavras.' },
                            { id: 'figuras-linguagem', name: 'Figuras de Linguagem', description: 'Metáfora, comparação, personificação, hipérbole, eufemismo, etc.' },
                            { id: 'vicios-linguagem', name: 'Vícios de Linguagem', description: 'Ambiguidade, pleonasmo, cacofonia, barbarismo, etc.' }
                        ]
                    },
                    {
                        name: "Interpretação e Produção Textual",
                        topics: [
                            { id: 'leitura-interpretacao', name: 'Leitura e Interpretação de Textos', description: 'Análise de textos literários e não literários, identificação de informações implícitas e explícitas, intertextualidade.' },
                            { id: 'tipos-generos-textuais', name: 'Tipos e Gêneros Textuais', description: 'Diferença entre narração, descrição, dissertação, injunção e seus gêneros.' },
                            { id: 'coesao-coerencia', name: 'Coesão e Coerência Textual', description: 'Mecanismos para garantir a fluidez e o sentido do texto.' },
                            { id: 'inferencia-deducao', name: 'Inferência e Dedução', description: 'Capacidade de extrair informações implícitas e explícitas do texto.' },
                            { id: 'elementos-narrativos', name: 'Elementos Narrativos (Enredo, Personagens, Narrador, Tempo, Espaço)', description: 'Análise dos componentes de uma narrativa.' },
                            { id: 'argumentacao', name: 'Argumentação', description: 'Identificação de teses, argumentos e estratégias argumentativas.' }
                        ]
                    },
                    {
                        name: "Literatura",
                        topics: [
                            { id: 'trovadorismo', name: 'Trovadorismo e Humanismo', description: 'Contexto histórico, características e principais autores.' },
                            { id: 'classicismo', name: 'Classicismo', description: 'Renascimento, Camões e a epopeia portuguesa.' },
                            { id: 'barroco', name: 'Barroco', description: 'Contexto, características e principais autores (Gregório de Matos, Padre Antônio Vieira).' },
                            { id: 'arcadismo', name: 'Arcadismo', description: 'Contexto, características e principais autores (Tomás Antônio Gonzaga, Cláudio Manuel da Costa).' },
                            { id: 'romantismo', name: 'Romantismo', description: 'Três gerações do Romantismo no Brasil e em Portugal, características e autores.' },
                            { id: 'realismo-naturalismo', name: 'Realismo e Naturalismo', description: 'Contexto, características e principais autores (Machado de Assis, Aluísio Azevedo).' },
                            { id: 'parnasianismo-simbolismo', name: 'Parnasianismo e Simbolismo', description: 'Características e principais autores de cada escola.' },
                            { id: 'pre-modernismo', name: 'Pré-Modernismo', description: 'Transição, características e autores (Euclides da Cunha, Lima Barreto).' },
                            { id: 'modernismo-1fase', name: 'Modernismo - 1ª Fase', description: 'Semana de Arte Moderna, características e autores (Mário de Andrade, Oswald de Andrade).' },
                            { id: 'modernismo-2fase', name: 'Modernismo - 2ª Fase', description: 'Prosa e Poesia, características e autores (Graciliano Ramos, Carlos Drummond de Andrade).' },
                            { id: 'modernismo-3fase', name: 'Modernismo - 3ª Fase (Pós-Modernismo)', description: 'Geração de 45, características e autores (João Cabral de Melo Neto, Clarice Lispector).' },
                            { id: 'literatura-contemporanea', name: 'Literatura Contemporânea', description: 'Tendências atuais na literatura brasileira.' }
                        ]
                    },
                    {
                        name: "Linguística",
                        topics: [
                            { id: 'linguistica-geral', name: 'Linguística Geral', description: 'Conceitos fundamentais da linguística, como língua, fala, signo linguístico.' },
                            { id: 'fonetica-fonologia', name: 'Fonética e Fonologia', description: 'Estudo dos sons da fala e dos sistemas sonoros das línguas.' },
                            { id: 'morfologia-linguistica', name: 'Morfologia Linguística', description: 'Estudo da estrutura das palavras e seus processos de formação.' },
                            { id: 'sintaxe-linguistica', name: 'Sintaxe Linguística', description: 'Estudo da organização das palavras em frases e orações.' },
                            { id: 'semantica-pragmatica', name: 'Semântica e Pragmaticidade', description: 'Estudo do significado e do uso da linguagem em contexto.' },
                            { id: 'sociolinguistica', name: 'Sociolinguística', description: 'Estudo da relação entre língua e sociedade.' },
                            { id: 'psicolinguistica', name: 'Psicolinguística', description: 'Estudo da relação entre linguagem e processos mentais.' },
                            { id: 'historia-linguistica', name: 'História da Linguística', description: 'Principais escolas e teorias da linguística ao longo do tempo.' }
                        ]
                    }
                ]
            },
            {
                category: "Conhecimentos Pedagógicos",
                levels: ["pedagogicos"],
                subCategories: [
                    {
                        name: "Fundamentos e Teorias da Educação",
                        topics: [
                            { id: 'filosofia-educacao', name: 'Filosofia da Educação', description: 'Principais correntes filosóficas e suas implicações na educação.' },
                            { id: 'historia-educacao', name: 'História da Educação', description: 'Principais momentos, influências e movimentos que moldaram a escola.' },
                            { id: 'sociologia-educacao', name: 'Sociologia da Educação', description: 'Relação entre educação e sociedade, desigualdades e movimentos sociais.' },
                            { id: 'psicologia-educacao', name: 'Psicologia da Educação', description: 'Teorias de aprendizagem, desenvolvimento cognitivo e socioemocional.' },
                            { id: 'teorias-pedagogicas', name: 'Teorias Pedagógicas', description: 'Análise das diferentes abordagens e tendências pedagógicas.' }
                        ]
                    },
                    {
                        name: "Didática e Metodologias de Ensino",
                        topics: [
                            { id: 'didatica-metodologias', name: 'Didática e Metodologias de Ensino', description: 'Estratégias e técnicas para o processo de ensino-aprendizagem.' },
                            { id: 'praticas-educativas-aprendizagem', name: 'Práticas Educativas para o Processo de Aprendizagem de Crianças, Adolescentes, Jovens e Adultos', description: 'Estratégias para crianças, adolescentes, jovens e adultos.' },
                            { id: 'metodologias-alfabetizacao', name: 'Metodologias de Alfabetização', description: 'Teorias e técnicas para alfabetizar com base em desenvolvimento cognitivo.' },
                            { id: 'abordagens-ativas', name: 'Abordagens Ativas (PBL, Projetos, Investigação, Experiencial, Design-based)', description: 'Problem-based, projeto, inquiry, experiential learning, design-based.' },
                            { id: 'aprendizagem-colaborativa-cooperativa', name: 'Aprendizagem Colaborativa e Cooperativa', description: 'Aprendizagem em grupo, comunidades de prática.' },
                            { id: 'aprendizagem-contextualizada-transdisciplinar', name: 'Aprendizagem Contextualizada e Transdisciplinar', description: 'Conexão com realidade, temas contemporâneos.' },
                            { id: 'pedagogia-critica-paulo-freire', name: 'Pedagogia Crítica (incluindo Paulo Freire)', description: 'Fundamentos e práticas da pedagogia crítica, com foco em Paulo Freire.' }
                        ]
                    },
                    {
                        name: "Avaliação da Aprendizagem",
                        topics: [
                            { id: 'avaliacao-aprendizagem', name: 'Avaliação da Aprendizagem', description: 'Conceitos, tipos e instrumentos de avaliação no contexto escolar.' },
                            { id: 'avaliacao-formativa-somativa', name: 'Avaliação Formativa e Somativa', description: 'Rubricas, feedback e autorregulação dos alunos.' },
                            { id: 'didatica-avaliacao', name: 'Didática da Avaliação', description: 'Planejamento de provas, instrumentos e avaliação criteriosa.' },
                            { id: 'planejamento-avaliacao-ensino', name: 'Planejamento e Avaliação do Ensino e da Aprendizagem', description: 'Inter-relação entre planejamento, execução e avaliação no processo educativo.' }
                        ]
                    },
                    {
                        name: "Tecnologias Educacionais",
                        topics: [
                            { id: 'tecnologias-educacionais', name: 'Tecnologias da Comunicação e Informação nas Práticas Educativas', description: 'Uso de ferramentas digitais e recursos tecnológicos na educação.' },
                            { id: 'letramento-cientifico', name: 'Letramento Científico', description: 'Desenvolvimento da capacidade de compreender e interpretar informações científicas.' },
                            { id: 'pedagogia-criativa', name: 'Pedagogia Criativa', description: 'Estratégias inovadoras, TRIZ, mescla entre criatividade e aprendizagem.' },
                            { id: 'tpack', name: 'TPACK (Technological–Pedagogical–Content Knowledge)', description: 'Extensão do PCK que envolve o uso integrado de tecnologia.' }
                        ]
                    },
                    {
                        name: "Educação Inclusiva e Diversidade",
                        topics: [
                            { id: 'educacao-inclusiva', name: 'Educação Especial e Inclusiva', description: 'Conceitos, legislação e práticas da educação especial na perspectiva inclusiva.' },
                            { id: 'libras-cultura-surda', name: 'Libras, Cultura e Identidade Surda', description: 'Importância da Língua Brasileira de Sinais e da cultura surda.' },
                            { id: 'direitos-humanos-educacao', name: 'Educação, Inclusão e Direitos Humanos', description: 'Promoção e defesa dos direitos humanos no ambiente escolar e currículo.' },
                            { id: 'diversidade-etnico-raciais', name: 'Educação para as Relações Étnico-Raciais', description: 'Abordagem da diversidade cultural, étnica e racial na escola e currículo.' },
                            { id: 'historias-culturas-africanas-indigenas', name: 'Histórias e Culturas Africanas, Afro-Brasileiras e Indígenas', description: 'Estudo da contribuição dessas culturas para a formação do Brasil.' },
                            { id: 'educacao-genero-sexualidade', name: 'Educação para as Relações de Gênero e Sexualidade', description: 'Discussão sobre gênero, sexualidade e respeito à diversidade.' },
                            { id: 'educacao-socioambiental', name: 'Educação Socioambiental', description: 'Conscientização sobre questões ambientais e sociais.' }
                        ]
                    },
                    {
                        name: "Organização e Gestão da Educação",
                        topics: [
                            { id: 'planejamento-organizacao-gestao-democratica', name: 'Planejamento, Organização e Gestão Democrática Educacional em Espaço Escolar e Não Escolar', description: 'Estruturas e processos de gestão educacional em diferentes níveis e espaços.' },
                            { id: 'implementacao-avaliacao-curriculos-projetos', name: 'Implementação e Avaliação de Currículos, Programas Educacionais e Projetos Político Pedagógicos', description: 'Processos de elaboração, implementação e avaliação de propostas pedagógicas.' },
                            { id: 'praticas-articulacao-escola-comunidade', name: 'Práticas de Articulação entre Escola, Família, Comunidade e Movimentos Sociais', description: 'A importância da interação e parceria para o desenvolvimento educacional.' },
                            { id: 'gestao-sala-aula', name: 'Gestão da Sala de Aula / Classroom Management', description: 'Clima, disciplina, dinâmicas, organização e relações professor-aluno.' },
                            { id: 'gestao-democratica-escola', name: 'Gestão Democrática na Escola', description: 'Princípios e práticas da gestão democrática, participação da comunidade escolar.' },
                            { id: 'relacao-escola-comunidade', name: 'Relação Escola-Comunidade', description: 'A importância da interação e parceria entre a escola e a comunidade local.' }
                        ]
                    },
                    {
                        name: "Políticas e Currículo",
                        topics: [
                            { id: 'politicas-publicas-educacao', name: 'Políticas Públicas, Organização, Financiamento e Avaliação da Educação Brasileira', description: 'Análise das políticas educacionais e seus impactos no sistema de ensino.' },
                            { id: 'teorias-praticas-curriculo', name: 'Teorias e Práticas de Currículo', description: 'Concepções e abordagens curriculares, elaboração e desenvolvimento.' },
                            { id: 'legislacao-educacional', name: 'Legislação Educacional (LDB, ECA, PNE, etc.)', hasQuestions: true, description: 'LDB, ECA, PNE e outros documentos orientadores.' },
                            { id: 'bncc', name: 'BNCC - Base Nacional Comum Curricular', hasQuestions: true, description: 'Estrutura, objetivos e impacto da Base Nacional Comum Curricular.' },
                            { id: 'pcns', name: 'PCNs (Parâmetros Curriculares Nacionais)', description: 'Diretrizes curriculares e temas transversais.' },
                            { id: 'curriculo-temas-transversais', name: 'Currículo e Temas Transversais', description: 'Temas contemporâneos (meio ambiente, diversidade, direitos humanos).' },
                            { id: 'planejamento-institucional-ppp', name: 'Planejamento Institucional e PPP', description: 'Elaboração de projetos político-pedagógicos.' },
                            { id: 'conselhos-escolares', name: 'Conselhos Escolares', description: 'Função, composição e importância dos conselhos escolares na gestão democrática.' }
                        ]
                    },
                    {
                        name: "Desenvolvimento Profissional Docente e Prática",
                        topics: [
                            { id: 'identidade-trabalho-docente', name: 'Identidade e Especificidades do Trabalho Docente', description: 'Desafios e características da profissão docente.' },
                            { id: 'estagio-supervisionado', name: 'Estágio Supervisionado', description: 'Importância e etapas do estágio na formação docente.' },
                            { id: 'pratica-reflexiva-metacognicao', name: 'Prática Reflexiva e Metacognição', description: 'Reflexão-in-action (Schön), aprimoramento baseado na experiência.' },
                            { id: 'formacao-continuada-comunidades-pratica', name: 'Formação Continuada e Comunidades de Prática', description: 'Workshops, grupos de estudo, redes colaborativas.' },
                            { id: 'crencas-professor-decisao-pedagogica', name: 'Influência das Crenças do Professor sobre Decisão Pedagógica', description: 'Impacto das crenças do professor na prática em sala de aula.' }
                        ]
                    },
                    {
                        name: "Pesquisa em Educação",
                        topics: [
                            { id: 'metodologia-pesquisa-educacao', name: 'Metodologia de Pesquisa em Educação e Ensino', description: 'Fundamentos e tipos de pesquisa em educação, coleta e análise de dados.' }
                        ]
                    }
                ]
            },
            {
                category: "Redação",
                levels: ["redacao", "redacao-correcao"], // Mantido "redacao" aqui para Redação - Conteúdo
                subCategories: [
                    {
                        name: "Fundamentos da Redação",
                        topics: [
                            { id: 'tipos-redacao', name: 'Tipos de Redação (Dissertação, Narração, Descrição)', description: 'Características e estrutura de cada tipo textual.' },
                            { id: 'estrutura-dissertacao', name: 'Estrutura da Dissertação-Argumentativa', description: 'Introdução, desenvolvimento e conclusão para textos dissertativos.' },
                            { id: 'tese-argumentacao', name: 'Tese e Argumentação', description: 'Como formular uma tese e construir argumentos sólidos.' },
                            { id: 'coerencia-coesao', name: 'Coerência e Coesão Textual', description: 'Mecanismos para garantir a fluidez e o sentido do texto.' },
                            { id: 'norma-culta', name: 'Uso da Norma Culta', description: 'Adequação da linguagem formal em textos dissertativos.' },
                            { id: 'pontuacao-redacao', name: 'Pontuação na Redação', description: 'Regras de pontuação aplicadas à escrita formal.' },
                            { id: 'conectivos-articuladores', name: 'Conectivos e Articuladores Textuais', description: 'Uso de conjunções e advérbios para ligar ideias.' },
                            { id: 'interpretacao-propostas', name: 'Interpretação de Propostas de Redação', description: 'Análise de temas e textos motivadores.' },
                            { id: 'repertorio-sociocultural', name: 'Repertório Sociocultural', description: 'Como usar conhecimentos de diversas áreas para enriquecer a argumentação.' },
                            { id: 'citacoes-alusoes', name: 'Uso de Citações e Alusões', description: 'Como inserir citações e referências de forma adequada.' },
                            { id: 'mecanismos-intervencao', name: 'Mecanismos de Intervenção (ENEM)', description: 'Propostas de solução para problemas sociais, com foco no ENEM.' },
                            { id: 'vicios-linguagem-redacao', name: 'Vícios de Linguagem na Redação', description: 'Identificação e correção de vícios como pleonasmo, ambiguidade, etc.' },
                            { id: 'generos-textuais-redacao', name: 'Gêneros Textuais (Artigo de Opinião, Carta Aberta, Resenha)', description: 'Análise e produção de diferentes gêneros textuais.' },
                            { id: 'argumentos-tipos', name: 'Tipos de Argumentos (Autoridade, Exemplificação, Comparação)', description: 'Estratégias argumentativas para defender um ponto de vista.' },
                            { id: 'paragrafo', name: 'O Parágrafo (estrutura e função)', description: 'Organização das ideias em parágrafos coerentes.' },
                            { id: 'ortografia-gramatica-aplicada', name: 'Ortografia e Gramática Aplicada à Redação', description: 'Revisão de regras gramaticais essenciais para a escrita.' },
                            { id: 'estudo-de-caso', name: 'Estudo de Caso', description: 'Análise e resolução de problemas práticos em formato de texto.' }
                        ]
                    }
                ]
            },
            {
                category: "Direito",
                levels: ["bonus"],
                subCategories: [
                    {
                        name: "Direito Constitucional",
                        topics: [
                            { id: 'const-fundamentos', name: 'Teoria da Constituição e Poder Constituinte', description: 'Conceitos, classificação e evolução das Constituições.' },
                            { id: 'const-direitos-fundamentais', name: 'Direitos e Deveres Fundamentais (Art. 5º CF)', description: 'Direitos individuais, sociais, políticos e sua aplicabilidade.' },
                            { id: 'const-organizacao-estado', name: 'Organização do Estado (União, Estados, Municípios, DF)', description: 'Repartição de competências e forma de Estado.' },
                            { id: 'const-poderes', name: 'Organização dos Poderes (Legislativo, Executivo, Judiciário)', description: 'Estrutura, funções e controle dos Poderes.' },
                            { id: 'const-controle-constitucionalidade', name: 'Controle de Constitucionalidade', description: 'Ações (ADIN, ADPF, ADPF, MS) e sistemas de controle.' },
                            { id: 'const-administracao-publica', name: 'Administração Pública na CF', description: 'Princípios, servidores públicos e responsabilidade civil do Estado.' }
                        ]
                    },
                    {
                        name: "Direito Administrativo",
                        topics: [
                            { id: 'adm-principios', name: 'Princípios do Direito Administrativo', description: 'Legalidade, impessoalidade, moralidade, publicidade, eficiência.' },
                            { id: 'adm-organizacao', name: 'Organização da Administração Pública', description: 'Administração direta e indireta, entidades e agentes.' },
                            { id: 'adm-atos', name: 'Atos Administrativos', description: 'Conceito, requisitos, atributos, espécies e invalidação.' },
                            { id: 'adm-poderes', name: 'Poderes Administrativos', description: 'Hierárquico, disciplinar, regulamentar, de polícia.' },
                            { id: 'adm-licitacoes', name: 'Licitações e Contratos Administrativos (Lei 14.133/21)', description: 'Modalidades, dispensa, inexigibilidade, execução.' },
                            { id: 'adm-servicos-publicos', name: 'Serviços Públicos', description: 'Conceito, princípios, formas de prestação e concessões.' },
                            { id: 'adm-bens-publicos', name: 'Bens Públicos', description: 'Classificação, regime jurídico e formas de aquisição e alienação.' },
                            { id: 'adm-intervencao-estado', name: 'Intervenção do Estado na Propriedade Privada', description: 'Desapropriação, servidão, requisição, tombamento.' },
                            { id: 'adm-responsabilidade-civil', name: 'Responsabilidade Civil do Estado', description: 'Teorias, requisitos e excludentes.' },
                            { id: 'adm-processo-administrativo', name: 'Processo Administrativo (Lei 9.784/99)', description: 'Princípios, fases e recursos.' }
                        ]
                    },
                    {
                        name: "Direito Civil",
                        topics: [
                            { id: 'civil-lei-introducao', name: 'Lei de Introdução às Normas do Direito Brasileiro (LINDB)', description: 'Vigência, aplicação, interpretação e integração das normas.' },
                            { id: 'civil-pessoas', name: 'Pessoas Naturais e Jurídicas', description: 'Capacidade, personalidade, domicílio, bens, fatos jurídicos.' },
                            { id: 'civil-bens', name: 'Bens', description: 'Classificação dos bens e sua importância jurídica.' },
                            { id: 'civil-fatos-atos-negocios', name: 'Fatos, Atos e Negócios Jurídicos', description: 'Requisitos de validade, defeitos, nulidade e anulabilidade.' },
                            { id: 'civil-prescricao-decadencia', name: 'Prescrição e Decadência', description: 'Conceitos, prazos e causas de interrupção e suspensão.' },
                            { id: 'civil-obrigacoes', name: 'Direito das Obrigações', description: 'Modalidades, transmissão, adimplemento, inadimplemento.' },
                            { id: 'civil-contratos', name: 'Direito dos Contratos', description: 'Princípios, classificação, formação, vícios redibitórios, evicção.' },
                            { id: 'civil-responsabilidade-civil', name: 'Responsabilidade Civil', description: 'Contratual e extracontratual, objetiva e subjetiva, dano moral e material.' },
                            { id: 'civil-familia', name: 'Direito de Família', description: 'Casamento, união estável, divórcio, alimentos, guarda.' },
                            { id: 'civil-sucessoes', name: 'Direito das Sucessões', description: 'Sucessão legítima e testamentária, inventário e partilha.' },
                            { id: 'civil-reais', name: 'Direitos Reais', description: 'Propriedade, posse, usufruto, servidão.' }
                        ]
                    },
                    {
                        name: "Direito Penal",
                        topics: [
                            { id: 'penal-principios', name: 'Princípios do Direito Penal', description: 'Legalidade, anterioridade, culpabilidade, humanidade.' },
                            { id: 'penal-teoria-crime', name: 'Teoria Geral do Crime', description: 'Fato típico, antijuridicidade, culpabilidade, punibilidade.' },
                            { id: 'penal-imputabilidade', name: 'Imputabilidade Penal', description: 'Causas de exclusão e semi-imputabilidade.' },
                            { id: 'penal-concurso-crimes', name: 'Concurso de Pessoas e Concurso de Crimes', description: 'Autoria, participação, concurso material, formal, crime continuado.' },
                            { id: 'penal-penas', name: 'Teoria da Pena', description: 'Espécies de penas, aplicação, suspensão, livramento condicional.' },
                            { id: 'penal-extincao-punibilidade', name: 'Extinção da Punibilidade', description: 'Prescrição, decadência, perempção, morte do agente.' },
                            { id: 'penal-crimes-contra-pessoa', name: 'Crimes Contra a Pessoa', description: 'Homicídio, lesão corporal, calúnia, difamação, injúria.' },
                            { id: 'penal-crimes-contra-patrimonio', name: 'Crimes Contra o Patrimônio', description: 'Furto, roubo, extorsão, estelionato.' },
                            { id: 'penal-crimes-administracao-publica', name: 'Crimes Contra a Administração Pública', description: 'Peculato, concussão, corrupção, prevaricação.' }
                        ]
                    },
                    {
                        name: "Direito Processual Penal",
                        topics: [
                            { id: 'proc-penal-principios', name: 'Princípios do Processo Penal', description: 'Devido processo legal, contraditório, ampla defesa, presunção de inocência.' },
                            { id: 'proc-penal-inquerito', name: 'Inquérito Policial', description: 'Natureza, características, valor probatório.' },
                            { id: 'proc-penal-acao-penal', name: 'Ação Penal', description: 'Pública e privada, condições da ação, denúncia, queixa.' },
                            { id: 'proc-penal-provas', name: 'Provas no Processo Penal', description: 'Principios, meios de prova, prova ilícita.' },
                            { id: 'proc-penal-prisoes', name: 'Prisões e Liberdade Provisória', description: 'Flagrante, preventiva, temporária, fiança.' },
                            { id: 'proc-penal-recursos', name: 'Recursos no Processo Penal', description: 'Apelação, RESE, embargos, habeas corpus.' },
                            { id: 'proc-penal-jurisdicao-competencia', name: 'Jurisdição e Competência', description: 'Conceito, critérios de fixação, modificação.' }
                        ]
                    },
                    {
                        name: "Direito Processual Civil",
                        topics: [
                            { id: 'proc-civil-principios', name: 'Princípios do Processo Civil', description: 'Devido processo legal, contraditório, cooperação, boa-fé.' },
                            { id: 'proc-civil-jurisdicao-competencia', name: 'Jurisdição e Competência', description: 'Conceito, critérios de fixação, modificação.' },
                            { id: 'proc-civil-partes-procuradores', name: 'Partes e Procuradores', description: 'Capacidade, representação, substituição processual.' },
                            { id: 'proc-civil-atos-processuais', name: 'Atos Processuais', description: 'Forma, tempo, lugar, prazos, comunicação.' },
                            { id: 'proc-civil-peticao-inicial', name: 'Petição Inicial e Resposta do Réu', description: 'Requisitos, emenda, contestação, reconvenção.' },
                            { id: 'proc-civil-provas', name: 'Provas no Processo Civil', description: 'Ônus da prova, meios de prova, produção.' },
                            { id: 'proc-civil-sentenca-coisa-julgada', name: 'Sentença e Coisa Julgada', description: 'Requisitos, efeitos, limites objetivos e subjetivos.' },
                            { id: 'proc-civil-recursos', name: 'Recursos no Processo Civil', description: 'Conceito, princípios, espécies (apelação, agravo, RE, REsp).' },
                            { id: 'proc-civil-execucao', name: 'Processo de Execução', description: 'Título executivo, espécies de execução, embargos à execução.' }
                        ]
                    },
                    {
                        name: "Direito do Trabalho",
                        topics: [
                            { id: 'trab-principios', name: 'Princípios do Direito do Trabalho', description: 'Proteção, irrenunciabilidade, continuidade da relação de emprego.' },
                            { id: 'trab-fontes', name: 'Fontes do Direito do Trabalho', description: 'CLT, Constituição, convenções e acordos coletivos.' },
                            { id: 'trab-contrato-trabalho', name: 'Contrato Individual de Trabalho', description: 'Conceito, requisitos, espécies, alteração, suspensão, interrupção.' },
                            { id: 'trab-salario-remuneracao', name: 'Salário e Remuneração', description: 'Conceito, distinção, adicionais, equiparação salarial.' },
                            { id: 'trab-jornada-trabalho', name: 'Jornada de Trabalho', description: 'Duração, horas extras, intervalos, trabalho noturno.' },
                            { id: 'trab-extincao-contrato', name: 'Extinção do Contrato de Trabalho', description: 'Justa causa, sem justa causa, rescisão indireta, FGTS, seguro-desemprego.' },
                            { id: 'trab-direito-coletivo', name: 'Direito Coletivo do Trabalho', description: 'Organização sindical, negociação coletiva, greve.' },
                            { id: 'trab-processo-trabalho', name: 'Processo do Trabalho', description: 'Competência, rito, recursos, execução trabalhista.' }
                        ]
                    },
                    {
                        name: "Direito Previdenciário",
                        topics: [
                            { id: 'prev-principios', name: 'Princípios do Direito Previdenciário', description: 'Solidariedade, universalidade, seletividade, distributividade.' },
                            { id: 'prev-seguridade-social', name: 'Seguridade Social', description: 'Conceito, organização, financiamento, saúde, assistência, previdência.' },
                            { id: 'prev-beneficios', name: 'Benefícios Previdenciários', description: 'Aposentadorias, pensão por morte, auxílios, salário-maternidade.' },
                            { id: 'prev-segurados', name: 'Segurados Obrigatórios e Facultativos', description: 'Categorias de segurados e suas contribuições.' },
                            { id: 'prev-carencia', name: 'Período de Carência', description: 'Requisitos para concessão de benefícios.' },
                            { id: 'prev-salario-contribuicao', name: 'Salário de Contribuição', description: 'Base de cálculo, limites e reajustes.' },
                            { id: 'prev-recursos-administrativos', name: 'Recursos Administrativos Previdenciários', description: 'Processo administrativo no INSS.' }
                        ]
                    },
                    {
                        name: "Direito Tributário",
                        topics: [
                            { id: 'trib-principios', name: 'Princípios do Direito Tributário', description: 'Legalidade, irretroatividade, anterioridade, capacidade contributiva.' },
                            { id: 'trib-tributos', name: 'Sistema Tributário Nacional', description: 'Impostos, taxas, contribuições de melhoria, empréstimos compulsórios.' },
                            { id: 'trib-competencia', name: 'Competência Tributária', description: 'União, Estados, Municípios, DF e suas atribuições.' },
                            { id: 'trib-obrigacao-credito', name: 'Obrigação Tributária e Crédito Tributário', description: 'Fato gerador, sujeito ativo e passivo, lançamento, suspensão, extinção, exclusão.' },
                            { id: 'trib-impostos-especie', name: 'Impostos em Espécie', description: 'IR, IPI, ICMS, ISS, IPTU, IPVA, ITBI, ITCMD.' },
                            { id: 'trib-execucao-fiscal', name: 'Execução Fiscal', description: 'Processo de cobrança judicial de créditos tributários.' }
                        ]
                    },
                    {
                        name: "Direito Empresarial (ou Comercial)",
                        topics: [
                            { id: 'emp-empresa-empresario', name: 'Empresa e Empresário', description: 'Conceito, caracterização, registro, empresário individual.' },
                            { id: 'emp-sociedades', name: 'Direito Societário', description: 'Tipos de sociedades, constituição, dissolução, responsabilidade dos sócios.' },
                            { id: 'emp-titulos-credito', name: 'Títulos de Crédito', description: 'Cheque, nota promissória, duplicata, letra de câmbio.' },
                            { id: 'emp-falencia-recuperacao', name: 'Falência e Recuperação de Empresas', description: 'Pressupostos, fases, efeitos, plano de recuperação.' },
                            { id: 'emp-contratos-mercantis', name: 'Contratos Mercantis', description: 'Compra e venda mercantil, factoring, franquia, leasing.' },
                            { id: 'emp-propriedade-industrial', name: 'Propriedade Industrial', description: 'Patentes, marcas, desenhos industriais, indicações geográficas.' }
                        ]
                    },
                    {
                        name: "Direito Ambiental",
                        topics: [
                            { id: 'amb-principios', name: 'Princípios do Direito Ambiental', description: 'Prevenção, precaução, poluidor-pagador, desenvolvimento sustentável.' },
                            { id: 'amb-sisnama', name: 'Política Nacional do Meio Ambiente (PNMA) e SISNAMA', description: 'Objetivos, instrumentos, órgãos.' },
                            { id: 'amb-licenciamento', name: 'Licenciamento Ambiental', description: 'Conceito, fases, EIA/RIMA.' },
                            { id: 'amb-responsabilidade', name: 'Responsabilidade Ambiental', description: 'Civil, penal e administrativa, solidariedade, objetividade.' },
                            { id: 'amb-unidades-conservacao', name: 'Unidades de Conservação', description: 'Classificação, categorias, criação, gestão.' },
                            { id: 'amb-recursos-hidricos', name: 'Recursos Hídricos', description: 'Política Nacional de Recursos Hídricos, uso, outorga.' },
                            { id: 'amb-florestal', name: 'Legislação Florestal (Código Florestal)', description: 'Áreas de Preservação Permanente (APP), Reserva Legal (RL).' }
                        ]
                    },
                    {
                        name: "Direito Internacional Público",
                        topics: [
                            { id: 'int-pub-fontes', name: 'Fontes do Direito Internacional Público', description: 'Tratados, costume, princípios gerais, jurisprudência.' },
                            { id: 'int-pub-sujeitos', name: 'Sujeitos de Direito Internacional Público', description: 'Estados, organizações internacionais, indivíduos.' },
                            { id: 'int-pub-tratados', name: 'Tratados Internacionais', description: 'Conceito, classificação, formação, efeitos, extinção.' },
                            { id: 'int-pub-solucao-controversias', name: 'Solução Pacífica de Controvérsias', description: 'Negociação, mediação, arbitragem, Corte Internacional de Justiça.' },
                            { id: 'int-pub-dir-humanos', name: 'Direito Internacional dos Direitos Humanos', description: 'Sistemas de proteção, tratados, cortes (CIDH).' },
                            { id: 'int-pub-dir-conflitos-armados', name: 'Direito Internacional dos Conflitos Armados (Direito Humanitário)', description: 'Regras de conduta em guerra, proteção de vítimas.' }
                        ]
                    },
                    {
                        name: "Direito Internacional Privado",
                        topics: [
                            { id: 'int-priv-principios', name: 'Princípios do Direito Internacional Privado', description: 'Autonomia da vontade, lex fori, locus regit actum.' },
                            { id: 'int-priv-fontes', name: 'Fontes do Direito Internacional Privado', description: 'Lei de Introdução às Normas do Direito Brasileiro (LINDB), tratados.' },
                            { id: 'int-priv-competencia-internacional', name: 'Competência Internacional', description: 'Jurisdição brasileira, litispendência, conexão.' },
                            { id: 'int-priv-lei-aplicavel', name: 'Lei Aplicável', description: 'Conflito de leis, qualificação, reenvio.' },
                            { id: 'int-priv-condicao-juridica-estrangeiro', name: 'Condição Jurídica do Estrangeiro no Brasil', description: 'Direitos, deveres, naturalização, extradição.' },
                            { id: 'int-priv-homologacao-sentenca', name: 'Homologação de Sentença Estrangeira', description: 'Requisitos, procedimento, efeitos.' }
                        ]
                    },
                    {
                        name: "Direito Eleitoral",
                        topics: [
                            { id: 'eleit-principios', name: 'Princípios do Direito Eleitoral', description: 'Soberania popular, voto direto, secreto, universal e periódico.' },
                            { id: 'eleit-justica-eleitoral', name: 'Organização da Justiça Eleitoral', description: 'TSE, TREs, Juízes Eleitorais, Juntas Eleitorais.' },
                            { id: 'eleit-alistamento-eleitoral', name: 'Alistamento Eleitoral e Domicílio Eleitoral', description: 'Capacidade eleitoral ativa e passiva.' },
                            { id: 'eleit-elegibilidade-inelegibilidade', name: 'Elegibilidade e Inelegibilidade', description: 'Condições e causas de inelegibilidade.' },
                            { id: 'eleit-partidos-politicos', name: 'Partidos Políticos', description: 'Criação, registro, funcionamento, fidelidade partidária.' },
                            { id: 'eleit-propaganda-eleitoral', name: 'Propaganda Eleitoral', description: 'Regras, limites, ilícitos eleitorais.' },
                            { id: 'eleit-financiamento-campanhas', name: 'Financiamento de Campanhas Eleitorais', description: 'Fontes, limites, prestação de contas.' },
                            { id: 'eleit-crimes-eleitorais', name: 'Crimes Eleitorais', description: 'Principais tipos e sanções.' },
                            { id: 'eleit-acao-impugnacao', name: 'Ações Eleitorais (AIME, AIJE, RCED, Representação)', description: 'Finalidade e procedimento de cada ação.' }
                        ]
                    },
                    {
                        name: "Direito Digital",
                        topics: [
                            { id: 'dig-principios', name: 'Princípios do Direito Digital', description: 'Privacidade, segurança, neutralidade de rede, proteção de dados.' },
                            { id: 'dig-marco-civil', name: 'Marco Civil da Internet (Lei 12.965/14)', description: 'Direitos e deveres na internet, provedores.' },
                            { id: 'dig-lgpd', name: 'Lei Geral de Proteção de Dados (LGPD - Lei 13.709/18)', description: 'Tratamento de dados pessoais, direitos dos titulares, ANPD.' },
                            { id: 'dig-crimes-ciberneticos', name: 'Crimes Cibernéticos', description: 'Invasão de dispositivo, interrupção de serviço, falsidade ideológica.' },
                            { id: 'dig-contratos-eletronicos', name: 'Contratos Eletrônicos', description: 'Validade, assinatura digital, prova.' },
                            { id: 'dig-comercio-eletronico', name: 'Comércio Eletrônico', description: 'Direitos do consumidor, segurança nas transações.' },
                            { id: 'dig-propriedade-intelectual', name: 'Propriedade Intelectual no Ambiente Digital', description: 'Direitos autorais, softwares, pirataria.' }
                        ]
                    },
                    {
                        name: "Direitos Humanos",
                        topics: [
                            { id: 'dh-conceito-geracoes', name: 'Conceito e Gerações de Direitos Humanos', description: 'Evolução histórica, características e dimensões.' },
                            { id: 'dh-declaracao-universal', name: 'Declaração Universal dos Direitos Humanos (DUDH)', description: 'Conteúdo e importância.' },
                            { id: 'dh-tratados-internacionais', name: 'Tratados Internacionais de Direitos Humanos', description: 'Pacta de direitos civis e políticos, direitos econômicos, sociais e culturais.' },
                            { id: 'dh-sistemas-protecao', name: 'Sistemas de Proteção dos Direitos Humanos', description: 'Sistema global (ONU) e sistemas regionais (OEA, UE).' },
                            { id: 'dh-direitos-humanos-brasil', name: 'Direitos Humanos na Constituição Federal', description: 'Art. 5º e sua aplicabilidade.' },
                            { id: 'dh-violacao-responsabilidade', name: 'Violação de Direitos Humanos e Responsabilidade', description: 'Crimes contra a humanidade, genocídio, tortura.' }
                        ]
                    }
                ]
            },
            {
                category: "Noções de Informática",
                levels: ["informatica"],
                subCategories: [
                    {
                        name: "Conteúdo Completo para Concursos",
                        topics: [
                            { id: 'conceitos-basicos-informatica', name: 'Conceitos Básicos de Informática', description: 'Fundamentos essenciais da computação, hardware, software, e sistemas de informação, relevantes para questões de concursos FCC, FGV e Cebraspe.' },
                            { id: 'hardware', name: 'Hardware', description: 'Componentes físicos do computador (CPU, memória, armazenamento, periféricos), suas funções e características, frequentemente abordados em provas de informática.' },
                            { id: 'software', name: 'Software', description: 'Tipos de software (sistema, aplicativo, utilitário), suas funcionalidades e licenciamento, com foco na aplicabilidade em cenários de concurso.' },
                            { id: 'sistemas-operacionais', name: 'Sistemas Operacionais (Windows, Linux)', description: 'Princípios e funcionalidades de sistemas operacionais, com ênfase em Windows e Linux, conforme exigido por bancas como Cebraspe.' },
                            { id: 'windows-10', name: 'Windows 10', description: 'Recursos, interface, gerenciamento de arquivos e configurações do Windows 10, tópico comum em questões de informática para concursos.' },
                            { id: 'windows-11', name: 'Windows 11', description: 'Novas funcionalidades, interface e compatibilidade do Windows 11, considerando sua crescente relevância em editais.' },
                            { id: 'organizacao-gerenciamento-arquivos', name: 'Conceitos de Organização e de Gerenciamento de Arquivos', description: 'Estrutura de pastas, cópia, movimentação, exclusão e busca de arquivos, fundamental para provas práticas e teóricas.' },
                            { id: 'tipos-arquivos-extensoes', name: 'Tipos de Arquivos e Extensões', description: 'Identificação e funcionalidade de diferentes formatos de arquivo e suas extensões, frequentemente cobrado em questões objetivas.' },
                            { id: 'atalhos-teclado', name: 'Atalhos de Teclado', description: 'Principais atalhos de teclado para sistemas operacionais e aplicativos, visando otimização e agilidade, ponto comum em bancas como FCC.' },
                            { id: 'microsoft-office', name: 'Pacote Microsoft Office (Word, Excel, PowerPoint, Outlook)', description: 'Uso avançado e recursos específicos dos aplicativos Word, Excel, PowerPoint e Outlook, com questões focadas em funcionalidades e atalhos.' },
                            { id: 'libreoffice', name: 'LibreOffice (Writer, Calc, Impress)', description: 'Funcionalidades equivalentes do LibreOffice (Writer, Calc, Impress), importante para concursos que abrangem software livre.' },
                            { id: 'internet-navegadores', name: 'Internet: Conceitos e Navegadores (Chrome, Firefox, Edge)', description: 'Fundamentos da internet, protocolos, e recursos de navegadores web, incluindo Chrome, Firefox e Edge, para questões de navegação e segurança.' },
                            { id: 'ferramentas-busca', name: 'Ferramentas e Aplicativos de Navegação e Busca (Google, Bing)', description: 'Uso eficiente de motores de busca e ferramentas de pesquisa, com foco em estratégias de busca e avaliação de resultados.' },
                            { id: 'correio-eletronico', name: 'Correio Eletrônico (e-mail): Uso, Segurança e Etiqueta', description: 'Funcionamento do e-mail, clientes de e-mail, segurança (spam, phishing) e boas práticas de comunicação, tema recorrente em provas.' },
                            { id: 'armazenamento-nuvem', name: 'Armazenamento em Nuvem (Google Drive, OneDrive, Dropbox)', description: 'Conceitos de cloud storage, sincronização, compartilhamento e segurança em plataformas como Google Drive, OneDrive e Dropbox.' },
                            { id: 'redes-computadores', name: 'Redes de Computadores: Conceitos Básicos', description: 'Fundamentos de redes (cliente-servidor, peer-to-peer), topologias e componentes, essenciais para entender a conectividade.' },
                            { id: 'tipos-redes', name: 'Tipos de Redes (LAN, WAN, MAN, PAN)', description: 'Classificação de redes por abrangência geográfica e suas características, com questões sobre cenários de aplicação.' },
                            { id: 'topologias-redes', name: 'Topologias de Redes (barramento, estrela, anel, malha, híbrida)', description: 'Estruturas físicas e lógicas de redes, suas vantagens e desvantagens, frequentemente cobradas em questões de redes.' },
                            { id: 'equipamentos-rede', name: 'Equipamentos de Rede (switch, roteador, hub, modem, access point)', description: 'Função e aplicação de dispositivos de rede, como switches, roteadores e modems, em diferentes arquiteturas.' },
                            { id: 'enderecamento-ip', name: 'Endereçamento IP (IPv4 e IPv6)', description: 'Estrutura e funcionamento dos endereços IP (IPv4 e IPv6), classes de IP, e a transição entre as versões.' },
                            { id: 'mascara-sub-rede', name: 'Máscara de Sub-rede', description: 'Cálculo e aplicação de máscaras de sub-rede para divisão de redes, um tópico mais técnico, mas presente em provas avançadas.' },
                            { id: 'dhcp-dns-nat', name: 'DHCP, DNS e NAT', description: 'Protocolos e serviços de rede (DHCP para atribuição de IP, DNS para resolução de nomes, NAT para tradução de endereços), suas funções e importância.' },
                            { id: 'protocolos-comunicacao', name: 'Protocolos de Comunicação (TCP/IP, HTTP, HTTPS, FTP, SMTP, POP3, IMAP)', description: 'Principais protocolos de rede e suas aplicações (navegação, transferência de arquivos, e-mail), com foco em segurança (HTTPS).' },
                            { id: 'intranet-extranet', name: 'Intranet e Extranet', description: 'Diferenças e aplicações de redes corporativas internas (Intranet) e externas (Extranet), e seus usos em organizações.' },
                            { id: 'compartilhamento-arquivos-impressoras', name: 'Compartilhamento de Arquivos e Impressoras em Rede', description: 'Configuração e segurança para compartilhamento de recursos em ambientes de rede, com questões sobre permissões e acesso.' },
                            { id: 'seguranca-redes', name: 'Segurança em Redes (firewall, criptografia, VPN)', description: 'Conceitos e ferramentas de segurança de rede (firewall, VPN, criptografia), essenciais para proteger dados e sistemas.' },
                            { id: 'wi-fi', name: 'Wi-Fi: Configurações, Segurança e Padrões (802.11a/b/g/n/ac/ax)', description: 'Tecnologias de rede sem fio, padrões Wi-Fi, configurações de segurança (WPA2, WPA3) e otimização de conexão.' },
                            { id: 'cabeamento-estruturado', name: 'Cabeamento Estruturado', description: 'Padrões e componentes de infraestrutura de cabeamento para redes, incluindo tipos de cabos e conectores.' },
                            { id: 'testes-conectividade', name: 'Testes de Conectividade (ping, tracert, ipconfig, nslookup)', description: 'Comandos e ferramentas para diagnóstico de rede, como ping, tracert, ipconfig e nslookup, para identificar problemas de conexão.' },
                            { id: 'internet-coisas', name: 'Conceitos de Internet das Coisas (IoT)', description: 'Fundamentos da IoT, dispositivos conectados, aplicações e desafios de segurança e privacidade.' },
                            { id: 'computacao-nuvem', name: 'Computação em Nuvem (Cloud Computing)', description: 'Modelos de serviço (IaaS, PaaS, SaaS), implantação (pública, privada, híbrida) e vantagens da computação em nuvem.' },
                            { id: 'navegacao-segura', name: 'Navegação Segura, Certificados Digitais e Criptografia', description: 'Práticas de segurança online, uso de certificados digitais para autenticação e criptografia para proteção de dados.' },
                            { id: 'backup-recuperacao', name: 'Backup e Recuperação de Dados em Rede', description: 'Estratégias de backup (completo, incremental, diferencial), armazenamento e planos de recuperação de desastres em ambientes de rede.' },
                            { id: 'boas-praticas-seguranca', name: 'Boas Práticas de Segurança Digital', description: 'Medidas preventivas e comportamentos seguros para proteger informações e sistemas contra ameaças cibernéticas.' },
                            { id: 'videoconferencia', name: 'Aplicativos de Videoconferência (Zoom, Teams, Meet)', description: 'Funcionalidades e uso de plataformas de videoconferência, com foco em recursos de colaboração e segurança.' },
                            { id: 'dispositivos-moveis-redes-sem-fio', name: 'Dispositivos Móveis e Redes Sem Fio', description: 'Conectividade, segurança e gerenciamento de smartphones, tablets e outros dispositivos móveis em redes sem fio.' },
                            { id: 'ferramentas-produtividade-colaboracao', name: 'Ferramentas de Produtividade e Colaboração Online', description: 'Uso de ferramentas para trabalho em equipe, edição colaborativa e comunicação em tempo real.' },
                            { id: 'softwares-utilitarios', name: 'Softwares Utilitários e Ferramentas do Sistema', description: 'Funções de utilitários (compactadores, antivírus) e ferramentas de sistema (gerenciador de tarefas, desfragmentador) para manutenção.' },
                            { id: 'etica-legislacao-informatica', name: 'Noções de Ética e Legislação em Informática (LGPD, Crimes Digitais)', description: 'Aspectos legais e éticos do uso da tecnologia, incluindo a Lei Geral de Proteção de Dados (LGPD) e crimes cibernéticos.' }
                        ]
                    }
                ]
            }
        ];
        
        const educationalLaws = [
            { id: 'ldb', name: 'LDB - Lei de Diretrizes e Bases da Educação Nacional (Lei nº 9.394/96)', hasQuestions: true },
            { id: 'pne', name: 'PNE - Plano Nacional de Educação (Lei nº 13.005/14)', hasQuestions: true },
            { id: 'bncc', name: 'BNCC - Base Nacional Comum Curricular', hasQuestions: true },
            { id: 'eca', name: 'ECA - Estatuto da Criança e do Adolescente (Lei nº 8.069/90)', hasQuestions: true },
            { id: 'lei-inclusao', name: 'Lei Brasileira de Inclusão da Pessoa com Deficiência (Lei nº 13.146/15)', hasQuestions: true },
            { id: 'lei-libras', name: 'Lei de Libras (Lei nº 10.436/02)', hasQuestions: true },
            { id: 'lei-historia-afro', name: 'Lei nº 10.639/03 - História e Cultura Afro-Brasileira e Africana', hasQuestions: true }
        ];

        function showScreen(screenToShow) {
            [homeScreen, topicSelectionScreen, simuladoSetupScreen, quizScreen, finalScreen, essayCorrectionScreen, lawsScreen].forEach(screen => {
                screen.classList.add('hidden');
            });
            if (screenToShow) {
                screenToShow.classList.remove('hidden');
            }
        }

        function openModal(modalElement) {
            modalElement.classList.remove('hidden');
            setTimeout(() => {
                modalElement.classList.remove('opacity-0');
                if (modalElement.querySelector('.modal-container')) {
                    modalElement.querySelector('.modal-container').classList.remove('opacity-0', 'scale-95');
                }
            }, 10);
        }

        function closeModal(modalElement) {
            modalElement.classList.add('opacity-0');
            if (modalElement.querySelector('.modal-container')) {
                modalElement.querySelector('.modal-container').classList.add('opacity-0', 'scale-95');
            }
            setTimeout(() => {
                modalElement.classList.add('hidden');
            }, 300);
        }

        function updateStartButtonState(buttonElement) {
            const hasSelectedTopics = selectedTopics.length > 0;
            const hasValidQuestionQuantity = questionQuantity !== null && !isNaN(questionQuantity) && questionQuantity > 0;
            const isSimuladoReady = hasSelectedTopics && hasValidQuestionQuantity && difficulty !== null && responseMode !== null;

            if (isSimuladoReady) {
                buttonElement.disabled = false;
                buttonElement.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                buttonElement.disabled = true;
                buttonElement.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function renderTopics(searchTerm = '') {
            const container = topicContainerSimulado;
            container.innerHTML = '';
            const lowerCaseSearchTerm = searchTerm.toLowerCase();

            const categoriesForCurrentLevel = grammarData.filter(category => category.levels.includes(currentLevel));

            categoriesForCurrentLevel.forEach(category => {
                if (category.subCategories) {
                    const filteredSubCategories = subCategory => {
                        const filteredTopics = subCategory.topics.filter(topic =>
                            topic.name.toLowerCase().includes(lowerCaseSearchTerm)
                        );
                        // Only show subcategory if it has matching topics OR if its name matches the search term
                        return filteredTopics.length > 0 || subCategory.name.toLowerCase().includes(lowerCaseSearchTerm);
                    };

                    category.subCategories.filter(filteredSubCategories).forEach(subCategory => {
                        const subCategoryDiv = document.createElement('div');
                        subCategoryDiv.className = 'bg-white p-6 rounded-xl shadow-md topic-card';
                        subCategoryDiv.innerHTML = `
                            <h3 class="text-xl font-bold text-sky-700 mb-4">${category.category} - ${subCategory.name}</h3>
                            <div class="topic-list-grid grid grid-cols-1 md:grid-cols-2 gap-3">
                                ${subCategory.topics.filter(topic =>
                                    topic.name.toLowerCase().includes(lowerCaseSearchTerm)
                                ).map(topic => `
                                    <label class="flex items-center p-3 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-50 transition-colors">
                                        <input type="checkbox" data-topic-id="${topic.id}" data-topic-name="${topic.name}" class="topic-checkbox w-5 h-5 text-blue-600 rounded focus:ring-blue-500 mr-3">
                                        <span class="text-slate-700 font-medium">${topic.name}</span>
                                        <div class="ml-auto flex gap-2">
                                            <button type="button" class="study-button flex items-center" data-topic-id="${topic.id}" data-topic-name="${topic.name}" title="Estudar este tópico">
                                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                                                <span>Estudar</span>
                                            </button>
                                        </div>
                                    </label>
                                `).join('')}
                            </div>
                        `;
                        container.appendChild(subCategoryDiv);
                    });
                }
            });

            container.querySelectorAll('.topic-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (event) => {
                    const topicId = event.target.dataset.topicId;
                    const topicName = event.target.dataset.topicName;
                    if (event.target.checked) {
                        selectedTopics.push({ id: topicId, name: topicName });
                    } else {
                        selectedTopics = selectedTopics.filter(topic => topic.id !== topicId);
                    }
                    updateStartButtonState(startSimuladoButton);
                });
            });

            container.querySelectorAll('.study-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const topicId = event.currentTarget.dataset.topicId;
                    const topicName = event.currentTarget.dataset.topicName;
                    openStudyModal(topicId, topicName, 'Estudar:');
                });
            });
        }
        
        function renderLawsList() {
            const container = document.getElementById('laws-list-container');
            container.innerHTML = '';
            educationalLaws.forEach(law => {
                const lawDiv = document.createElement('div');
                lawDiv.className = 'w-full text-left p-4 bg-white rounded-lg shadow-md hover:bg-slate-50 transition-colors border-l-4 border-indigo-500 flex flex-col sm:flex-row justify-between items-start sm:items-center';
                lawDiv.innerHTML = `
                    <span class="text-slate-700 font-medium mb-2 sm:mb-0">${law.name}</span>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" class="study-button flex items-center" data-law-id="${law.id}" data-law-name="${law.name}" title="Consultar este documento">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                            <span>Consultar</span>
                        </button>
                        ${law.hasQuestions ? `
                        <button type="button" class="study-button flex items-center" data-law-id="${law.id}" data-law-name="${law.name}" title="Praticar questões sobre este documento">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                            </svg>
                            <span>Praticar</span>
                        </button>` : ''}
                    </div>
                `;
                container.appendChild(lawDiv);
            });

            container.querySelectorAll('.study-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const lawId = event.currentTarget.dataset.lawId;
                    const lawName = event.currentTarget.dataset.lawName;
                    openStudyModal(lawId, lawName, 'Consultar:');
                });
            });
        }

        async function callGeminiAPI(prompt, isJson = false, schema = null, maxRetries = 3, retryDelayMs = 1000) {
            const apiKey = "AIzaSyBZCyIRijGQHupvVA6aPfhS65DFjFHOmFQ"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {}
            };

            if (isJson) {
                payload.generationConfig.responseMimeType = "application/json";
                if (schema) {
                    payload.generationConfig.responseSchema = schema;
                }
            }

            console.log('Calling Gemini API with payload:', payload);

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 503 && i < maxRetries - 1) {
                        console.warn(`API Gemini retornou 503. Tentando novamente em ${retryDelayMs / 1000} segundos... (Tentativa ${i + 1} de ${maxRetries})`);
                        await new Promise(resolve => setTimeout(resolve, retryDelayMs));
                        continue; // Retry the request
                    }

                    const result = await response.json();
                    console.log('Raw API response:', result);

                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        return isJson ? JSON.parse(text) : text;
                    } else {
                        console.error("Resposta inesperada da API Gemini:", result);
                        throw new Error("A API não retornou um resultado válido.");
                    }
                } catch (error) {
                    console.error("Erro ao chamar a API Gemini:", error);
                    if (i < maxRetries - 1) {
                        console.warn(`Erro na API Gemini. Tentando novamente em ${retryDelayMs / 1000} segundos... (Tentativa ${i + 1} de ${maxRetries})`);
                        await new Promise(resolve => setTimeout(resolve, retryDelayMs));
                    } else {
                        throw error; // Re-throw the error if max retries reached
                    }
                }
            }
            throw new Error("Falha ao chamar a API Gemini após várias tentativas.");
        }

        function applyStudyTextStyling(text) {
            // Replace custom tags with styled HTML spans
            let styledText = text.replace(/<highlight-term>(.*?)<\/highlight-term>/g, '<span class="highlight-term">$1</span>');
            styledText = styledText.replace(/<underline-text>(.*?)<\/underline-text>/g, '<span class="underline-text">$1</span>');
            styledText = styledText.replace(/<important-phrase>(.*?)<\/important-phrase>/g, '<span class="important-phrase">$1</span>');
            return styledText;
        }

        async function openStudyModal(topicId, topicName, modalTitlePrefix) {
            studyModalTitleText.textContent = `${modalTitlePrefix} ${topicName}`;
            studyText.innerHTML = '';
            studyText.classList.add('hidden');
            studyLoadingArea.classList.remove('hidden'); // Show spinner immediately
            openModal(studyModal);

            try {
                let prompt = '';
                const isLaw = educationalLaws.some(law => law.id === topicId);
                let subjectName = "";

                if (currentLevel === 'informatica') {
                    subjectName = "Noções de Informática";
                } else if (isLaw) {
                    subjectName = "Legislação Educacional";
                } else {
                    for (const cat of grammarData) {
                        if (cat.subCategories?.some(subCat => subCat.topics.some(t => t.id === topicId))) {
                            subjectName = cat.category;
                            break;
                        }
                    }
                }

                if (isLaw) {
                    prompt = `Gere um resumo completo e os pontos mais importantes do seguinte documento: "${topicName}". Organize o conteúdo de forma clara e didática, usando títulos e subtítulos em Markdown. Para termos chave, use a tag HTML <highlight-term>termo</highlight-term>. Para sublinhar, use <underline-text>texto a sublinhar</underline-text>. Para destacar frases importantes, use <important-phrase>frase importante</important-phrase>.`;
                } else {
                    prompt = `Gere um material de estudo detalhado e didático sobre o tópico de ${subjectName} "${topicName}" para o nível de concurso público. Inclua exemplos claros e, se possível, um pequeno exercício com gabarito. Formate a resposta usando Markdown. Para termos chave, use a tag HTML <highlight-term>termo</highlight-term>. Para sublinhar, use <underline-text>texto a sublinhar</underline-text>. Para destacar frases importantes, use <important-phrase>frase importante</important-phrase>.`;
                }
                
                const markdownText = await callGeminiAPI(prompt);
                const styledHtml = applyStudyTextStyling(marked.parse(markdownText));
                studyText.innerHTML = styledHtml;
                studyText.classList.remove('hidden');
            } catch (error) {
                studyText.textContent = 'Ocorreu um erro ao carregar o material de estudo.';
                studyText.classList.remove('hidden');
            } finally {
                studyLoadingArea.classList.add('hidden'); // Hide spinner when done
            }
        }

        async function startLawQuiz(lawId, lawName) {
            currentLevel = 'leis'; // Set current level to laws
            selectedTopics = [{ id: lawId, name: lawName }];
            questionQuantity = 5; // Default questions for law quiz
            difficulty = 'intermediario'; // Default difficulty
            responseMode = 'multipla-escolha'; // Default response mode

            // Update display for simulado setup (optional, but good for consistency)
            displayNumQuestions.textContent = `${questionQuantity} Questões`;
            displayDifficulty.textContent = 'Intermediário';
            displayResponseMode.textContent = 'Múltipla Escolha (5 opções)';

            // Directly start the quiz
            await startQuizOrSimulado();
        }


        async function generateQuestions() {
            // Define loadingArea and quizContent here
            const loadingArea = document.getElementById('loading-area');
            const quizContent = document.getElementById('quiz-content');

            loadingArea.classList.remove('hidden');
            quizContent.classList.add('hidden');
            loadingText.textContent = "Gerando Questões...";
            console.log('Generating questions for topics:', selectedTopics); // Debugging log

            const responseSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "textContext": { "type": "STRING" },
                        "question": { "type": "STRING" },
                        "options": { "type": "ARRAY", "items": { "type": "STRING" } },
                        "correctAnswer": { "type": "STRING" }
                    },
                    required: ["question", "options", "correctAnswer"]
                }
            };
            console.log('Response Schema:', responseSchema); // Debugging log
            
            let allGeneratedQuestions = [];
            try {
                for (const topic of selectedTopics) {
                    const numQuestionsForTopic = topic.quantity || Math.ceil(questionQuantity / selectedTopics.length);
                    let prompt = '';
                    let subjectName = "";

                    if (currentLevel === 'informatica') {
                        subjectName = "Noções de Informática";
                    } else if (currentLevel === 'leis') {
                        subjectName = "Legislação Educacional";
                    } else {
                        for (const cat of grammarData) {
                            if (cat.levels.includes(currentLevel) && cat.subCategories?.some(subCat => subCat.topics.some(t => t.id === topic.id))) {
                                subjectName = cat.category;
                                break;
                            }
                        }
                    }

                    prompt = `Gere ${numQuestionsForTopic} questões sobre o tópico de ${subjectName} "${topic.name}" para um simulado de nível ${difficulty}. As questões devem ser elaboradas com o nível e estilo das bancas de concurso FCC, FGV e Cebraspe. Para cada questão, forneça um enunciado ("question"), ${responseMode === 'multipla-escolha' ? '5 opções de resposta ("options")' : 'uma afirmação'}, e a resposta correta ("correctAnswer"). Se relevante, inclua um texto de apoio ("textContext").`;
                    
                    console.log('Prompt for Gemini:', prompt); // Debugging log
                    
                    const parsedQuestions = await callGeminiAPI(prompt, true, responseSchema);
                    console.log('Parsed questions from API:', parsedQuestions); // Debugging log
                    parsedQuestions.forEach(q => {
                        q.topicId = topic.id;
                        q.topicName = topic.name;
                    });
                    allGeneratedQuestions.push(...parsedQuestions);
                }
                return allGeneratedQuestions.sort(() => Math.random() - 0.5);
            } catch (error) {
                console.error('Error generating questions:', error); // Debugging log
                return [];
            } finally {
                loadingArea.classList.add('hidden');
                quizContent.classList.remove('hidden');
            }
        }

        function displayQuestion() {
            if (currentQuestionIndex >= quizQuestions.length) {
                endQuiz();
                return;
            }
            currentQuestionData = quizQuestions[currentQuestionIndex];
            questionText.innerHTML = currentQuestionData.question;
            optionsContainer.innerHTML = '';
            showTextButton.classList.toggle('hidden', !currentQuestionData.textContext);

            const options = responseMode === 'certo-errado' ? ['Certo', 'Errado'] : currentQuestionData.options;
            options.forEach((optionText, index) => {
                const button = document.createElement('button');
                button.className = 'option-btn bg-blue-50 hover:bg-blue-100 text-blue-800 font-medium py-3 px-4 rounded-lg text-left shadow-sm border border-blue-200';
                button.textContent = optionText;
                button.addEventListener('click', () => checkAnswer(button, currentQuestionData.correctAnswer));
                optionsContainer.appendChild(button);
            });

            questionCounter.textContent = `Questão ${currentQuestionIndex + 1} de ${quizQuestions.length}`;
            nextQuestionButton.classList.add('hidden');
            appealQuestionButton.classList.add('hidden');
            updateProgressBar();
        }

        async function showExplanationForIncorrectAnswer(questionData, selectedText) {
            studyModalTitleText.textContent = `Explicação: ${questionData.topicName}`; // Set title
            studyText.innerHTML = ''; // Clear previous content
            studyText.classList.add('hidden'); // Hide text content
            studyLoadingArea.classList.remove('hidden'); // Show spinner
            openModal(studyModal); // Open the modal immediately

            try {
                let subjectName = "";
                if (currentLevel === 'informatica') {
                    subjectName = "Noções de Informática";
                } else if (currentLevel === 'leis') {
                    subjectName = "Legislação Educacional";
                } else {
                    for (const cat of grammarData) {
                        if (cat.subCategories?.some(subCat => subCat.topics.some(t => t.id === questionData.topicId))) {
                            subjectName = cat.category;
                            break;
                        }
                    }
                }
                const prompt = `Explique detalhadamente por que a resposta correta para a questão de ${subjectName} '${questionData.question}' é '${questionData.correctAnswer}', e por que a resposta '${selectedText}' está incorreta. Para termos chave, use a tag HTML <highlight-term>termo</highlight-term>. Para sublinhar, use <underline-text>texto a sublinhar</underline-text>. Para destacar frases importantes, use <important-phrase>frase importante</important-phrase>.`;
                const explanationText = await callGeminiAPI(prompt);
                const styledHtml = applyStudyTextStyling(marked.parse(explanationText));
                studyText.innerHTML = styledHtml;
                studyText.classList.remove('hidden'); // Show text content
            } catch (error) {
                studyText.textContent = 'Não foi possível carregar a explicação.';
                studyText.classList.remove('hidden'); // Show error message
            } finally {
                studyLoadingArea.classList.add('hidden'); // Hide spinner
            }
        }

        function checkAnswer(selectedButton, correctAnswer) {
            const isCorrect = selectedButton.textContent.trim() === correctAnswer.trim();
            document.querySelectorAll('#options-container .option-btn').forEach(btn => {
                btn.disabled = true;
                if (btn.textContent.trim() === correctAnswer.trim()) {
                    btn.classList.add('correct');
                } else if (btn === selectedButton) {
                    btn.classList.add('incorrect');
                }
            });

            if (isCorrect) {
                score++;
                scoreDisplay.textContent = score;
                performanceReport[currentQuestionData.topicId].correct++;
            } else {
                performanceReport[currentQuestionData.topicId].incorrect++;
                showExplanationForIncorrectAnswer(currentQuestionData, selectedButton.textContent);
            }

            nextQuestionButton.classList.remove('hidden');
            appealQuestionButton.classList.remove('hidden');
        }

        function nextQuestion() {
            currentQuestionIndex++;
            displayQuestion();
        }

        function updateProgressBar() {
            const progress = (currentQuestionIndex / quizQuestions.length) * 100;
            progressBar.style.width = `${progress}%`;
        }

        function endQuiz() {
            stopTimer();
            finalTimeDisplay.textContent = `Tempo total: ${formatTime(timeLeft)}`;
            finalTimeDisplay.classList.remove('hidden');
            showPerformanceReport();
            finalScoreDisplay.textContent = `${score}/${quizQuestions.length}`;
            finalTopicDisplay.textContent = "Simulado";
            showScreen(finalScreen);
        }

        function startTimer() {
            let seconds = 0;
            timerInterval = setInterval(() => {
                seconds++;
                timeLeft = seconds;
                timerDisplay.textContent = formatTime(seconds);
            }, 1000);
            timerDisplayContainer.classList.remove('hidden');
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timerDisplayContainer.classList.add('hidden');
        }

        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        async function openAppealModal() {
            appealTextArea.value = '';
            appealResponseText.textContent = '';
            appealResponseContainer.classList.add('hidden');
            submitAppealButton.disabled = false;
            openModal(appealModal);
        }

        async function submitAppeal() {
            const userAppeal = appealTextArea.value.trim();
            if (!userAppeal) return;
            submitAppealButton.disabled = true;
            appealResponseContainer.classList.remove('hidden');
            appealResponseText.innerHTML = '<div class="spinner"></div>'; // Show spinner immediately

            try {
                const prompt = `Avalie o seguinte recurso de questão. A questão era: "${currentQuestionData.question}". A resposta correta era: "${currentQuestionData.correctAnswer}". O usuário argumentou: "${userAppeal}". O recurso é válido? Justifique.`;
                const appealResponse = await callGeminiAPI(prompt);
                appealResponseText.textContent = appealResponse;
            } catch (error) {
                appealResponseText.textContent = 'Erro ao avaliar o recurso.';
            }
        }

        function openQuestionDistributionModal() {
            expectedTotalQuestionsSpan.textContent = questionQuantity;
            distributionTotalDisplay.textContent = '0';
            questionDistributionContainer.innerHTML = '';
            selectedTopics.forEach(topic => {
                const topicDiv = document.createElement('div');
                topicDiv.className = 'flex items-center justify-between bg-slate-50 p-3 rounded-lg border border-slate-200';
                topicDiv.innerHTML = `
                    <span class="text-slate-700 font-medium">${topic.name}:</span>
                    <input type="number" data-topic-id="${topic.id}" class="topic-distribution-input w-20 p-2 border border-slate-300 rounded-lg text-center" value="0" min="0">
                `;
                questionDistributionContainer.appendChild(topicDiv);
            });
            questionDistributionContainer.querySelectorAll('.topic-distribution-input').forEach(input => {
                input.addEventListener('input', updateDistributionTotal);
            });
            openModal(questionDistributionModal);
        }

        function updateDistributionTotal() {
            let currentTotal = Array.from(document.querySelectorAll('.topic-distribution-input')).reduce((sum, input) => sum + (parseInt(input.value) || 0), 0);
            distributionTotalDisplay.textContent = currentTotal;
            const isTotalCorrect = currentTotal === questionQuantity;
            confirmDistributionBtn.disabled = !isTotalCorrect;
            confirmDistributionBtn.classList.toggle('opacity-50', !isTotalCorrect);
            confirmDistributionBtn.classList.toggle('cursor-not-allowed', !isTotalCorrect);
            distributionErrorMessage.classList.toggle('hidden', isTotalCorrect);
        }

        function randomizeDistribution() {
            let total = questionQuantity;
            const inputs = Array.from(document.querySelectorAll('.topic-distribution-input'));
            const numTopics = inputs.length;
            if (numTopics === 0) return;
            const base = Math.floor(total / numTopics);
            let remainder = total % numTopics;
            inputs.forEach((input, index) => {
                input.value = base + (index < remainder ? 1 : 0);
            });
            updateDistributionTotal();
        }

        async function confirmDistributionAndStartSimulado() {
            selectedTopics.forEach(topic => {
                const input = questionDistributionContainer.querySelector(`input[data-topic-id="${topic.id}"]`);
                topic.quantity = parseInt(input.value) || 0;
            });
            closeModal(questionDistributionModal);
            await startQuizOrSimulado();
        }

        function showPerformanceReport() {
            performanceReportContent.innerHTML = '';
            Object.entries(performanceReport).forEach(([topicId, results]) => {
                const topic = selectedTopics.find(t => t.id === topicId) || { name: 'Desconhecido' };
                const p = document.createElement('p');
                p.innerHTML = `<strong>${topic.name}:</strong> Acertos: ${results.correct}, Erros: ${results.incorrect}`;
                performanceReportContent.appendChild(p);
            });
            openModal(performanceReportModal);
        }

        function openTextModal(text) {
            textModalContent.innerHTML = text.replace(/\n/g, '<br>');
            openModal(textModal);
        }

        async function correctEssay() {
            const fullEssay = [essayTitleInput.value, introInput.value, devInput.value, concInput.value].join('\n\n').trim();
            if (!fullEssay) return;
            correctionLoadingArea.classList.remove('hidden');
            correctEssayBtn.disabled = true;
            try {
                const prompt = `Avalie a seguinte redação do tipo "${essayType}", focando em gramática, coesão, coerência e argumentação. Forneça feedback detalhado e uma nota de 0 a 100. Formate com Markdown. Redação:\n\n${fullEssay}`;
                const feedbackMarkdown = await callGeminiAPI(prompt);
                essayFeedback.innerHTML = marked.parse(feedbackMarkdown);
                postCorrectionActions.classList.remove('hidden');
            } catch (error) {
                essayFeedback.innerHTML = '<p class="text-red-500">Erro ao corrigir a redação.</p>';
            } finally {
                correctionLoadingArea.classList.add('hidden');
                correctEssayBtn.disabled = false;
            }
        }

        function redoEssay(keepTheme) {
            [essayTitleInput, introInput, devInput, concInput].forEach(input => input.value = '');
            essayFeedback.innerHTML = '<p class="text-slate-500 italic">Seu feedback aparecerá aqui.</p>';
            postCorrectionActions.classList.add('hidden');
            if (!keepTheme) {
                generatedEssayTheme = '';
                generatedThemeText.textContent = ''; // Clear the displayed theme text
                themeDisplay.classList.add('hidden'); // Hide the theme display area
            }
        }

        async function downloadEssayPdf() {
            pdfLoadingArea.classList.remove('hidden');
            downloadEssayPdfBtn.disabled = true;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const tempDiv = document.createElement('div');
            tempDiv.style.width = '180mm';
            tempDiv.innerHTML = `<h1>${essayTitleInput.value}</h1><h2>Tema: ${generatedEssayTheme}</h2><div>${introInput.value}</div><div>${devInput.value}</div><div>${concInput.value}</div><hr><h2>Feedback</h2><div>${essayFeedback.innerHTML}</div>`;
            document.body.appendChild(tempDiv);
            try {
                await doc.html(tempDiv, {
                    callback: function (doc) {
                        doc.save('redacao_feedback.pdf');
                    },
                    x: 15,
                    y: 15,
                    width: 180,
                    windowWidth: 650
                });
            } catch (error) {
                console.error("Erro ao gerar PDF:", error);
            } finally {
                document.body.removeChild(tempDiv);
                pdfLoadingArea.classList.add('hidden');
                downloadEssayPdfBtn.disabled = false;
            }
        }
        
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function initializeAppUI() {
            showScreen(homeScreen);
            currentLevel = null;
            selectedTopics = [];
            questionQuantity = 10;
            difficulty = null;
            responseMode = null;
            isSimulado = true;
            levelSelectButtons.forEach(btn => btn.classList.remove('selected', 'ring-4', 'ring-blue-400'));
            enterAppButton.disabled = true;
            enterAppButton.classList.add('opacity-50', 'cursor-not-allowed');
            displayNumQuestions.textContent = '---';
            displayDifficulty.textContent = '---';
            displayResponseMode.textContent = '---';
            updateStartButtonState(startSimuladoButton);
            redoEssay(false); // reseta e oculta campos da redação, mas não abre o modal de tema
            themeDisplay.classList.add('hidden');
            topicSearchInput.value = ''; // Clear search input
        }

        async function startQuizOrSimulado() {
            if (selectedTopics.length === 0) return;
            performanceReport = {};
            selectedTopics.forEach(topic => {
                performanceReport[topic.id] = { correct: 0, incorrect: 0 };
            });
            showScreen(quizScreen);
            quizQuestions = [];
            currentQuestionIndex = 0;
            score = 0;
            scoreDisplay.textContent = score;
            let subject = "Simulado";
            if (currentLevel === 'informatica') {
                subject = "Noções de Informática";
            } else {
                subject = grammarData.find(cat => cat.levels.includes(currentLevel))?.category || "Simulado";
            }
            quizTopicTitle.textContent = `${subject} - Nível: ${difficulty || 'N/A'}`;
            startTimer();
            quizQuestions = await generateQuestions();
            if (quizQuestions.length > 0) {
                displayQuestion();
            } else {
                questionText.textContent = "Não foi possível carregar as questões. Verifique o console para mais detalhes."; // Updated error message
            }
        }

        function populateDisciplinaSelect() {
            selectDisciplinaTema.innerHTML = '<option value="">Selecione...</option>';
            [
                "Letras – Português",
                "Letras – Inglês",
                "Letras – Espanhol",
                "Letras – Francês",
                "Artes Visuais",
                "Teatro",
                "Dança",
                "Música",
                "Educação Artística",
                "Educação Física",
                "Ciências Biológicas (Biologia)",
                "Física",
                "Química",
                "Ciências Naturais",
                "Matemática",
                "Geografia",
                "História",
                "Filosofia",
                "Sociologia",
                "Pedagogia",
                "Ciências Sociais",
                "Educação do Campo",
                "Educação Indígena",
                "Educação Quilombola",
                "Educação Intercultural",
                "Educação Especial",
                "Ciências Ambientais",
                "Informática na Educação",
                "Libras (Língua Brasileira de Sinais)",
                "Tecnologias Educacionais"
            ].forEach(d => {
                selectDisciplinaTema.innerHTML += `<option value="${d}">${d}</option>`;
            });
        }

        const disciplineCategoryMap = { "Português": "Língua Portuguesa", "Pedagogia": "Conhecimentos Pedagógicos", "Direito": "Direito", "Informática": "Noções de Informática" };

        async function generateEssayTheme(type, specificTheme = '') {
            temaLoadingArea.classList.remove('hidden');
            confirmGerarTemaBtn.disabled = true;
            confirmGerarTemaBtn.classList.add('opacity-50', 'cursor-not-allowed'); // Ensure disabled style is applied
            let prompt;
            if (type === 'current') {
                prompt = `Considerando uma vasta gama de temas atuais e relevantes para concursos públicos, gere **apenas um** tema de redação conciso e direto sobre '${specificTheme}', sem introduções, explicações ou formatação adicional, como aspas ou marcadores de lista. O tema deve ser uma frase que possa servir como título ou proposta de redação. Por exemplo: 'A importância da educação na sociedade contemporânea'.`;
            } else if (type === 'discipline' && specificTheme) {
                prompt = `Considerando uma vasta gama de temas de redação para concursos públicos relacionados à disciplina de '${specificTheme}', gere **apenas um** tema conciso e direto, sem introduções, explicações ou formatação adicional, como aspas ou marcadores de lista. O tema deve ser uma frase que possa servir como título ou proposta de redação. Por exemplo: 'O papel da matemática no desenvolvimento do pensamento crítico'.`;
            } else return;

            try {
                const theme = await callGeminiAPI(prompt);
                // Clean up the theme string from any unwanted characters or extra text
                generatedEssayTheme = theme.replace(/^(Tema:\s*|##\s*\*\*|\*\*|["'])/gi, '', '').replace(/["']$/g, '').trim();
                generatedThemeText.textContent = generatedEssayTheme;
                themeDisplay.classList.remove('hidden');
                closeModal(modalGerarTema);
                // Enable essay inputs and correction button after theme generation
                [essayTitleInput, introInput, devInput, concInput].forEach(el => el.disabled = false);
                correctEssayBtn.disabled = false;
                helpButtons.forEach(btn => btn.classList.remove('disabled'));
            } catch (error) {
                generatedThemeText.textContent = 'Erro ao gerar tema. Tente novamente.';
                themeDisplay.classList.remove('hidden');
            } finally {
                temaLoadingArea.classList.add('hidden');
                // The button state will be handled by the change listeners on input/select
            }
        }

        async function openHelpTipsModal(section) {
            currentHelpSection = section;
            helpTipsSectionName.textContent = section.charAt(0).toUpperCase() + section.slice(1);
            currentTips = [];
            currentTipIndex = 0;
            helpTipsContent.innerHTML = ''; // Clear previous content
            helpTipsContent.classList.add('hidden'); // Hide text content
            helpTipsLoadingArea.classList.remove('hidden'); // Show spinner
            openModal(helpTipsModal);
            await generateTipsForSection(section, 'initial');
        }

        async function generateTipsForSection(section, type) {
            helpTipsLoadingArea.classList.remove('hidden');
            generateMoreTipsBtn.disabled = true;
            const context = `Considerando a redação tipo "${essayType}" sobre "${generatedEssayTheme}", `;
            const prompt = `${context} gere ${type === 'initial' ? 5 : 3} dicas práticas para a ${section} da redação. Para cada dica, inclua o tipo (vocabulario, tecnica, geral, exemplo) e o conteúdo. Para dicas de vocabulário, forneça palavras cultas e expressões formais relevantes para a seção, com um breve contexto de uso. Para técnicas, descreva métodos de escrita. Para dicas gerais, ofereça conselhos amplos. Formate como array JSON de objetos, cada um com 'type' (string) e 'content' (string).`;
            
            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "type": { "type": "STRING", "enum": ["vocabulario", "tecnica", "geral", "exemplo"] },
                        "content": { "type": "STRING" }
                    },
                    required: ["type", "content"]
                }
            };

            try {
                const newTips = await callGeminiAPI(prompt, true, schema);
                currentTips.push(...newTips);
                if (type === 'initial') currentTipIndex = 0;
                displayCurrentTip();
                helpTipsContent.classList.remove('hidden'); // Show text content
            }
            catch (error) {
                helpTipsContent.textContent = 'Erro ao gerar dicas.';
                helpTipsContent.classList.remove('hidden'); // Show error message
            } finally {
                helpTipsLoadingArea.classList.add('hidden'); // Hide spinner
                generateMoreTipsBtn.disabled = false;
            }
        }

        function displayCurrentTip() {
            if (currentTips.length > 0) {
                const currentTip = currentTips[currentTipIndex];
                let contentHtml = '';
                if (currentTip.type === 'vocabulario') {
                    contentHtml = `<p class="font-semibold text-indigo-700">Vocabulário e Expressões:</p><p>${currentTip.content}</p>`;
                } else if (currentTip.type === 'tecnica') {
                    contentHtml = `<p class="font-semibold text-emerald-700">Técnica de Redação:</p><p>${currentTip.content}</p>`;
                } else if (currentTip.type === 'geral') {
                    contentHtml = `<p class="font-semibold text-blue-700">Dica Geral:</p><p>${currentTip.content}</p>`;
                } else if (currentTip.type === 'exemplo') {
                    contentHtml = `<p class="font-semibold text-purple-700">Exemplo:</p><p>${currentTip.content}</p>`;
                } else {
                    contentHtml = `<p>${currentTip.content}</p>`; // Fallback
                }
                helpTipsContent.innerHTML = contentHtml;
                tipCounter.textContent = `${currentTipIndex + 1} de ${currentTips.length}`;
                prevTipBtn.disabled = currentTipIndex === 0;
                nextTipBtn.disabled = currentTipIndex === currentTips.length - 1;
            } else {
                helpTipsContent.textContent = "Nenhuma dica disponível.";
                tipCounter.textContent = "0 de 0";
                prevTipBtn.disabled = nextTipBtn.disabled = true;
            }
        }


        levelSelectButtons.forEach(button => button.addEventListener('click', () => {
            currentLevel = button.dataset.level;
            levelSelectButtons.forEach(btn => btn.classList.remove('selected', 'ring-4', 'ring-blue-400'));
            button.classList.add('selected', 'ring-4', 'ring-blue-400');
            enterAppButton.disabled = false;
            enterAppButton.classList.remove('opacity-50', 'cursor-not-allowed');
        }));

        enterAppButton.addEventListener('click', () => {
            if (currentLevel === 'redacao-correcao') {
                openModal(modalConfigRedacao);
            } else if (currentLevel === 'leis') {
                renderLawsList();
                showScreen(lawsScreen);
            } else {
                renderTopics(); // Render topics initially without a search term
                showScreen(simuladoSetupScreen);
            }
        });

        confirmConfigRedacaoBtn.addEventListener('click', () => {
            essayType = selectTipoRedacao.value;
            essayLineQuantity = parseInt(inputQuantidadeLinhas.value);
            closeModal(modalConfigRedacao);
            showScreen(essayCorrectionScreen);
            // Disable essay inputs and correction button until a theme is generated
            [essayTitleInput, introInput, devInput, concInput].forEach(el => el.disabled = true);
            correctEssayBtn.disabled = true;
            helpButtons.forEach(btn => btn.classList.add('disabled'));
        });

        [btnNumQuestions, btnDifficulty, btnResponseMode].forEach(btn => {
            btn.addEventListener('click', () => {
                const modalId = btn.id.replace('btn-', '') + '-modal';
                openModal(document.getElementById(modalId));
            });
        });
        
        // Updated logic for confirmNumQuestionsBtn
        confirmNumQuestionsBtn.addEventListener('click', () => {
            questionQuantity = parseInt(modalQuestionQuantityInput.value);
            displayNumQuestions.textContent = `${questionQuantity} Questões`;
            closeModal(numQuestionsModal);
            updateStartButtonState(startSimuladoButton);
        });

        // Updated logic for confirmDifficultyBtn
        confirmDifficultyBtn.addEventListener('click', () => {
            const selectedRadio = document.querySelector('input[name="modalDifficulty"]:checked');
            if (selectedRadio) {
                difficulty = selectedRadio.value;
                displayDifficulty.textContent = selectedRadio.labels[0].textContent;

                // Remove 'selected' class from all labels first
                document.querySelectorAll('.difficulty-label').forEach(label => {
                    label.classList.remove('selected');
                });

                // Add 'selected' class to the label of the chosen radio button
                const correspondingLabel = document.querySelector(`label[for="${selectedRadio.id}"]`);
                if (correspondingLabel) {
                    correspondingLabel.classList.add('selected');
                }

                closeModal(difficultyModal);
                updateStartButtonState(startSimuladoButton);
            }
        });

        // Event listener for difficulty radio buttons to apply 'selected' class immediately on change
        modalDifficultyRadios.forEach(radio => {
            radio.addEventListener('change', (event) => {
                document.querySelectorAll('.difficulty-label').forEach(label => {
                    label.classList.remove('selected');
                });
                if (event.target.checked) {
                    const correspondingLabel = document.querySelector(`label[for="${event.target.id}"]`);
                    if (correspondingLabel) {
                        correspondingLabel.classList.add('selected');
                    }
                }
            });
        });

        // Updated logic for confirmResponseModeBtn
        confirmResponseModeBtn.addEventListener('click', () => {
            const selectedRadio = document.querySelector('input[name="modalResponseMode"]:checked');
            if (selectedRadio) {
                responseMode = selectedRadio.value;
                displayResponseMode.textContent = selectedRadio.labels[0].textContent;

                // Remove 'selected' class from all labels first
                document.querySelectorAll('.response-mode-label').forEach(label => {
                    label.classList.remove('selected');
                });

                // Add 'selected' class to the label of the chosen radio button
                const correspondingLabel = document.querySelector(`label[for="${selectedRadio.id}"]`);
                if (correspondingLabel) {
                    correspondingLabel.classList.add('selected');
                }

                closeModal(responseModeModal);
                updateStartButtonState(startSimuladoButton);
            }
        });

        // Event listener for response mode radio buttons to apply 'selected' class immediately on change
        modalResponseModeRadios.forEach(radio => {
            radio.addEventListener('change', (event) => {
                document.querySelectorAll('.response-mode-label').forEach(label => {
                    label.classList.remove('selected');
                });
                if (event.target.checked) {
                    const correspondingLabel = document.querySelector(`label[for="${event.target.id}"]`);
                    if (correspondingLabel) {
                        correspondingLabel.classList.add('selected');
                    }
                }
            });
        });


        startSimuladoButton.addEventListener('click', () => {
            if (selectedTopics.length > 1) {
                openQuestionDistributionModal();
            } else {
                selectedTopics.forEach(t => t.quantity = questionQuantity);
                startQuizOrSimulado();
            }
        });
        
        document.querySelectorAll('.back-to-home').forEach(btn => btn.addEventListener('click', initializeAppUI));
        nextQuestionButton.addEventListener('click', nextQuestion);
        backToMenuButton.addEventListener('click', () => showScreen(simuladoSetupScreen));
        restartQuizButton.addEventListener('click', startQuizOrSimulado);
        backToMenuFinalButton.addEventListener('click', () => showScreen(simuladoSetupScreen));
        appealQuestionButton.addEventListener('click', openAppealModal);
        closeStudyModalButton.addEventListener('click', () => closeModal(studyModal));
        submitAppealButton.addEventListener('click', submitAppeal);
        cancelNumQuestionsBtn.addEventListener('click', () => closeModal(numQuestionsModal));
        cancelDifficultyBtn.addEventListener('click', () => closeModal(difficultyModal));
        cancelResponseModeBtn.addEventListener('click', () => closeModal(responseModeModal));
        closeAppealModalButton.addEventListener('click', () => closeModal(appealModal));
        randomizeDistributionBtn.addEventListener('click', randomizeDistribution);
        confirmDistributionBtn.addEventListener('click', confirmDistributionAndStartSimulado);
        cancelDistributionBtn.addEventListener('click', () => closeModal(questionDistributionModal));
        closeReportModalBtn.addEventListener('click', () => closeModal(performanceReportModal));
        showTextButton.addEventListener('click', () => openTextModal(currentQuestionData.textContext));
        closeTextModalButton.addEventListener('click', () => closeModal(textModal));
        correctEssayBtn.addEventListener('click', correctEssay);
        redoSameThemeBtn.addEventListener('click', () => redoEssay(true));
        redoNewThemeBtn.addEventListener('click', () => redoEssay(false));
        downloadEssayPdfBtn.addEventListener('click', downloadEssayPdf);
        generateThemeBtn.addEventListener('click', () => {
            populateDisciplinaSelect();
            openModal(modalGerarTema);
            // Reset state of theme generation buttons and input
            currentThemeInput.value = '';
            disciplinaSelectContainer.classList.add('hidden');
            currentThemeInputContainer.classList.add('hidden');
            confirmGerarTemaBtn.disabled = true;
            confirmGerarTemaBtn.classList.add('opacity-50', 'cursor-not-allowed');
        });
        btnTemasAtuais.addEventListener('click', () => {
            disciplinaSelectContainer.classList.add('hidden');
            currentThemeInputContainer.classList.remove('hidden');
            // Only enable if currentThemeInput has value
            confirmGerarTemaBtn.disabled = !currentThemeInput.value.trim();
            confirmGerarTemaBtn.classList.toggle('opacity-50', !currentThemeInput.value.trim());
            confirmGerarTemaBtn.classList.toggle('cursor-not-allowed', !currentThemeInput.value.trim());
            confirmGerarTemaBtn.dataset.themeType = 'current';
        });
        btnTemasDisciplina.addEventListener('click', () => {
            currentThemeInputContainer.classList.add('hidden');
            disciplinaSelectContainer.classList.remove('hidden');
            // Only enable if a discipline is selected
            confirmGerarTemaBtn.disabled = !selectDisciplinaTema.value;
            confirmGerarTemaBtn.classList.toggle('opacity-50', !selectDisciplinaTema.value);
            confirmGerarTemaBtn.classList.toggle('cursor-not-allowed', !selectDisciplinaTema.value);
            confirmGerarTemaBtn.dataset.themeType = 'discipline';
        });
        selectDisciplinaTema.addEventListener('change', () => {
            confirmGerarTemaBtn.disabled = !selectDisciplinaTema.value;
            confirmGerarTemaBtn.classList.toggle('opacity-50', !selectDisciplinaTema.value);
            confirmGerarTemaBtn.classList.toggle('cursor-not-allowed', !selectDisciplinaTema.value);
        });
        currentThemeInput.addEventListener('input', () => {
            confirmGerarTemaBtn.disabled = !currentThemeInput.value.trim();
            confirmGerarTemaBtn.classList.toggle('opacity-50', !currentThemeInput.value.trim());
            confirmGerarTemaBtn.classList.toggle('cursor-not-allowed', !currentThemeInput.value.trim());
        });

        confirmGerarTemaBtn.addEventListener('click', () => {
            const type = confirmGerarTemaBtn.dataset.themeType;
            const value = type === 'current' ? currentThemeInput.value : selectDisciplinaTema.value;
            generateEssayTheme(type, value);
        });
        cancelGerarTemaBtn.addEventListener('click', () => closeModal(modalGerarTema));
        helpButtons.forEach(btn => btn.addEventListener('click', e => openHelpTipsModal(e.currentTarget.dataset.section)));
        prevTipBtn.addEventListener('click', () => { if (currentTipIndex > 0) { currentTipIndex--; displayCurrentTip(); } });
        nextTipBtn.addEventListener('click', () => { if (currentTipIndex < currentTips.length - 1) { currentTipIndex++; displayCurrentTip(); } });
        generateMoreTipsBtn.addEventListener('click', () => generateTipsForSection(currentHelpSection, 'more'));
        closeHelpTipsModalBtn.addEventListener('click', () => closeModal(helpTipsModal));
        
        // New: Event listener for topic search input
        topicSearchInput.addEventListener('input', (event) => {
            renderTopics(event.target.value);
        });

        const markedScript = document.createElement('script');
        markedScript.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
        document.head.appendChild(markedScript);

        const jspdfScript = document.createElement('script');
        jspdfScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        document.head.appendChild(jspdfScript);
        
        const html2canvasScript = document.createElement('script');
        html2canvasScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
        document.head.appendChild(html2canvasScript);

        window.onload = initializeAppUI;
    </script>
</body>
</html>
