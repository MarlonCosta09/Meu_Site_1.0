<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRAMATIQU√äS - Pr√°tica de Gram√°tica Portuguesa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Slab:wght@700&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0; /* Cinza claro s√≥lido */
        }
        .title-font {
            font-family: 'Roboto Slab', serif;
        }
        /* Nova classe para a fonte "Modo Concurseiro" */
        .concurseiro-font {
            font-family: 'Pacifico', cursive; /* Usando Pacifico como alternativa a Bodega Script */
        }
        .option-btn {
            transition: all 0.2s ease-in-out;
            /* Novos estilos para os bot√µes de op√ß√£o */
            background-color: #e0f7fa; /* light-blue-50 */
            border-color: #81d4fa; /* light-blue-200 */
            color: #006064; /* deep-teal-800 */
        }
        .option-btn:hover {
            background-color: #b2ebf2; /* light-blue-100 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .correct {
            background-color: #22c55e !important; /* green-500 */
            color: white !important;
            border-color: #16a34a; /* green-600 */
            transform: scale(1.02);
        }
        .incorrect {
            background-color: #ef4444 !important; /* red-500 */
            color: white !important;
            border-color: #dc2626; /* red-600 */
        }
        .disabled {
            pointer-events: none;
            opacity: 0.9;
        }
        .topic-card {
            page-break-inside: avoid;
            break-inside: avoid;
            /* Novos estilos para os cart√µes de t√≥pico */
            border-left: 8px solid #0ea5e9; /* sky-500 */
            transition: all 0.2s ease-in-out;
        }
        .topic-card:hover {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-3px);
        }
        .topic-list-grid { /* Alterado de #topic-list para .topic-list-grid */
            column-count: 1;
        }
        @media (min-width: 768px) {
            .topic-list-grid { /* Alterado de #topic-list para .topic-list-grid */
                column-count: 2;
            }
        }
        /* Estilos para o Modal */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-container {
            transition: all 0.3s ease;
            /* Ajustes para o tamanho e rolagem dos modais */
            max-height: 90vh; /* Limita a altura m√°xima para caber na tela */
            overflow-y: auto; /* Adiciona rolagem vertical se o conte√∫do exceder a altura */
        }
        /* Estilos para o spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilo para o popup de informa√ß√µes */
        .info-popup {
            position: absolute;
            bottom: 1.5rem; /* Ajustado para descer mais */
            right: 0.5rem; /* Mantido no canto direito */
            background-color: #fff;
            padding: 0.6rem 0.8rem; /* Reduzido em aproximadamente 20% */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-size: 0.7rem; /* Reduzido em aproximadamente 20% */
            color: #475569; /* slate-600 */
            z-index: 50; /* Garante que fique acima de outros elementos */
        }
        /* Ajuste para a tela inicial para permitir posicionamento absoluto do popup */
        #home-screen {
            position: relative; /* Necess√°rio para posicionar o popup absolutamente dentro dela */
            overflow: hidden; /* Para garantir que o fundo de texto n√£o vaze */
        }
        /* Estilo para o fundo de texto transparente */
        .text-background-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Permite cliques nos elementos abaixo */
            z-index: 1; /* Garante que fique atr√°s do conte√∫do principal */
            color: rgba(100, 100, 100, 0.08); /* Cinza muito claro com mais transpar√™ncia */
            font-size: 1.8rem; /* Ligeiramente maior */
            line-height: 1.8;
            text-align: center;
            overflow: hidden;
            word-break: break-all;
            white-space: pre-wrap; /* Preserva espa√ßos em branco e quebras de linha */
            user-select: none; /* Impede sele√ß√£o de texto */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05); /* Sombra sutil para efeito 3D */
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 100px,
                rgba(220, 220, 220, 0.03) 100px, /* Ajuste para mais transpar√™ncia no gradiente tamb√©m */
                rgba(220, 220, 220, 0.03) 200px
            );
        }
        /* Estilo para o √≠cone do professor no modal */
        .professor-icon {
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
            color: #4f46e5; /* indigo-600 */
        }
        /* Estilo para o √≠cone de ajuda */
        .help-icon {
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
            color: #fff; /* white */
        }
        /* Estilo para o iframe do YouTube */
        .video-responsive {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            max-width: 100%;
            background: #000;
            border-radius: 0.5rem;
        }
        .video-responsive iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        .difficulty-label.selected,
        .response-mode-label.selected { /* Adicionado para o modo de resposta */
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border-color: #3b82f6;
        }

        /* Estilos para a Tela Final */
        #final-screen {
            background: linear-gradient(to bottom right, #e0f2fe, #bbdefb); /* Gradiente azul claro */
            border-radius: 1.5rem; /* Cantos mais arredondados */
            padding: 3rem; /* Mais padding */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); /* Sombra mais pronunciada */
            animation: fadeInScale 0.5s ease-out forwards;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        #final-screen h2 {
            color: #1e40af; /* Azul mais escuro */
            font-size: 3.5rem; /* T√≠tulo maior */
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        #final-screen #final-topic {
            color: #1d4ed8; /* Azul m√©dio */
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
        }

        #final-screen .text-lg.text-slate-600 {
            color: #475569; /* Cinza slate */
            font-weight: 500;
        }

        #final-screen #final-score {
            color: #059669; /* Verde esmeralda */
            font-size: 7rem; /* Pontua√ß√£o gigante */
            font-weight: 800;
            margin-bottom: 2rem;
            text-shadow: 3px 33px 6px rgba(0, 0, 0, 0.2);
        }

        #final-screen #final-time {
            color: #64748b; /* Cinza mais escuro */
            font-size: 1.25rem;
            margin-bottom: 2.5rem;
        }

        #final-screen .flex button {
            padding: 1rem 2rem;
            border-radius: 9999px; /* Bot√µes completamente arredondados */
            font-size: 1.1rem;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #final-screen #restart-quiz {
            background-color: #2563eb; /* Azul vibrante */
            color: white;
            border: 2px solid #1d4ed8;
        }
        #final-screen #restart-quiz:hover {
            background-color: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
        }

        #final-screen #back-to-menu-final,
        #final-screen #back-to-home-from-final {
            background-color: #cbd5e1; /* Cinza mais claro */
            color: #334155;
            border: 2px solid #94a3b8;
        }
        #final-screen #back-to-menu-final:hover,
        #final-screen #back-to-home-from-final:hover {
            background-color: #94a3b8;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
        }

        /* Novo estilo para o modal de texto */
        .text-modal-content {
            background-color: #fff; /* Fundo branco */
            border: 1px solid #e0e0e0; /* Borda sutil */
            border-radius: 8px;
            padding: 1.5rem;
            line-height: 1.6;
            font-size: 1rem;
            color: #333; /* Cor do texto mais escura */
            max-height: 70vh; /* Altura m√°xima para rolagem */
            overflow-y: auto; /* Habilita a rolagem vertical */
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05); /* Sombra interna sutil */
            position: relative;
            background-image: linear-gradient(to bottom, #f9f9f9 1px, transparent 1px); /* Linhas de caderno */
            background-size: 100% 1.8em; /* Altura da linha */
        }
        .text-modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 40px; /* Margem esquerda para a linha vertical */
            bottom: 0;
            width: 1px;
            background-color: rgba(255, 0, 0, 0.2); /* Linha vertical vermelha clara */
        }
        /* Estilo para o conte√∫do do modal de estudo */
        #study-text {
            color: #333; /* Cor do texto mais escura para o conte√∫do de estudo */
        }

        /* Estilos para o modal de autentica√ß√£o */
        .auth-tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem 0.5rem 0 0;
            font-weight: 600;
            color: #64748b; /* slate-500 */
            background-color: #e2e8f0; /* slate-200 */
            transition: all 0.2s ease-in-out;
            border-bottom: 2px solid transparent;
        }
        .auth-tab-button.active {
            color: #3b82f6; /* blue-500 */
            background-color: #fff;
            border-bottom: 2px solid #3b82f6;
        }
        .auth-tab-content {
            padding: 1.5rem;
            background-color: #fff;
            border-radius: 0 0 0.5rem 0.5rem;
        }
        /* Estilo para a descri√ß√£o do diagrama */
        .diagram-description {
            background-color: #f0f9ff; /* light-blue-50 */
            border-left: 4px solid #0ea5e9; /* sky-500 */
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 0.5rem;
            font-style: italic;
            color: #0c4a6e; /* sky-900 */
            font-size: 0.95rem;
        }
        /* Estilo para o Canvas */
        #diagram-canvas {
            width: 100%; /* Faz o canvas ocupar a largura total do seu cont√™iner */
            max-width: 400px; /* Limita a largura m√°xima para n√£o ficar muito grande em desktops */
            height: 300px; /* Altura fixa para o canvas */
            display: block; /* Remove espa√ßo extra abaixo do canvas */
            margin: 0 auto 1.5rem auto; /* Centraliza e adiciona margem inferior */
            background-color: #ffffff; /* Fundo branco para o canvas */
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* Sombra sutil */
        }

        /* Estilos para o pop-up de corre√ß√£o em tempo real */
        .correction-popup {
            position: absolute;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
            padding: 0.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 100;
            font-size: 0.875rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .correction-popup button {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .correction-popup button:hover {
            background-color: #2563eb; /* blue-600 */
        }
        .correction-popup .suggestion {
            font-weight: 600;
            color: #1e40af; /* blue-800 */
        }

        /* Estilos para as textareas de reda√ß√£o */
        .essay-section-textarea {
            min-height: 80px; /* Altura m√≠nima padr√£o */
            line-height: 1.5; /* Espa√ßamento entre linhas */
        }

        /* Estilo para o bot√£o de ajuda */
        .help-button-icon {
            color: #6b7280; /* slate-500 */
            cursor: pointer;
            transition: color 0.2s;
        }
        .help-button-icon:hover {
            color: #4f46e5; /* indigo-600 */
        }
        .help-button-icon.disabled {
            pointer-events: none;
            opacity: 0.5;
        }

        /* Novas classes para estiliza√ß√£o de texto no modal de estudo */
        .highlight-term {
            color: #dc2626; /* red-600 */
            font-weight: bold;
        }
        .underline-text {
            text-decoration: underline;
            text-decoration-color: #2563eb; /* blue-600 */
            text-decoration-thickness: 2px;
        }
        .important-phrase {
            color: #047857; /* emerald-700 */
            background-color: #d1fae5; /* green-100 */
            padding: 2px 4px;
            border-radius: 4px;
        }

        /* Estilos para o mapa mental */
        .mind-map-node {
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            word-wrap: break-word; /* Garante que o texto quebre a linha */
        }

        .mind-map-node.level-0 {
            background-color: #6366f1; /* indigo-500 */
            color: white;
            font-size: 1.25rem;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .mind-map-node.level-1 {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            margin-left: 1.5rem;
        }

        .mind-map-node.level-2 {
            background-color: #06b6d4; /* cyan-500 */
            color: white;
            margin-left: 3rem;
        }

        .mind-map-node.level-3 {
            background-color: #10b981; /* emerald-500 */
            color: white;
            margin-left: 4.5rem;
        }

        .mind-map-node.level-4 {
            background-color: #f59e0b; /* amber-500 */
            color: white;
            margin-left: 6rem;
        }

        .mind-map-node.level-5 {
            background-color: #ef4444; /* red-500 */
            color: white;
            margin-left: 7.5rem;
        }
        
        /* Ajuste para bot√µes de estudo/mapa mental */
        .study-button, .mind-map-button {
            display: flex;
            align-items: center;
            padding: 0.3rem 0.6rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
        }
        .study-button {
            background-color: #e0f2fe; /* blue-50 */
            color: #2563eb; /* blue-600 */
            border: 1px solid #93c5fd; /* blue-300 */
        }
        .study-button:hover {
            background-color: #bfdbfe; /* blue-100 */
        }
        .mind-map-button {
            background-color: #ede9fe; /* violet-50 */
            color: #7c3aed; /* violet-600 */
            border: 1px solid #c4b5fd; /* violet-300 */
            padding: 0.3rem 0.5rem; /* Ajuste o padding para o √≠cone */
        }
        .mind-map-button:hover {
            background-color: #ddd6fe; /* violet-100 */
        }
        .study-button svg {
            margin-right: 0.25rem;
        }
        /* Removido margin-right para o √≠cone do mapa mental */
        .mind-map-button svg {
            margin-right: 0;
        }

    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-3xl mx-auto">
        
        <!-- Tela Inicial (Home Screen) -->
        <div id="home-screen" class="text-center">
            <!-- Fundo de texto transparente -->
            <div class="text-background-overlay">
                Gram√°tica Morfologia Sintaxe Fon√©tica Fonologia Acentua√ß√£o Ortografia H√≠fen Fonemas Encontros Voc√°licos Substantivo Adjetivo Verbo Artigo Pronome Adv√©rbio Preposi√ß√£o Conjun√ß√£o Numeral Interjei√ß√£o Morfema Termos Essenciais Sujeito Predicado Termos Integrantes Objeto Direto Objeto Indireto Complemento Nominal Agente da Passiva Termos Acess√≥rios Adjunto Adnominal Adjunto Adverbial Aposto Vocativo Concord√¢ncia Verbal Concord√¢ncia Nominal Reg√™ncia Verbal Reg√™ncia Nominal Transitividade Verbal Vozes do Verbo Voz Ativa Voz Passiva Voz Reflexiva Uso da V√≠rgula Crase Ora√ß√µes Reduzidas Coloca√ß√£o Pronominal Fun√ß√µes do Que e Se Pontua√ß√£o Portugu√™s L√≠ngua Portuguesa Estudo Pr√°tica Aprender Conhecimento
            </div>

            <header class="mb-10 relative z-10">
                <h1 class="text-5xl md:text-6xl font-bold text-slate-700 title-font">GRAMATIQU√äS</h1>
                <!-- Novo elemento para "Modo Concurseiro" com contorno -->
                <div class="inline-block border-2 border-indigo-600 rounded-lg px-4 py-2 mt-2 bg-white shadow-md">
                    <p class="text-indigo-700 text-2xl concurseiro-font">Modo Concurseiro</p>
                </div>
                <p class="text-slate-500 mt-2 text-lg">Aprenda e pratique para a sua aprova√ß√£o!</p>
            </header>
            <main class="flex justify-center items-center h-64 relative z-10">
                <!-- √çcone SVG com corte lateral no primeiro c√≠rculo -->
                <svg class="w-48 h-48 text-sky-600 drop-shadow-lg" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <!-- C√≠rculo externo com corte lateral -->
                    <path d="M 18 4 A 10 10 0 1 0 18 20" stroke="currentColor" stroke-width="2" fill="none"/>
                    <!-- C√≠rculo interno -->
                    <circle cx="12" cy="12" r="5" fill="currentColor"/>
                </svg>
            </main>
            <div id="level-selection-section" class="mt-8 relative z-10">
                <h3 class="text-2xl font-bold text-slate-700 mb-4">Selecione a op√ß√£o:</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 max-w-2xl mx-auto">
                    <!-- Bot√µes para as diferentes mat√©rias -->
                    <button id="level-enem" class="level-select-btn bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg" data-level="enem">
                        L√≠ngua Portuguesa
                    </button>
                    <button id="level-pedagogicos" class="level-select-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg" data-level="pedagogicos">
                        Conhecimentos Pedag√≥gicos
                    </button>
                    <button id="level-redacao" class="level-select-btn bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg" data-level="redacao">
                        Reda√ß√£o - Conte√∫do
                    </button>
                    <button id="level-redacao-correcao" class="level-select-btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg" data-level="redacao-correcao">
                        Reda√ß√£o - Corre√ß√£o de Texto
                    </button>
                    <button id="level-bonus" class="level-select-btn bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg" data-level="bonus">
                        Direito
                    </button>
                    <button id="level-leis" class="level-select-btn bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg" data-level="leis">
                        Leis e Diretrizes da Educa√ß√£o
                    </button>
                </div>
                <button id="enter-app-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition-colors shadow-lg opacity-50 cursor-not-allowed" disabled>
                    Iniciar
                </button>
            </div>
            <footer class="mt-8 relative z-10 text-xs text-slate-500">
                <p>Desenvolvido por: Prof.¬∫ Marlon Costa - L√≠ngua Portuguesa e Literatura / Gramatiqu√™s Vers√£o 1.0</p>
            </footer>
        </div>

        <!-- Tela de Sele√ß√£o de T√≥pico (para n√≠veis n√£o-concurseiro) - Ser√° escondida permanentemente -->
        <div id="topic-selection-screen" class="hidden">
            <header class="text-center mb-10">
                <h1 class="text-5xl md:text-6xl font-bold text-slate-700 title-font">GRAMATIQU√äS</h1>
                <p class="text-slate-500 mt-2 text-lg">Selecione um ou mais t√≥picos para estudar ou praticar.</p>
            </header>
            <main id="topic-container-quiz" class="space-y-8">
                <!-- Categorias e T√≥picos ser√£o inseridos aqui -->
            </main>
            <footer class="mt-8 text-center flex flex-col sm:flex-row justify-center items-center gap-4">
                <div class="flex items-center gap-2">
                    <label for="question-quantity-quiz" class="text-slate-700 font-semibold">Quest√µes:</label>
                    <input type="number" id="question-quantity-quiz" value="10" min="1" class="w-20 p-2 border border-slate-300 rounded-lg text-center">
                </div>
                <button id="start-selected-quiz" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-8 rounded-lg transition-colors shadow-lg opacity-50 cursor-not-allowed" disabled>
                    Iniciar Quiz com T√≥picos Selecionados
                </button>
                <button id="back-to-home-from-topics" class="back-to-home bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-3 px-6 rounded-lg transition-colors">
                    Voltar para o In√≠cio
                </button>
            </footer>
        </div>

        <!-- Tela de Configura√ß√£o do Simulado (para n√≠vel Concurseiro) -->
        <div id="simulado-setup-screen" class="hidden">
            <header class="text-center mb-10">
                <h1 class="text-5xl md:text-6xl font-bold text-slate-700 title-font">SIMULADO GRAMATIQU√äS</h1>
                <p class="text-slate-500 mt-2 text-lg">Selecione os t√≥picos e configure seu simulado.</p>
            </header>
            <main id="topic-container-simulado" class="space-y-8">
                <!-- As novas categorias de t√≥picos ser√£o inseridas aqui -->
            </main>
            <div class="mt-8 text-center flex flex-col items-center gap-4">
                <!-- Bot√µes de configura√ß√£o -->
                <div class="flex flex-wrap justify-center gap-4 w-full max-w-lg mx-auto">
                    <div class="flex flex-col items-center">
                        <button id="btn-num-questions" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg">
                            N¬∫ de Quest√µes
                        </button>
                        <p id="display-num-questions" class="text-black font-bold text-sm mt-1">---</p>
                    </div>
                    <div class="flex flex-col items-center">
                        <button id="btn-difficulty" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg">
                            N√≠vel
                        </button>
                        <p id="display-difficulty" class="text-black font-bold text-sm mt-1">---</p>
                    </div>
                    <div class="flex flex-col items-center">
                        <button id="btn-response-mode" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg">
                            Tipo de Gabarito
                        </button>
                        <p id="display-response-mode" class="text-black font-bold text-sm mt-1">---</p>
                    </div>
                </div>
                
                <button id="start-simulado" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition-colors shadow-lg opacity-50 cursor-not-allowed mt-6">
                    Gerar Simulado
                </button>
                <button id="back-to-home-from-simulado-setup" class="back-to-home bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-3 px-6 rounded-lg transition-colors">
                    Voltar para o In√≠cio
                </button>
            </div>
        </div>

        <!-- Tela de Leis e Diretrizes -->
        <div id="laws-screen" class="hidden">
            <header class="text-center mb-10">
                <h1 class="text-5xl md:text-6xl font-bold text-slate-700 title-font">LEIS E DIRETRIZES</h1>
                <p class="text-slate-500 mt-2 text-lg">Consulte os principais documentos da educa√ß√£o brasileira.</p>
            </header>
            <main id="laws-list-container" class="space-y-4 max-w-2xl mx-auto">
                <!-- Lista de leis ser√° inserida aqui -->
            </main>
            <footer class="mt-8 text-center">
                <button id="back-to-home-from-laws" class="back-to-home bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-3 px-6 rounded-lg transition-colors">
                    Voltar para o In√≠cio
                </button>
            </footer>
        </div>

        <!-- Tela do Quiz -->
        <div id="quiz-screen" class="hidden">
            <header class="mb-8 p-4 bg-gradient-to-br from-blue-100 to-blue-200 rounded-xl shadow-md max-w-2xl mx-auto">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 id="quiz-topic-title" class="text-2xl font-bold text-sky-700"></h2>
                        <p id="question-counter" class="text-slate-500"></p>
                    </div>
                    <div class="text-right">
                        <p class="text-slate-500">Pontua√ß√£o</p>
                        <p id="score" class="text-2xl font-bold text-slate-700">0</p>
                    </div>
                </div>
                <!-- Timer para Simulado -->
                <div id="timer-display-container" class="text-center text-lg font-semibold text-slate-700 mb-4 hidden">
                    Tempo: <span id="timer-display">00:00</span>
                </div>
                <!-- Barra de Progresso -->
                <div class="w-full bg-blue-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-sky-500 h-2.5 rounded-full transition-all duration-300 ease-out" style="width: 0%;"></div>
                </div>
            </header>

            <main id="question-container" class="bg-gradient-to-br from-blue-100 to-blue-200 p-6 md:p-8 rounded-xl shadow-md max-w-2xl mx-auto">
                <div id="loading-area" class="flex flex-col justify-center items-center h-40 hidden">
                    <div class="spinner mb-2"></div>
                    <p id="loading-text" class="text-slate-600 font-semibold">Gerando Quest√µes...</p>
                </div>
                <div id="quiz-content">
                    <p id="question-text" class="text-lg md:text-xl mb-6 min-h-[60px]"></p>
                    <!-- Bot√£o "+ Texto" -->
                    <button id="show-text-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg mb-4 hidden">
                        + Texto
                    </button>
                    <div id="options-container" class="flex flex-col space-y-3">
                        <!-- Op√ß√µes ser√£o inseridas aqui -->
                    </div>
                </div>
            </main>

            <footer class="mt-6 flex flex-wrap justify-center items-center gap-4 max-w-2xl mx-auto">
                <button id="back-to-menu" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg transition-colors">
                    Menu
                </button>
                <!-- Bot√£o "Perguntar ao Gramatiquinho" (vis√≠vel apenas para quizzes normais) -->
                <button id="ask-friends-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg flex items-center">
                    <span class="help-icon">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                    </span> Perguntar ao Gramatiquinho (<span id="friends-help-count">3</span>)
                </button>
                <!-- Bot√£o "Recurso da Quest√£o" -->
                <button id="appeal-question-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg flex items-center hidden">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                    </svg>
                    Recurso da Quest√£o
                </button>
                <button id="next-question" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg hidden">
                    Pr√≥xima Pergunta &rarr;
                </button>
            </footer>
        </div>

        <!-- Tela Final -->
        <div id="final-screen" class="hidden text-center bg-white p-8 rounded-xl shadow-md max-w-2xl mx-auto">
            <h2 class="text-3xl font-bold text-slate-700 mb-2">Quiz Finalizado!</h2>
            <p id="final-topic" class="text-xl text-sky-700 font-semibold mb-4"></p>
            <p class="text-lg text-slate-600 mb-1">Sua pontua√ß√£o final foi:</p>
            <p id="final-score" class="text-6xl font-bold text-slate-800 mb-4"></p>
            <p id="final-time" class="text-lg text-slate-600 mb-8 hidden"></p> <!-- Tempo final do simulado -->
            <div class="flex flex-wrap justify-center gap-4">
                <button id="restart-quiz" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                    Tentar Novamente
                </button>
                <button id="back-to-menu-final" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-3 px-6 rounded-lg transition-colors">
                    Escolher outro T√≥pico
                </button>
                <button id="back-to-home-from-final" class="back-to-home bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-3 px-6 rounded-lg transition-colors">
                    Voltar √† Tela Inicial
                </button>
            </div>
        </div>

        <!-- Tela de Corre√ß√£o de Reda√ß√£o -->
        <div id="essay-correction-screen" class="hidden">
            <header class="text-center mb-10">
                <h1 class="text-5xl md:text-6xl font-bold text-slate-700 title-font">PR√ÅTICA DE REDA√á√ÉO</h1>
                <p class="text-slate-500 mt-2 text-lg">Pratique a estrutura da sua reda√ß√£o e receba feedback.</p>
            </header>
            <main class="bg-white p-6 md:p-8 rounded-xl shadow-md max-w-2xl mx-auto relative">
                <div id="theme-display" class="bg-blue-50 p-3 rounded-lg border border-blue-200 text-blue-800 font-semibold mb-4 hidden">
                    <p class="text-sm text-blue-600">Tema da Reda√ß√£o:</p>
                    <p id="generated-theme-text" class="text-lg"></p>
                </div>
                
                <!-- Bot√£o Gerar Tema (movido para cima) -->
                <div class="flex flex-wrap justify-center gap-4 mb-6">
                    <button id="generate-theme-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg">
                        Gerar Tema de Reda√ß√£o
                    </button>
                </div>

                <!-- Campo de T√≠tulo Opcional -->
                <div class="mb-6">
                    <label for="essay-title-input" class="block text-lg font-semibold text-slate-700 mb-2">
                        T√≠tulo (Opcional):
                    </label>
                    <input type="text" id="essay-title-input" class="w-full p-4 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-slate-700" placeholder="Digite o t√≠tulo da sua reda√ß√£o aqui...">
                </div>

                <div class="mb-6">
                    <label for="intro-input" class="block text-lg font-semibold text-slate-700 mb-2">
                        Introdu√ß√£o:
                        <button type="button" class="help-button-icon align-middle" data-section="introducao" title="Dicas de Introdu√ß√£o">
                            <span class="text-xl">ü§ù</span> Ajuda
                        </button>
                    </label>
                    <textarea id="intro-input" class="essay-section-textarea w-full p-4 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 resize-y text-slate-700" placeholder="Comece sua introdu√ß√£o aqui..."></textarea>
                </div>
                <div class="mb-6">
                    <label for="dev-input" class="block text-lg font-semibold text-slate-700 mb-2">
                        Desenvolvimento:
                        <button type="button" class="help-button-icon align-middle" data-section="desenvolvimento" title="Dicas de Desenvolvimento">
                            <span class="text-xl">ü§ù</span> Ajuda
                        </button>
                    </label>
                    <textarea id="dev-input" class="essay-section-textarea w-full p-4 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 resize-y text-slate-700" placeholder="Desenvolva seus argumentos aqui..."></textarea>
                </div>
                <div class="mb-6">
                    <label for="conc-input" class="block text-lg font-semibold text-slate-700 mb-2">
                        Conclus√£o:
                        <button type="button" class="help-button-icon align-middle" data-section="conclusao" title="Dicas de Conclus√£o">
                            <span class="text-xl">ü§ù</span> Ajuda
                        </button>
                    </label>
                    <textarea id="conc-input" class="essay-section-textarea w-full p-4 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 resize-y text-slate-700" placeholder="Conclua sua reda√ß√£o aqui..."></textarea>
                </div>
                
                <div id="correction-loading-area" class="flex flex-col justify-center items-center h-20 hidden">
                    <div class="spinner mb-2"></div>
                    <p class="text-slate-600 font-semibold">Analisando sua reda√ß√£o...</p>
                </div>
                
                <!-- Bot√£o Corrigir Reda√ß√£o (movido para aqui) -->
                <div class="flex justify-center mb-6">
                    <button id="correct-essay-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg transition-colors shadow-lg">
                        Corrigir Reda√ß√£o
                    </button>
                </div>

                <div id="essay-feedback" class="bg-slate-50 p-4 rounded-lg border border-slate-200 min-h-[100px] text-slate-700 prose max-w-none">
                    <p class="text-slate-500 italic">Seu feedback aparecer√° aqui.</p>
                </div>

                <!-- Bot√µes de refazer reda√ß√£o e download PDF -->
                <div id="post-correction-actions" class="flex flex-wrap justify-center gap-4 mt-6 hidden">
                    <button id="redo-same-theme-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg">
                        Refazer com o mesmo tema
                    </button>
                    <button id="redo-new-theme-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg">
                        Gerar novo tema e refazer
                    </button>
                    <button id="download-essay-pdf-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg">
                        Download PDF
                    </button>
                </div>
                
                <div id="pdf-loading-area" class="flex flex-col justify-center items-center h-20 hidden">
                    <div class="spinner mb-2"></div>
                    <p class="text-slate-600 font-semibold">Gerando PDF...</p>
                </div>

                <!-- Container para popups de corre√ß√£o em tempo real -->
                <div id="realtime-correction-popups"></div>
            </main>
            <footer class="mt-8 text-center">
                <button id="back-to-home-from-essay-correction" class="back-to-home bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-3 px-6 rounded-lg transition-colors">
                    Voltar para o In√≠cio
                </button>
            </footer>
        </div>

    </div>

    <!-- Modais -->
    <div id="study-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="study-title">
        <div class="modal-container bg-white w-full max-w-md rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="study-title" class="text-2xl font-bold text-indigo-700 mb-4">
                <span class="professor-icon">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                        </svg>
                </span> <span id="study-modal-title-text"></span>
            </h3>
            <div id="study-content-wrapper">
                <div id="study-loading-area" class="flex flex-col justify-center items-center h-40 hidden">
                    <div class="spinner mb-2"></div>
                    <p class="text-slate-600 font-semibold">Carregando material de estudo...</p>
                </div>
                <div id="study-text" class="text-slate-600 space-y-3 prose max-w-none hidden"></div>
            </div>
            <button id="close-study-modal" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800 transition-colors" aria-label="Fechar explica√ß√£o">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>

    <div id="appeal-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="appeal-title">
        <div class="modal-container bg-white w-full max-w-md rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="appeal-title" class="text-2xl font-bold text-orange-700 mb-4">
                <svg class="w-6 h-6 inline-block mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                </svg>
                Recurso da Quest√£o
            </h3>
            <p class="text-slate-600 mb-4">Explique por que voc√™ acredita que a resposta est√° incorreta ou que sua resposta deveria ser considerada correta.</p>
            <textarea id="appeal-text-area" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 mb-4 h-32 resize-y" placeholder="Digite seu recurso aqui..."></textarea>
            <div id="appeal-response-container" class="bg-slate-50 p-3 rounded-lg border border-slate-200 hidden">
                <p class="font-semibold text-slate-700 mb-2">Avalia√ß√£o do Gramatiquinho:</p>
                <div class="flex justify-center items-center h-16 hidden">
                    <div class="spinner"></div>
                </div>
                <p id="appeal-response-text" class="text-slate-600"></p>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="submit-appeal-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-5 rounded-lg transition-colors shadow-lg">
                    Enviar Recurso
                </button>
                <button id="close-appeal-modal-btn" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-5 rounded-lg transition-colors">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <div id="question-distribution-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="distribution-title">
        <div class="modal-container bg-white w-full max-w-md rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="distribution-title" class="text-2xl font-bold text-indigo-700 mb-4">Distribuir Quest√µes por T√≥pico</h3>
            <p class="text-slate-600 mb-4">Defina quantas quest√µes voc√™ quer de cada t√≥pico selecionado. O total deve ser <span id="expected-total-questions" class="font-bold"></span>.</p>
            
            <div id="question-distribution-container" class="max-h-60 overflow-y-auto pr-2 mb-4 space-y-3"></div>

            <div class="flex justify-between items-center mb-4">
                <button id="randomize-distribution-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-md">
                    Distribuir Aleatoriamente
                </button>
                <p class="text-slate-700 font-semibold">Total Atual: <span id="distribution-total-display" class="font-bold text-sky-700">0</span></p>
            </div>
            <p id="distribution-error-message" class="text-red-500 text-sm mb-4 hidden">A soma das quest√µes n√£o corresponde ao total esperado.</p>

            <div class="flex justify-end gap-3 mt-6">
                <button id="confirm-distribution-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg transition-colors shadow-lg opacity-50 cursor-not-allowed" disabled>
                    Confirmar e Iniciar Simulado
                </button>
                <button id="cancel-distribution-btn" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-5 rounded-lg transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="performance-report-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="report-title">
        <div class="modal-container bg-white w-full max-w-md rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="report-title" class="text-2xl font-bold text-indigo-700 mb-4">Relat√≥rio de Desempenho</h3>
            <div id="performance-report-content" class="text-slate-600 space-y-2 max-h-60 overflow-y-auto pr-2 mb-4"></div>
            <div class="flex justify-end mt-4">
                <button id="close-report-modal-btn" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-5 rounded-lg transition-colors">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <div id="num-questions-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="num-questions-title">
        <div class="modal-container bg-white w-full max-w-xs rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="num-questions-title" class="text-2xl font-bold text-blue-700 mb-4">N√∫mero de Quest√µes</h3>
            <label for="modal-question-quantity-input" class="block text-slate-700 font-semibold mb-2">Quantidade:</label>
            <input type="number" id="modal-question-quantity-input" value="10" min="1" class="w-full p-2 border border-slate-300 rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
            <div class="flex justify-end gap-3 mt-6">
                <button id="confirm-num-questions" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg transition-colors shadow-lg">
                    Confirmar
                </button>
                <button id="cancel-num-questions" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-5 rounded-lg transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="difficulty-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="difficulty-title">
        <div class="modal-container bg-white w-full max-w-xs rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="difficulty-title" class="text-2xl font-bold text-purple-700 mb-4">N√≠vel</h3>
            <div class="flex flex-col gap-3">
                <input type="radio" id="modal-difficulty-iniciante" name="modalDifficulty" value="iniciante" class="hidden">
                <label for="modal-difficulty-iniciante" class="difficulty-label px-4 py-2 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-200 transition-colors text-slate-700 text-center">Iniciante</label>
                <input type="radio" id="modal-difficulty-intermediario" name="modalDifficulty" value="intermediario" class="hidden">
                <label for="modal-difficulty-intermediario" class="difficulty-label px-4 py-2 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-200 transition-colors text-slate-700 text-center">Intermedi√°rio</label>
                <input type="radio" id="modal-difficulty-avancado" name="modalDifficulty" value="avancado" class="hidden">
                <label for="modal-difficulty-avancado" class="difficulty-label px-4 py-2 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-200 transition-colors text-slate-700 text-center">Avan√ßado</label>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="confirm-difficulty" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-5 rounded-lg transition-colors shadow-lg">
                    Confirmar
                </button>
                <button id="cancel-difficulty" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-5 rounded-lg transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="response-mode-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="response-mode-title">
        <div class="modal-container bg-white w-full max-w-xs rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="response-mode-title" class="text-2xl font-bold text-orange-700 mb-4">Tipo de Gabarito</h3>
            <div class="flex flex-col gap-3">
                <input type="radio" id="modal-response-mode-certo-errado" name="modalResponseMode" value="certo-errado" class="hidden">
                <label for="modal-response-mode-certo-errado" class="response-mode-label px-4 py-2 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-200 transition-colors text-slate-700 text-center">Certo ou Errado</label>
                <input type="radio" id="modal-response-mode-multipla-escolha" name="modalResponseMode" value="multipla-escolha" class="hidden">
                <label for="modal-response-mode-multipla-escolha" class="response-mode-label px-4 py-2 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-200 transition-colors text-slate-700 text-center">M√∫ltipla Escolha (5 op√ß√µes)</label>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="confirm-response-mode" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-5 rounded-lg transition-colors shadow-lg">
                    Confirmar
                </button>
                <button id="cancel-response-mode" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-5 rounded-lg transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="text-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="text-modal-title">
        <div class="modal-container bg-white w-full max-w-2xl rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="text-modal-title" class="text-2xl font-bold text-indigo-700 mb-4">Texto de Apoio</h3>
            <div id="text-modal-content" class="text-modal-content"></div>
            <button id="close-text-modal" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800 transition-colors" aria-label="Fechar texto">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>

    <div id="modal-config-redacao" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="config-redacao-title">
        <div class="modal-container bg-white w-full max-w-md rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="config-redacao-title" class="text-2xl font-bold text-purple-700 mb-4">Configurar Reda√ß√£o</h3>
            <div class="mb-4">
                <label for="select-tipo-redacao" class="block text-slate-700 font-semibold mb-2">Tipo de Reda√ß√£o:</label>
                <select id="select-tipo-redacao" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="dissertacao-expositiva">Reda√ß√£o dissertativa expositiva</option>
                    <option value="dissertacao-argumentativa">Reda√ß√£o dissertativa argumentativa (ENEM)</option>
                    <option value="narrativa">Reda√ß√£o narrativa</option>
                    <option value="descritiva">Reda√ß√£o descritiva</option>
                    <option value="injuntiva">Reda√ß√£o injuntiva (ou instrucional)</option>
                    <option value="expositiva">Reda√ß√£o expositiva</option>
                    <option value="carta-pessoal">Carta pessoal</option>
                    <option value="carta-argumentativa">Carta argumentativa</option>
                    <option value="carta-do-leitor">Carta do leitor</option>
                    <option value="relato-ou-relatorio">Relato ou relat√≥rio</option>
                    <option value="cronica">Cr√¥nica</option>
                    <option value="artigo-de-opiniao">Artigo de opini√£o</option>
                    <option value="resumo">Resumo</option>
                    <option value="resenha-critica">Resenha cr√≠tica</option>
                    <option value="estudo-de-caso">Estudo de caso</option>
                </select>
            </div>
            <div class="mb-4">
                <label for="input-quantidade-linhas" class="block text-slate-700 font-semibold mb-2">Quantidade de linhas:</label>
                <input type="number" id="input-quantidade-linhas" value="30" min="10" max="60" class="w-full p-3 border border-slate-300 rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="confirm-config-redacao" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-5 rounded-lg transition-colors shadow-lg">
                    Confirmar
                </button>
                <button id="cancel-config-redacao" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-5 rounded-lg transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="modal-gerar-tema" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="gerar-tema-title">
        <div class="modal-container bg-white w-full max-w-md rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="gerar-tema-title" class="text-2xl font-bold text-blue-700 mb-4">Gerar Tema de Reda√ß√£o</h3>
            <div class="flex flex-col gap-4 mb-4">
                <button id="btn-temas-atuais" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg">
                    Temas Atuais
                </button>
                <button id="btn-temas-disciplina" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg">
                    Temas Ligados √† Disciplina
                </button>
            </div>
            <div id="disciplina-select-container" class="mb-4 hidden">
                <label for="select-disciplina-tema" class="block text-slate-700 font-semibold mb-2">Selecione a Disciplina:</label>
                <select id="select-disciplina-tema" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500"></select>
            </div>
            <div id="current-theme-input-container" class="mb-4 hidden">
                <label for="current-theme-input" class="block text-slate-700 font-semibold mb-2">Que tipo de tema atual?</label>
                <input type="text" id="current-theme-input" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: Meio ambiente, tecnologia, sa√∫de p√∫blica...">
            </div>

            <div id="tema-loading-area" class="flex flex-col justify-center items-center h-20 hidden">
                <div class="spinner mb-2"></div>
                <p class="text-slate-600 font-semibold">Gerando tema...</p>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="confirm-gerar-tema" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg transition-colors shadow-lg opacity-50 cursor-not-allowed" disabled>
                    Gerar Tema
                </button>
                <button id="cancel-gerar-tema" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-5 rounded-lg transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="help-tips-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="help-tips-title">
        <div class="modal-container bg-white w-full max-w-md rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="help-tips-title" class="text-2xl font-bold text-indigo-700 mb-4">Dicas para <span id="help-tips-section-name"></span></h3>
            <div id="help-tips-loading-area" class="flex flex-col justify-center items-center h-20 hidden">
                <div class="spinner mb-2"></div>
                <p class="text-slate-600 font-semibold">Gerando dicas...</p>
            </div>
            <div id="help-tips-content" class="text-slate-600 space-y-3 prose max-w-none min-h-[100px] flex items-center justify-center"></div>
            <div class="flex justify-between items-center mt-6">
                <button id="prev-tip-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Anterior
                </button>
                <span id="tip-counter" class="text-slate-600 text-sm"></span>
                <button id="next-tip-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg flex items-center">
                    Pr√≥xima
                    <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div class="flex justify-center mt-4">
                <button id="generate-more-tips-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg transition-colors shadow-lg">
                    Gerar Mais Dicas
                </button>
            </div>
            <button id="close-help-tips-modal" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800 transition-colors" aria-label="Fechar dicas">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>

    <div id="mind-map-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0" role="dialog" aria-modal="true" aria-labelledby="mind-map-title">
        <div class="modal-container bg-white w-full max-w-md rounded-xl shadow-2xl p-6 md:p-8 relative transform scale-95 opacity-0">
            <h3 id="mind-map-title" class="text-2xl font-bold text-violet-700 mb-4">
                <svg class="w-6 h-6 inline-block mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v4h-2zm0 6h2v2h-2z"/>
                </svg>
                Mapa Mental: <span id="mind-map-topic-name"></span>
            </h3>
            <div id="mind-map-content-wrapper">
                <div id="mind-map-loading-area" class="flex flex-col justify-center items-center h-40 hidden">
                    <div class="spinner mb-2"></div>
                    <p class="text-slate-600 font-semibold">Gerando mapa mental...</p>
                </div>
                <div id="mind-map-display" class="space-y-2 hidden"></div>
            </div>
            <button id="close-mind-map-modal" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800 transition-colors" aria-label="Fechar mapa mental">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>


    <script type="module">
        let currentLevel = null;
        let selectedTopics = [];
        let questionQuantity = 10;
        let difficulty = null;
        let responseMode = null;
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let isSimulado = false;
        let timerInterval = null;
        let timeLeft = 0;
        let friendsHelpCount = 3;
        let performanceReport = {};
        let currentQuestionData = null;
        let essayType = 'dissertacao-argumentativa';
        let essayLineQuantity = 30;
        let generatedEssayTheme = '';
        let essayTitle = '';
        let currentTips = [];
        let currentTipIndex = 0;
        let currentHelpSection = '';

        const homeScreen = document.getElementById('home-screen');
        const topicSelectionScreen = document.getElementById('topic-selection-screen');
        const simuladoSetupScreen = document.getElementById('simulado-setup-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const finalScreen = document.getElementById('final-screen');
        const essayCorrectionScreen = document.getElementById('essay-correction-screen');
        const lawsScreen = document.getElementById('laws-screen');
        const levelSelectButtons = document.querySelectorAll('.level-select-btn');
        const enterAppButton = document.getElementById('enter-app-btn');
        const levelSelectionSection = document.getElementById('level-selection-section');
        const topicContainerQuiz = document.getElementById('topic-container-quiz');
        const topicContainerSimulado = document.getElementById('topic-container-simulado');
        const questionQuantityQuizInput = document.getElementById('question-quantity-quiz');
        const startSelectedQuizButton = document.getElementById('start-selected-quiz');
        const btnNumQuestions = document.getElementById('btn-num-questions');
        const displayNumQuestions = document.getElementById('display-num-questions');
        const btnDifficulty = document.getElementById('btn-difficulty');
        const displayDifficulty = document.getElementById('display-difficulty');
        const btnResponseMode = document.getElementById('btn-response-mode');
        const displayResponseMode = document.getElementById('display-response-mode');
        const startSimuladoButton = document.getElementById('start-simulado');
        const quizTopicTitle = document.getElementById('quiz-topic-title');
        const questionCounter = document.getElementById('question-counter');
        const scoreDisplay = document.getElementById('score');
        const nextQuestionButton = document.getElementById('next-question');
        const backToMenuButton = document.getElementById('back-to-menu');
        const askFriendsButton = document.getElementById('ask-friends-btn');
        const friendsHelpCountSpan = document.getElementById('friends-help-count');
        const appealQuestionButton = document.getElementById('appeal-question-btn');
        const showTextButton = document.getElementById('show-text-button');
        const timerDisplayContainer = document.getElementById('timer-display-container');
        const timerDisplay = document.getElementById('timer-display');
        const finalScoreDisplay = document.getElementById('final-score');
        const finalTopicDisplay = document.getElementById('final-topic');
        const finalTimeDisplay = document.getElementById('final-time');
        const restartQuizButton = document.getElementById('restart-quiz');
        const backToMenuFinalButton = document.getElementById('back-to-menu-final');
        const studyModal = document.getElementById('study-modal');
        const studyModalTitleText = document.getElementById('study-modal-title-text');
        const studyLoadingArea = document.getElementById('study-loading-area');
        const studyText = document.getElementById('study-text');
        const closeStudyModalButton = document.getElementById('close-study-modal');
        const appealModal = document.getElementById('appeal-modal');
        const appealTextArea = document.getElementById('appeal-text-area');
        const appealResponseContainer = document.getElementById('appeal-response-container');
        const appealResponseLoading = appealModal.querySelector('.spinner');
        const appealResponseText = document.getElementById('appeal-response-text');
        const submitAppealButton = document.getElementById('submit-appeal-btn');
        const closeAppealModalButton = document.getElementById('close-appeal-modal-btn');
        const questionDistributionModal = document.getElementById('question-distribution-modal');
        const expectedTotalQuestionsSpan = document.getElementById('expected-total-questions');
        const questionDistributionContainer = document.getElementById('question-distribution-container');
        const randomizeDistributionBtn = document.getElementById('randomize-distribution-btn');
        const distributionTotalDisplay = document.getElementById('distribution-total-display');
        const distributionErrorMessage = document.getElementById('distribution-error-message');
        const confirmDistributionBtn = document.getElementById('confirm-distribution-btn');
        const cancelDistributionBtn = document.getElementById('cancel-distribution-btn');
        const performanceReportModal = document.getElementById('performance-report-modal');
        const performanceReportContent = document.getElementById('performance-report-content');
        const closeReportModalBtn = document.getElementById('close-report-modal-btn');
        const numQuestionsModal = document.getElementById('num-questions-modal');
        const modalQuestionQuantityInput = document.getElementById('modal-question-quantity-input');
        const confirmNumQuestionsBtn = document.getElementById('confirm-num-questions');
        const cancelNumQuestionsBtn = document.getElementById('cancel-num-questions');
        const difficultyModal = document.getElementById('difficulty-modal');
        const modalDifficultyRadios = document.querySelectorAll('input[name="modalDifficulty"]'); 
        const confirmDifficultyBtn = document.getElementById('confirm-difficulty');
        const cancelDifficultyBtn = document.getElementById('cancel-difficulty');
        const responseModeModal = document.getElementById('response-mode-modal');
        const modalResponseModeRadios = document.querySelectorAll('input[name="modalResponseMode"]'); 
        const confirmResponseModeBtn = document.getElementById('confirm-response-mode');
        const cancelResponseModeBtn = document.getElementById('cancel-response-mode');
        const textModal = document.getElementById('text-modal');
        const textModalTitle = document.getElementById('text-modal-title');
        const textModalContent = document.getElementById('text-modal-content');
        const closeTextModalButton = document.getElementById('close-text-modal');
        const essayTitleInput = document.getElementById('essay-title-input');
        const introInput = document.getElementById('intro-input');
        const devInput = document.getElementById('dev-input');
        const concInput = document.getElementById('conc-input');
        const correctEssayBtn = document.getElementById('correct-essay-btn');
        const essayFeedback = document.getElementById('essay-feedback');
        const correctionLoadingArea = document.getElementById('correction-loading-area');
        const realtimeCorrectionPopupsContainer = document.getElementById('realtime-correction-popups');
        const postCorrectionActions = document.getElementById('post-correction-actions');
        const redoSameThemeBtn = document.getElementById('redo-same-theme-btn');
        const redoNewThemeBtn = document.getElementById('redo-new-theme-btn');
        const downloadEssayPdfBtn = document.getElementById('download-essay-pdf-btn');
        const pdfLoadingArea = document.getElementById('pdf-loading-area');
        const modalConfigRedacao = document.getElementById('modal-config-redacao');
        const selectTipoRedacao = document.getElementById('select-tipo-redacao');
        const inputQuantidadeLinhas = document.getElementById('input-quantidade-linhas');
        const confirmConfigRedacaoBtn = document.getElementById('confirm-config-redacao');
        const cancelConfigRedacaoBtn = document.getElementById('cancel-config-redacao');
        const generateThemeBtn = document.getElementById('generate-theme-btn');
        const modalGerarTema = document.getElementById('modal-gerar-tema');
        const btnTemasAtuais = document.getElementById('btn-temas-atuais');
        const btnTemasDisciplina = document.getElementById('btn-temas-disciplina');
        const disciplinaSelectContainer = document.getElementById('disciplina-select-container');
        const selectDisciplinaTema = document.getElementById('select-disciplina-tema');
        const currentThemeInputContainer = document.getElementById('current-theme-input-container');
        const currentThemeInput = document.getElementById('current-theme-input');
        const temaLoadingArea = document.getElementById('tema-loading-area');
        const confirmGerarTemaBtn = document.getElementById('confirm-gerar-tema');
        const cancelGerarTemaBtn = document.getElementById('cancel-gerar-tema');
        const themeDisplay = document.getElementById('theme-display');
        const generatedThemeText = document.getElementById('generated-theme-text');
        const helpTipsModal = document.getElementById('help-tips-modal');
        const helpTipsTitle = document.getElementById('help-tips-title');
        const helpTipsSectionName = document.getElementById('help-tips-section-name');
        const helpTipsLoadingArea = document.getElementById('help-tips-loading-area');
        const helpTipsContent = document.getElementById('help-tips-content');
        const prevTipBtn = document.getElementById('prev-tip-btn');
        const nextTipBtn = document.getElementById('next-tip-btn');
        const tipCounter = document.getElementById('tip-counter');
        const closeHelpTipsModalBtn = document.getElementById('close-help-tips-modal');
        const helpButtons = document.querySelectorAll('.help-button-icon');
        const generateMoreTipsBtn = document.getElementById('generate-more-tips-btn');
        // Define loadingText here
        const loadingText = document.querySelector('#loading-area p');

        // DOM elements for quiz screen, now correctly defined
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const progressBar = document.getElementById('progress-bar');

        // Mind Map elements
        const mindMapModal = document.getElementById('mind-map-modal');
        const mindMapTopicName = document.getElementById('mind-map-topic-name');
        const mindMapLoadingArea = document.getElementById('mind-map-loading-area');
        const mindMapDisplay = document.getElementById('mind-map-display');
        const closeMindMapModalButton = document.getElementById('close-mind-map-modal');


        const grammarData = [
            {
                category: "L√≠ngua Portuguesa",
                levels: ["enem"], // Removido "redacao" daqui
                subCategories: [
                    {
                        name: "Fonologia e Ortografia",
                        topics: [
                            { id: 'fonemas', name: 'Fonemas e Letras', description: 'Diferen√ßa entre fonemas e letras, d√≠grafos e encontros consonantais.' },
                            { id: 'encontros-vocalicos', name: 'Encontros Voc√°licos (Ditongo, Tritongo, Hiato)', description: 'Conceito e identifica√ß√£o de ditongos, tritongos e hiatos.' },
                            { id: 'divisao-silabica', name: 'Divis√£o Sil√°bica', description: 'Regras de divis√£o sil√°bicas, incluindo casos especiais.' },
                            { id: 'acentuacao', name: 'Acentua√ß√£o Gr√°fica', description: 'Regras de ox√≠tonas, parox√≠tonas, proparox√≠tonas, hiatos e ditongos abertos.' },
                            { id: 'ortografia', name: 'Ortografia', description: 'Uso correto das letras (s/z, g/j, x/ch, etc.) e o novo acordo ortogr√°fico.' },
                            { id: 'hifen', name: 'Uso do H√≠fen', description: 'Regras de uso do h√≠fen em diferentes contextos e o novo acordo ortogr√°fico.' }
                        ]
                    },
                    {
                        name: "Morfologia",
                        topics: [
                            { id: 'substantivo', name: 'Substantivo', description: 'Classifica√ß√£o, flex√£o de g√™nero, n√∫mero e grau dos substantivos.' },
                            { id: 'adjetivo', name: 'Adjetivo', description: 'Classifica√ß√£o, flex√£o de g√™nero, n√∫mero e grau dos adjetivos.' },
                            { id: 'artigo', name: 'Artigo', description: 'Definidos e indefinidos, seu uso e import√¢ncia.' },
                            { id: 'numeral', name: 'Numeral', description: 'Classifica√ß√£o e uso dos numerais (cardinais, ordinais, multiplicativos, fracion√°rios).' },
                            { id: 'pronome', name: 'Pronome', description: 'Classifica√ß√£o (pessoal, possessivo, demonstrativo, etc.) e seu uso.' },
                            { id: 'verbo', name: 'Verbo', description: 'Conjuga√ß√£o, tempos e modos verbais, verbos regulares e irregulares.' },
                            { id: 'adverbio', name: 'Adv√©rbio', description: 'Classifica√ß√£o (tempo, lugar, modo, etc.) e locu√ß√£o adverbial.' },
                            { id: 'preposicao', name: 'Preposi√ß√£o', description: 'Conceito, classifica√ß√£o e combina√ß√£o de preposi√ß√µes.' },
                            { id: 'conjuncao', name: 'Conjun√ß√£o', description: 'Coordenativas e subordinativas, seu papel na conex√£o de ora√ß√µes.' },
                            { id: 'interjeicao', name: 'Interjei√ß√£o', description: 'Express√£o de emo√ß√µes e sentimentos.' },
                            { id: 'estrutura-palavras', name: 'Estrutura e Forma√ß√£o das Palavras', description: 'Radical, afixos, desin√™ncias, deriva√ß√£o e composi√ß√£o.' }
                        ]
                    },
                    {
                        name: "Sintaxe",
                        topics: [
                            { id: 'termos-essenciais', name: 'Termos Essenciais da Ora√ß√£o (Sujeito e Predicado)', description: 'Identifica√ß√£o e classifica√ß√£o de sujeito e predicado.' },
                            { id: 'termos-integrantes', name: 'Termos Integrantes da Ora√ß√£o (Objetos, Complemento Nominal, Agente da Passiva)', description: 'Fun√ß√µes sint√°ticas de objeto direto, indireto, complemento nominal e agente da passiva.' },
                            { id: 'termos-acessorios', name: 'Termos Acess√≥rios da Ora√ß√£o (Adjunto Adnominal, Adjunto Adverbial, Aposto, Vocativo)', description: 'Fun√ß√µes sint√°ticas de adjunto adnominal, adjunto adverbial, aposto e vocativo.' },
                            { id: 'concordancia-verbal', name: 'Concord√¢ncia Verbal', description: 'Regras de concord√¢ncia do verbo com o sujeito.' },
                            { id: 'concordancia-nominal', name: 'Concord√¢ncia Nominal', description: 'Regras de concord√¢ncia entre substantivo, adjetivo, artigo, pronome e numeral.' },
                            { id: 'regencia-verbal', name: 'Reg√™ncia Verbal', description: 'Rela√ß√£o entre o verbo e seus complementos.' },
                            { id: 'regencia-nominal', name: 'Reg√™ncia Nominal', description: 'Rela√ß√£o entre o nome (substantivo, adjetivo, adv√©rbio) e seu complemento.' },
                            { id: 'crase', name: 'Crase', description: 'Regras de uso do acento grave indicativo de crase.' },
                            { id: 'colocacao-pronominal', name: 'Coloca√ß√£o Pronominal (Pr√≥clise, Mes√≥clise, √änclise)', description: 'Regras de posicionamento dos pronomes obl√≠quos √°tonos.' },
                            { id: 'vozes-verbais', name: 'Vozes Verbais (Ativa, Passiva, Reflexiva)', description: 'Identifica√ß√£o e transforma√ß√£o das vozes verbais.' },
                            { id: 'periodo-simples-composto', name: 'Per√≠odo Simples e Per√≠odo Composto', description: 'Diferen√ßa entre ora√ß√µes e per√≠odos, coordena√ß√£o e subordina√ß√£o.' },
                            { id: 'oracoes-coordenadas', name: 'Ora√ß√µes Coordenadas', description: 'Classifica√ß√£o e uso das ora√ß√µes coordenadas (sind√©ticas e assind√©ticas).' },
                            { id: 'oracoes-subordinadas-substantivas', name: 'Ora√ß√µes Subordinadas Substantivas', description: 'Classifica√ß√£o e fun√ß√£o das ora√ß√µes subordinadas substantivas.' },
                            { id: 'oracoes-subordinadas-adjetivas', name: 'Ora√ß√µes Subordinadas Adjetivas', description: 'Classifica√ß√£o e fun√ß√£o das ora√ß√µes subordinadas adjetivas.' },
                            { id: 'oracoes-subordinadas-adverbiais', name: 'Ora√ß√µes Subordinadas Adverbiais', description: 'Classifica√ß√£o e fun√ß√£o das ora√ß√µes subordinadas adverbiais.' },
                            { id: 'oracoes-reduzidas', name: 'Ora√ß√µes Reduzidas', description: 'Conceito e classifica√ß√£o de ora√ß√µes reduzidas (infinitivo, ger√∫ndio, partic√≠pio).' },
                            { id: 'funcoes-que-se', name: 'Fun√ß√µes do "Que" e do "Se"', description: 'An√°lise sint√°tica e morfol√≥gica das palavras "que" e "se".' },
                            { id: 'pontuacao', name: 'Pontua√ß√£o (V√≠rgula, Ponto e V√≠rgula, Dois Pontos, Aspas, Par√™nteses)', description: 'Regras gerais e espec√≠ficas de pontua√ß√£o.' }
                        ]
                    },
                    {
                        name: "Sem√¢ntica e Estil√≠stica",
                        topics: [
                            { id: 'sinonimia-antonimia', name: 'Sinon√≠mia e Anton√≠mia', description: 'Rela√ß√µes de sentido entre as palavras.' },
                            { id: 'homonimia-paronimia', name: 'Homon√≠mia e Paron√≠mia', description: 'Palavras com sons ou grafias semelhantes, mas significados diferentes.' },
                            { id: 'polissemia', name: 'Polissemia', description: 'M√∫ltiplos significados de uma mesma palavra.' },
                            { id: 'conotacao-denotacao', name: 'Conota√ß√£o e Denota√ß√£o', description: 'Sentido real e figurado das palavras.' },
                            { id: 'figuras-linguagem', name: 'Figuras de Linguagem', description: 'Met√°fora, compara√ß√£o, personifica√ß√£o, hip√©rbole, eufemismo, etc.' },
                            { id: 'vicios-linguagem', name: 'V√≠cios de Linguagem', description: 'Ambiguidade, pleonasmo, cacofonia, barbarismo, etc.' }
                        ]
                    },
                    {
                        name: "Interpreta√ß√£o e Produ√ß√£o Textual",
                        topics: [
                            { id: 'leitura-interpretacao', name: 'Leitura e Interpreta√ß√£o de Textos', description: 'An√°lise de textos liter√°rios e n√£o liter√°rios, identifica√ß√£o de informa√ß√µes impl√≠citas e expl√≠citas, intertextualidade.' },
                            { id: 'tipos-generos-textuais', name: 'Tipos e G√™neros Textuais', description: 'Diferen√ßa entre narra√ß√£o, descri√ß√£o, disserta√ß√£o, injun√ß√£o e seus g√™neros.' },
                            { id: 'coesao-coerencia', name: 'Coes√£o e Coer√™ncia Textual', description: 'Mecanismos para garantir a fluidez e o sentido do texto.' },
                            { id: 'inferencia-deducao', name: 'Infer√™ncia e Dedu√ß√£o', description: 'Capacidade de extrair informa√ß√µes impl√≠citas e expl√≠citas do texto.' },
                            { id: 'elementos-narrativos', name: 'Elementos Narrativos (Enredo, Personagens, Narrador, Tempo, Espa√ßo)', description: 'An√°lise dos componentes de uma narrativa.' },
                            { id: 'argumentacao', name: 'Argumenta√ß√£o', description: 'Identifica√ß√£o de teses, argumentos e estrat√©gias argumentativas.' }
                        ]
                    },
                    {
                        name: "Literatura",
                        topics: [
                            { id: 'trovadorismo', name: 'Trovadorismo e Humanismo', description: 'Contexto hist√≥rico, caracter√≠sticas e principais autores.' },
                            { id: 'classicismo', name: 'Classicismo', description: 'Renascimento, Cam√µes e a epopeia portuguesa.' },
                            { id: 'barroco', name: 'Barroco', description: 'Contexto, caracter√≠sticas e principais autores (Greg√≥rio de Matos, Padre Ant√¥nio Vieira).' },
                            { id: 'arcadismo', name: 'Arcadismo', description: 'Contexto, caracter√≠sticas e principais autores (Tom√°s Ant√¥nio Gonzaga, Cl√°udio Manuel da Costa).' },
                            { id: 'romantismo', name: 'Romantismo', description: 'Tr√™s gera√ß√µes do Romantismo no Brasil e em Portugal, caracter√≠sticas e autores.' },
                            { id: 'realismo-naturalismo', name: 'Realismo e Naturalismo', description: 'Contexto, caracter√≠sticas e principais autores (Machado de Assis, Alu√≠sio Azevedo).' },
                            { id: 'parnasianismo-simbolismo', name: 'Parnasianismo e Simbolismo', description: 'Caracter√≠sticas e principais autores de cada escola.' },
                            { id: 'pre-modernismo', name: 'Pr√©-Modernismo', description: 'Transi√ß√£o, caracter√≠sticas e autores (Euclides da Cunha, Lima Barreto).' },
                            { id: 'modernismo-1fase', name: 'Modernismo - 1¬™ Fase', description: 'Semana de Arte Moderna, caracter√≠sticas e autores (M√°rio de Andrade, Oswald de Andrade).' },
                            { id: 'modernismo-2fase', name: 'Modernismo - 2¬™ Fase', description: 'Prosa e Poesia, caracter√≠sticas e autores (Graciliano Ramos, Carlos Drummond de Andrade).' },
                            { id: 'modernismo-3fase', name: 'Modernismo - 3¬™ Fase (P√≥s-Modernismo)', description: 'Gera√ß√£o de 45, caracter√≠sticas e autores (Jo√£o Cabral de Melo Neto, Clarice Lispector).' },
                            { id: 'literatura-contemporanea', name: 'Literatura Contempor√¢nea', description: 'Tend√™ncias atuais na literatura brasileira.' }
                        ]
                    },
                    {
                        name: "Lingu√≠stica",
                        topics: [
                            { id: 'linguistica-geral', name: 'Lingu√≠stica Geral', description: 'Conceitos fundamentais da lingu√≠stica, como l√≠ngua, fala, signo lingu√≠stico.' },
                            { id: 'fonetica-fonologia', name: 'Fon√©tica e Fonologia', description: 'Estudo dos sons da fala e dos sistemas sonoros das l√≠nguas.' },
                            { id: 'morfologia-linguistica', name: 'Morfologia Lingu√≠stica', description: 'Estudo da estrutura das palavras e seus processos de forma√ß√£o.' },
                            { id: 'sintaxe-linguistica', name: 'Sintaxe Lingu√≠stica', description: 'Estudo da organiza√ß√£o das palavras em frases e ora√ß√µes.' },
                            { id: 'semantica-pragmatica', name: 'Sem√¢ntica e Pragmaticidade', description: 'Estudo do significado e do uso da linguagem em contexto.' },
                            { id: 'sociolinguistica', name: 'Sociolingu√≠stica', description: 'Estudo da rela√ß√£o entre l√≠ngua e sociedade.' },
                            { id: 'psicolinguistica', name: 'Psicolingu√≠stica', description: 'Estudo da rela√ß√£o entre linguagem e processos mentais.' },
                            { id: 'historia-linguistica', name: 'Hist√≥ria da Lingu√≠stica', description: 'Principais escolas e teorias da lingu√≠stica ao longo do tempo.' }
                        ]
                    }
                ]
            },
            {
                category: "Conhecimentos Pedag√≥gicos",
                levels: ["pedagogicos"],
                subCategories: [
                    {
                        name: "Fundamentos e Teorias da Educa√ß√£o",
                        topics: [
                            { id: 'filosofia-educacao', name: 'Filosofia da Educa√ß√£o', description: 'Principais correntes filos√≥ficas e suas implica√ß√µes na educa√ß√£o.' },
                            { id: 'historia-educacao', name: 'Hist√≥ria da Educa√ß√£o', description: 'Principais momentos, influ√™ncias e movimentos que moldaram a escola.' },
                            { id: 'sociologia-educacao', name: 'Sociologia da Educa√ß√£o', description: 'Rela√ß√£o entre educa√ß√£o e sociedade, desigualdades e movimentos sociais.' },
                            { id: 'psicologia-educacao', name: 'Psicologia da Educa√ß√£o', description: 'Teorias de aprendizagem, desenvolvimento cognitivo e socioemocional.' },
                            { id: 'teorias-pedagogicas', name: 'Teorias Pedag√≥gicas', description: 'An√°lise das diferentes abordagens e tend√™ncias pedag√≥gicas.' }
                        ]
                    },
                    {
                        name: "Did√°tica e Metodologias de Ensino",
                        topics: [
                            { id: 'didatica-metodologias', name: 'Did√°tica e Metodologias de Ensino', description: 'Estrat√©gias e t√©cnicas para o processo de ensino-aprendizagem.' },
                            { id: 'praticas-educativas-aprendizagem', name: 'Pr√°ticas Educativas para o Processo de Aprendizagem de Crian√ßas, Adolescentes, Jovens e Adultos', description: 'Estrat√©gias para crian√ßas, adolescentes, jovens e adultos.' },
                            { id: 'metodologias-alfabetizacao', name: 'Metodologias de Alfabetiza√ß√£o', description: 'Teorias e t√©cnicas para alfabetizar com base em desenvolvimento cognitivo.' },
                            { id: 'abordagens-ativas', name: 'Abordagens Ativas (PBL, Projetos, Investiga√ß√£o, Experiencial, Design-based)', description: 'Problem-based, projeto, inquiry, experiential learning, design-based.' },
                            { id: 'aprendizagem-colaborativa-cooperativa', name: 'Aprendizagem Colaborativa e Cooperativa', description: 'Aprendizagem em grupo, comunidades de pr√°tica.' },
                            { id: 'aprendizagem-contextualizada-transdisciplinar', name: 'Aprendizagem Contextualizada e Transdisciplinar', description: 'Conex√£o com realidade, temas contempor√¢neos.' },
                            { id: 'pedagogia-critica-paulo-freire', name: 'Pedagogia Cr√≠tica (incluindo Paulo Freire)', description: 'Fundamentos e pr√°ticas da pedagogia cr√≠tica, com foco em Paulo Freire.' }
                        ]
                    },
                    {
                        name: "Avalia√ß√£o da Aprendizagem",
                        topics: [
                            { id: 'avaliacao-aprendizagem', name: 'Avalia√ß√£o da Aprendizagem', description: 'Conceitos, tipos e instrumentos de avalia√ß√£o no contexto escolar.' },
                            { id: 'avaliacao-formativa-somativa', name: 'Avalia√ß√£o Formativa e Somativa', description: 'Rubricas, feedback e autorregula√ß√£o dos alunos.' },
                            { id: 'didatica-avaliacao', name: 'Did√°tica da Avalia√ß√£o', description: 'Planejamento de provas, instrumentos e avalia√ß√£o criteriosa.' },
                            { id: 'planejamento-avaliacao-ensino', name: 'Planejamento e Avalia√ß√£o do Ensino e da Aprendizagem', description: 'Inter-rela√ß√£o entre planejamento, execu√ß√£o e avalia√ß√£o no processo educativo.' }
                        ]
                    },
                    {
                        name: "Tecnologias Educacionais",
                        topics: [
                            { id: 'tecnologias-educacionais', name: 'Tecnologias da Comunica√ß√£o e Informa√ß√£o nas Pr√°ticas Educativas', description: 'Uso de ferramentas digitais e recursos tecnol√≥gicos na educa√ß√£o.' },
                            { id: 'letramento-cientifico', name: 'Letramento Cient√≠fico', description: 'Desenvolvimento da capacidade de compreender e interpretar informa√ß√µes cient√≠ficas.' },
                            { id: 'pedagogia-criativa', name: 'Pedagogia Criativa', description: 'Estrat√©gias inovadoras, TRIZ, mescla entre criatividade e aprendizagem.' },
                            { id: 'tpack', name: 'TPACK (Technological‚ÄìPedagogical‚ÄìContent Knowledge)', description: 'Extens√£o do PCK que envolve o uso integrado de tecnologia.' }
                        ]
                    },
                    {
                        name: "Educa√ß√£o Inclusiva e Diversidade",
                        topics: [
                            { id: 'educacao-inclusiva', name: 'Educa√ß√£o Especial e Inclusiva', description: 'Conceitos, legisla√ß√£o e pr√°ticas da educa√ß√£o especial na perspectiva inclusiva.' },
                            { id: 'libras-cultura-surda', name: 'Libras, Cultura e Identidade Surda', description: 'Import√¢ncia da L√≠ngua Brasileira de Sinais e da cultura surda.' },
                            { id: 'direitos-humanos-educacao', name: 'Educa√ß√£o, Inclus√£o e Direitos Humanos', description: 'Promo√ß√£o e defesa dos direitos humanos no ambiente escolar e curr√≠culo.' },
                            { id: 'diversidade-etnico-raciais', name: 'Educa√ß√£o para as Rela√ß√µes √âtnico-Raciais', description: 'Abordagem da diversidade cultural, √©tnica e racial na escola e curr√≠culo.' },
                            { id: 'historias-culturas-africanas-indigenas', name: 'Hist√≥rias e Culturas Africanas, Afro-Brasileiras e Ind√≠genas', description: 'Estudo da contribui√ß√£o dessas culturas para a forma√ß√£o do Brasil.' },
                            { id: 'educacao-genero-sexualidade', name: 'Educa√ß√£o para as Rela√ß√µes de G√™nero e Sexualidade', description: 'Discuss√£o sobre g√™nero, sexualidade e respeito √† diversidade.' },
                            { id: 'educacao-socioambiental', name: 'Educa√ß√£o Socioambiental', description: 'Conscientiza√ß√£o sobre quest√µes ambientais e sociais.' }
                        ]
                    },
                    {
                        name: "Organiza√ß√£o e Gest√£o da Educa√ß√£o",
                        topics: [
                            { id: 'planejamento-organizacao-gestao-democratica', name: 'Planejamento, Organiza√ß√£o e Gest√£o Democr√°tica Educacional em Espa√ßo Escolar e N√£o Escolar', description: 'Estruturas e processos de gest√£o educacional em diferentes n√≠veis e espa√ßos.' },
                            { id: 'implementacao-avaliacao-curriculos-projetos', name: 'Implementa√ß√£o e Avalia√ß√£o de Curr√≠culos, Programas Educacionais e Projetos Pol√≠tico Pedag√≥gicos', description: 'Processos de elabora√ß√£o, implementa√ß√£o e avalia√ß√£o de propostas pedag√≥gicas.' },
                            { id: 'praticas-articulacao-escola-comunidade', name: 'Pr√°ticas de Articula√ß√£o entre Escola, Fam√≠lia, Comunidade e Movimentos Sociais', description: 'A import√¢ncia da intera√ß√£o e parceria para o desenvolvimento educacional.' },
                            { id: 'gestao-sala-aula', name: 'Gest√£o da Sala de Aula / Classroom Management', description: 'Clima, disciplina, din√¢micas, organiza√ß√£o e rela√ß√µes professor-aluno.' },
                            { id: 'gestao-democratica-escola', name: 'Gest√£o Democr√°tica na Escola', description: 'Princ√≠pios e pr√°ticas da gest√£o democr√°tica, participa√ß√£o da comunidade escolar.' },
                            { id: 'relacao-escola-comunidade', name: 'Rela√ß√£o Escola-Comunidade', description: 'A import√¢ncia da intera√ß√£o e parceria entre a escola e a comunidade local.' }
                        ]
                    },
                    {
                        name: "Pol√≠ticas e Curr√≠culo",
                        topics: [
                            { id: 'politicas-publicas-educacao', name: 'Pol√≠ticas P√∫blicas, Organiza√ß√£o, Financiamento e Avalia√ß√£o da Educa√ß√£o Brasileira', description: 'An√°lise das pol√≠ticas educacionais e seus impactos no sistema de ensino.' },
                            { id: 'teorias-praticas-curriculo', name: 'Teorias e Pr√°ticas de Curr√≠culo', description: 'Concep√ß√µes e abordagens curriculares, elabora√ß√£o e desenvolvimento.' },
                            { id: 'legislacao-educacional', name: 'Legisla√ß√£o Educacional (LDB, ECA, PNE, etc.)', description: 'LDB, ECA, PNE e outros documentos orientadores.' },
                            { id: 'bncc', name: 'BNCC - Base Nacional Comum Curricular', hasQuestions: true, description: 'Estrutura, objetivos e impacto da Base Nacional Comum Curricular.' },
                            { id: 'pcns', name: 'PCNs (Par√¢metros Curriculares Nacionais)', description: 'Diretrizes curriculares e temas transversais.' },
                            { id: 'curriculo-temas-transversais', name: 'Curr√≠culo e Temas Transversais', description: 'Temas contempor√¢neos (meio ambiente, diversidade, direitos humanos).' },
                            { id: 'planejamento-institucional-ppp', name: 'Planejamento Institucional e PPP', description: 'Elabora√ß√£o de projetos pol√≠tico-pedag√≥gicos.' },
                            { id: 'conselhos-escolares', name: 'Conselhos Escolares', description: 'Fun√ß√£o, composi√ß√£o e import√¢ncia dos conselhos escolares na gest√£o democr√°tica.' }
                        ]
                    },
                    {
                        name: "Desenvolvimento Profissional Docente e Pr√°tica",
                        topics: [
                            { id: 'identidade-trabalho-docente', name: 'Identidade e Especificidades do Trabalho Docente', description: 'Desafios e caracter√≠sticas da profiss√£o docente.' },
                            { id: 'estagio-supervisionado', name: 'Est√°gio Supervisionado', description: 'Import√¢ncia e etapas do est√°gio na forma√ß√£o docente.' },
                            { id: 'pratica-reflexiva-metacognicao', name: 'Pr√°tica Reflexiva e Metacogni√ß√£o', description: 'Reflex√£o-in-action (Sch√∂n), aprimoramento baseado na experi√™ncia.' },
                            { id: 'formacao-continuada-comunidades-pratica', name: 'Forma√ß√£o Continuada e Comunidades de Pr√°tica', description: 'Workshops, grupos de estudo, redes colaborativas.' },
                            { id: 'crencas-professor-decisao-pedagogica', name: 'Influ√™ncia das Cren√ßas do Professor sobre Decis√£o Pedag√≥gica', description: 'Impacto das cren√ßas do professor na pr√°tica em sala de aula.' }
                        ]
                    },
                    {
                        name: "Pesquisa em Educa√ß√£o",
                        topics: [
                            { id: 'metodologia-pesquisa-educacao', name: 'Metodologia de Pesquisa em Educa√ß√£o e Ensino', description: 'Fundamentos e tipos de pesquisa em educa√ß√£o, coleta e an√°lise de dados.' }
                        ]
                    }
                ]
            },
            {
                category: "Reda√ß√£o",
                levels: ["redacao", "redacao-correcao"], // Mantido "redacao" aqui para Reda√ß√£o - Conte√∫do
                subCategories: [
                    {
                        name: "Fundamentos da Reda√ß√£o",
                        topics: [
                            { id: 'tipos-redacao', name: 'Tipos de Reda√ß√£o (Disserta√ß√£o, Narra√ß√£o, Descri√ß√£o)', description: 'Caracter√≠sticas e estrutura de cada tipo textual.' },
                            { id: 'estrutura-dissertacao', name: 'Estrutura da Disserta√ß√£o-Argumentativa', description: 'Introdu√ß√£o, desenvolvimento e conclus√£o para textos dissertativos.' },
                            { id: 'tese-argumentacao', name: 'Tese e Argumenta√ß√£o', description: 'Como formular uma tese e construir argumentos s√≥lidos.' },
                            { id: 'coerencia-coesao', name: 'Coer√™ncia e Coes√£o Textual', description: 'Mecanismos para garantir a fluidez e o sentido do texto.' },
                            { id: 'norma-culta', name: 'Uso da Norma Culta', description: 'Adequa√ß√£o da linguagem formal em textos dissertativos.' },
                            { id: 'pontuacao-redacao', name: 'Pontua√ß√£o na Reda√ß√£o', description: 'Regras de pontua√ß√£o aplicadas √† escrita formal.' },
                            { id: 'conectivos-articuladores', name: 'Conectivos e Articuladores Textuais', description: 'Uso de conjun√ß√µes e adv√©rbios para ligar ideias.' },
                            { id: 'interpretacao-propostas', name: 'Interpreta√ß√£o de Propostas de Reda√ß√£o', description: 'An√°lise de temas e textos motivadores.' },
                            { id: 'repertorio-sociocultural', name: 'Repert√≥rio Sociocultural', description: 'Como usar conhecimentos de diversas √°reas para enriquecer a argumenta√ß√£o.' },
                            { id: 'citacoes-alusoes', name: 'Uso de Cita√ß√µes e Alus√µes', description: 'Como inserir cita√ß√µes e refer√™ncias de forma adequada.' },
                            { id: 'mecanismos-intervencao', name: 'Mecanismos de Interven√ß√£o (ENEM)', description: 'Propostas de solu√ß√£o para problemas sociais, com foco no ENEM.' },
                            { id: 'vicios-linguagem-redacao', name: 'V√≠cios de Linguagem na Reda√ß√£o', description: 'Identifica√ß√£o e corre√ß√£o de v√≠cios como pleonasmo, ambiguidade, etc.' },
                            { id: 'generos-textuais-redacao', name: 'G√™neros Textuais (Artigo de Opini√£o, Carta Aberta, Resenha)', description: 'An√°lise e produ√ß√£o de diferentes g√™neros textuais.' },
                            { id: 'argumentos-tipos', name: 'Tipos de Argumentos (Autoridade, Exemplifica√ß√£o, Compara√ß√£o)', description: 'Estrat√©gias argumentativas para defender um ponto de vista.' },
                            { id: 'paragrafo', name: 'O Par√°grafo (estrutura e fun√ß√£o)', description: 'Organiza√ß√£o das ideias em par√°grafos coerentes.' },
                            { id: 'ortografia-gramatica-aplicada', name: 'Ortografia e Gram√°tica Aplicada √† Reda√ß√£o', description: 'Revis√£o de regras gramaticais essenciais para a escrita.' },
                            { id: 'estudo-de-caso', name: 'Estudo de Caso', description: 'An√°lise e resolu√ß√£o de problemas pr√°ticos em formato de texto.' }
                        ]
                    }
                ]
            },
            {
                category: "Direito",
                levels: ["bonus"],
                subCategories: [
                    {
                        name: "Direito Constitucional",
                        topics: [
                            { id: 'const-fundamentos', name: 'Teoria da Constitui√ß√£o e Poder Constituinte', description: 'Conceitos, classifica√ß√£o e evolu√ß√£o das Constitui√ß√µes.' },
                            { id: 'const-direitos-fundamentais', name: 'Direitos e Deveres Fundamentais (Art. 5¬∫ CF)', description: 'Direitos individuais, sociais, pol√≠ticos e sua aplicabilidade.' },
                            { id: 'const-organizacao-estado', name: 'Organiza√ß√£o do Estado (Uni√£o, Estados, Munic√≠pios, DF)', description: 'Reparti√ß√£o de compet√™ncias e forma de Estado.' },
                            { id: 'const-poderes', name: 'Organiza√ß√£o dos Poderes (Legislativo, Executivo, Judici√°rio)', description: 'Estrutura, fun√ß√µes e controle dos Poderes.' },
                            { id: 'const-controle-constitucionalidade', name: 'Controle de Constitucionalidade', description: 'A√ß√µes (ADIN, ADPF, ADPF, MS) e sistemas de controle.' },
                            { id: 'const-administracao-publica', name: 'Administra√ß√£o P√∫blica na CF', description: 'Princ√≠pios, servidores p√∫blicos e responsabilidade civil do Estado.' }
                        ]
                    },
                    {
                        name: "Direito Administrativo",
                        topics: [
                            { id: 'adm-principios', name: 'Princ√≠pios do Direito Administrativo', description: 'Legalidade, impessoalidade, moralidade, publicidade, efici√™ncia.' },
                            { id: 'adm-organizacao', name: 'Organiza√ß√£o da Administra√ß√£o P√∫blica', description: 'Administra√ß√£o direta e indireta, entidades e agentes.' },
                            { id: 'adm-atos', name: 'Atos Administrativos', description: 'Conceito, requisitos, atributos, esp√©cies e invalida√ß√£o.' },
                            { id: 'adm-poderes', name: 'Poderes Administrativos', description: 'Hier√°rquico, disciplinar, regulamentar, de pol√≠cia.' },
                            { id: 'adm-licitacoes', name: 'Licita√ß√µes e Contratos Administrativos (Lei 14.133/21)', description: 'Modalidades, dispensa, inexigibilidade, execu√ß√£o.' },
                            { id: 'adm-servicos-publicos', name: 'Servi√ßos P√∫blicos', description: 'Conceito, princ√≠pios, formas de presta√ß√£o e concess√µes.' },
                            { id: 'adm-bens-publicos', name: 'Bens P√∫blicos', description: 'Classifica√ß√£o, regime jur√≠dico e formas de aquisi√ß√£o e aliena√ß√£o.' },
                            { id: 'adm-intervencao-estado', name: 'Interven√ß√£o do Estado na Propriedade Privada', description: 'Desapropria√ß√£o, servid√£o, requisi√ß√£o, tombamento.' },
                            { id: 'adm-responsabilidade-civil', name: 'Responsabilidade Civil do Estado', description: 'Teorias, requisitos e excludentes.' },
                            { id: 'adm-processo-administrativo', name: 'Processo Administrativo (Lei 9.784/99)', description: 'Princ√≠pios, fases e recursos.' }
                        ]
                    },
                    {
                        name: "Direito Civil",
                        topics: [
                            { id: 'civil-lei-introducao', name: 'Lei de Introdu√ß√£o √†s Normas do Direito Brasileiro (LINDB)', description: 'Vig√™ncia, aplica√ß√£o, interpreta√ß√£o e integra√ß√£o das normas.' },
                            { id: 'civil-pessoas', name: 'Pessoas Naturais e Jur√≠dicas', description: 'Capacidade, personalidade, domic√≠lio, bens, fatos jur√≠dicos.' },
                            { id: 'civil-bens', name: 'Bens', description: 'Classifica√ß√£o dos bens e sua import√¢ncia jur√≠dica.' },
                            { id: 'civil-fatos-atos-negocios', name: 'Fatos, Atos e Neg√≥cios Jur√≠dicos', description: 'Requisitos de validade, defeitos, nulidade e anulabilidade.' },
                            { id: 'civil-prescricao-decadencia', name: 'Prescri√ß√£o e Decad√™ncia', description: 'Conceitos, prazos e causas de interrup√ß√£o e suspens√£o.' },
                            { id: 'civil-obrigacoes', name: 'Direito das Obriga√ß√µes', description: 'Modalidades, transmiss√£o, adimplemento, inadimplemento.' },
                            { id: 'civil-contratos', name: 'Direito dos Contratos', description: 'Princ√≠pios, classifica√ß√£o, forma√ß√£o, v√≠cios redibit√≥rios, evic√ß√£o.' },
                            { id: 'civil-responsabilidade-civil', name: 'Responsabilidade Civil', description: 'Contratual e extracontratual, objetiva e subjetiva, dano moral e material.' },
                            { id: 'civil-familia', name: 'Direito de Fam√≠lia', description: 'Casamento, uni√£o est√°vel, div√≥rcio, alimentos, guarda.' },
                            { id: 'civil-sucessoes', name: 'Direito das Sucess√µes', description: 'Sucess√£o leg√≠tima e testament√°ria, invent√°rio e partilha.' },
                            { id: 'civil-reais', name: 'Direitos Reais', description: 'Propriedade, posse, usufruto, servid√£o.' }
                        ]
                    },
                    {
                        name: "Direito Penal",
                        topics: [
                            { id: 'penal-principios', name: 'Princ√≠pios do Direito Penal', description: 'Legalidade, anterioridade, culpabilidade, humanidade.' },
                            { id: 'penal-teoria-crime', name: 'Teoria Geral do Crime', description: 'Fato t√≠pico, antijuridicidade, culpabilidade, punibilidade.' },
                            { id: 'penal-imputabilidade', name: 'Imputabilidade Penal', description: 'Causas de exclus√£o e semi-imputabilidade.' },
                            { id: 'penal-concurso-crimes', name: 'Concurso de Pessoas e Concurso de Crimes', description: 'Autoria, participa√ß√£o, concurso material, formal, crime continuado.' },
                            { id: 'penal-penas', name: 'Teoria da Pena', description: 'Esp√©cies de penas, aplica√ß√£o, suspens√£o, livramento condicional.' },
                            { id: 'penal-extincao-punibilidade', name: 'Extin√ß√£o da Punibilidade', description: 'Prescri√ß√£o, decad√™ncia, peremp√ß√£o, morte do agente.' },
                            { id: 'penal-crimes-contra-pessoa', name: 'Crimes Contra a Pessoa', description: 'Homic√≠dio, les√£o corporal, cal√∫nia, difama√ß√£o, inj√∫ria.' },
                            { id: 'penal-crimes-contra-patrimonio', name: 'Crimes Contra o Patrim√¥nio', description: 'Furto, roubo, extors√£o, estelionato.' },
                            { id: 'penal-crimes-administracao-publica', name: 'Crimes Contra a Administra√ß√£o P√∫blica', description: 'Peculato, concuss√£o, corrup√ß√£o, prevarica√ß√£o.' }
                        ]
                    },
                    {
                        name: "Direito Processual Penal",
                        topics: [
                            { id: 'proc-penal-principios', name: 'Princ√≠pios do Processo Penal', description: 'Devido processo legal, contradit√≥rio, ampla defesa, presun√ß√£o de inoc√™ncia.' },
                            { id: 'proc-penal-inquerito', name: 'Inqu√©rito Policial', description: 'Natureza, caracter√≠sticas, valor probat√≥rio.' },
                            { id: 'proc-penal-acao-penal', name: 'A√ß√£o Penal', description: 'P√∫blica e privada, condi√ß√µes da a√ß√£o, den√∫ncia, queixa.' },
                            { id: 'proc-penal-provas', name: 'Provas no Processo Penal', description: 'Principios, meios de prova, prova il√≠cita.' },
                            { id: 'proc-penal-prisoes', name: 'Pris√µes e Liberdade Provis√≥ria', description: 'Flagrante, preventiva, tempor√°ria, fian√ßa.' },
                            { id: 'proc-penal-recursos', name: 'Recursos no Processo Penal', description: 'Apela√ß√£o, RESE, embargos, habeas corpus.' },
                            { id: 'proc-penal-jurisdicao-competencia', name: 'Jurisdi√ß√£o e Compet√™ncia', description: 'Conceito, crit√©rios de fixa√ß√£o, modifica√ß√£o.' }
                        ]
                    },
                    {
                        name: "Direito Processual Civil",
                        topics: [
                            { id: 'proc-civil-principios', name: 'Princ√≠pios do Processo Civil', description: 'Devido processo legal, contradit√≥rio, coopera√ß√£o, boa-f√©.' },
                            { id: 'proc-civil-jurisdicao-competencia', name: 'Jurisdi√ß√£o e Compet√™ncia', description: 'Conceito, crit√©rios de fixa√ß√£o, modifica√ß√£o.' },
                            { id: 'proc-civil-partes-procuradores', name: 'Partes e Procuradores', description: 'Capacidade, representa√ß√£o, substitui√ß√£o processual.' },
                            { id: 'proc-civil-atos-processuais', name: 'Atos Processuais', description: 'Forma, tempo, lugar, prazos, comunica√ß√£o.' },
                            { id: 'proc-civil-peticao-inicial', name: 'Peti√ß√£o Inicial e Resposta do R√©u', description: 'Requisitos, emenda, contesta√ß√£o, reconven√ß√£o.' },
                            { id: 'proc-civil-provas', name: 'Provas no Processo Civil', description: '√înus da prova, meios de prova, produ√ß√£o.' },
                            { id: 'proc-civil-sentenca-coisa-julgada', name: 'Senten√ßa e Coisa Julgada', description: 'Requisitos, efeitos, limites objetivos e subjetivos.' },
                            { id: 'proc-civil-recursos', name: 'Recursos no Processo Civil', description: 'Conceito, princ√≠pios, esp√©cies (apela√ß√£o, agravo, RE, REsp).' },
                            { id: 'proc-civil-execucao', name: 'Processo de Execu√ß√£o', description: 'T√≠tulo executivo, esp√©cies de execu√ß√£o, embargos √† execu√ß√£o.' }
                        ]
                    },
                    {
                        name: "Direito do Trabalho",
                        topics: [
                            { id: 'trab-principios', name: 'Princ√≠pios do Direito do Trabalho', description: 'Prote√ß√£o, irrenunciabilidade, continuidade da rela√ß√£o de emprego.' },
                            { id: 'trab-fontes', name: 'Fontes do Direito do Trabalho', description: 'CLT, Constitui√ß√£o, conven√ß√µes e acordos coletivos.' },
                            { id: 'trab-contrato-trabalho', name: 'Contrato Individual de Trabalho', description: 'Conceito, requisitos, esp√©cies, altera√ß√£o, suspens√£o, interrup√ß√£o.' },
                            { id: 'trab-salario-remuneracao', name: 'Sal√°rio e Remunera√ß√£o', description: 'Conceito, distin√ß√£o, adicionais, equipara√ß√£o salarial.' },
                            { id: 'trab-jornada-trabalho', name: 'Jornada de Trabalho', description: 'Dura√ß√£o, horas extras, intervalos, trabalho noturno.' },
                            { id: 'trab-extincao-contrato', name: 'Extin√ß√£o do Contrato de Trabalho', description: 'Justa causa, sem justa causa, rescis√£o indireta, FGTS, seguro-desemprego.' },
                            { id: 'trab-direito-coletivo', name: 'Direito Coletivo do Trabalho', description: 'Organiza√ß√£o sindical, negocia√ß√£o coletiva, greve.' },
                            { id: 'trab-processo-trabalho', name: 'Processo do Trabalho', description: 'Compet√™ncia, rito, recursos, execu√ß√£o trabalhista.' }
                        ]
                    },
                    {
                        name: "Direito Previdenci√°rio",
                        topics: [
                            { id: 'prev-principios', name: 'Princ√≠pios do Direito Previdenci√°rio', description: 'Solidariedade, universalidade, seletividade, distributividade.' },
                            { id: 'prev-seguridade-social', name: 'Seguridade Social', description: 'Conceito, organiza√ß√£o, financiamento, sa√∫de, assist√™ncia, previd√™ncia.' },
                            { id: 'prev-beneficios', name: 'Benef√≠cios Previdenci√°rios', description: 'Aposentadorias, pens√£o por morte, aux√≠lios, sal√°rio-maternidade.' },
                            { id: 'prev-segurados', name: 'Segurados Obrigat√≥rios e Facultativos', description: 'Categorias de segurados e suas contribui√ß√µes.' },
                            { id: 'prev-carencia', name: 'Per√≠odo de Car√™ncia', description: 'Requisitos para concess√£o de benef√≠cios.' },
                            { id: 'prev-salario-contribuicao', name: 'Sal√°rio de Contribui√ß√£o', description: 'Base de c√°lculo, limites e reajustes.' },
                            { id: 'prev-recursos-administrativos', name: 'Recursos Administrativos Previdenci√°rios', description: 'Processo administrativo no INSS.' }
                        ]
                    },
                    {
                        name: "Direito Tribut√°rio",
                        topics: [
                            { id: 'trib-principios', name: 'Princ√≠pios do Direito Tribut√°rio', description: 'Legalidade, irretroatividade, anterioridade, capacidade contributiva.' },
                            { id: 'trib-tributos', name: 'Sistema Tribut√°rio Nacional', description: 'Impostos, taxas, contribui√ß√µes de melhoria, empr√©stimos compuls√≥rios.' },
                            { id: 'trib-competencia', name: 'Compet√™ncia Tribut√°ria', description: 'Uni√£o, Estados, Munic√≠pios, DF e suas atribui√ß√µes.' },
                            { id: 'trib-obrigacao-credito', name: 'Obriga√ß√£o Tribut√°ria e Cr√©dito Tribut√°rio', description: 'Fato gerador, sujeito ativo e passivo, lan√ßamento, suspens√£o, extin√ß√£o, exclus√£o.' },
                            { id: 'trib-impostos-especie', name: 'Impostos em Esp√©cie', description: 'IR, IPI, ICMS, ISS, IPTU, IPVA, ITBI, ITCMD.' },
                            { id: 'trib-execucao-fiscal', name: 'Execu√ß√£o Fiscal', description: 'Processo de cobran√ßa judicial de cr√©ditos tribut√°rios.' }
                        ]
                    },
                    {
                        name: "Direito Empresarial (ou Comercial)",
                        topics: [
                            { id: 'emp-empresa-empresario', name: 'Empresa e Empres√°rio', description: 'Conceito, caracteriza√ß√£o, registro, empres√°rio individual.' },
                            { id: 'emp-sociedades', name: 'Direito Societ√°rio', description: 'Tipos de sociedades, constitui√ß√£o, dissolu√ß√£o, responsabilidade dos s√≥cios.' },
                            { id: 'emp-titulos-credito', name: 'T√≠tulos de Cr√©dito', description: 'Cheque, nota promiss√≥ria, duplicata, letra de c√¢mbio.' },
                            { id: 'emp-falencia-recuperacao', name: 'Fal√™ncia e Recupera√ß√£o de Empresas', description: 'Pressupostos, fases, efeitos, plano de recupera√ß√£o.' },
                            { id: 'emp-contratos-mercantis', name: 'Contratos Mercantis', description: 'Compra e venda mercantil, factoring, franquia, leasing.' },
                            { id: 'emp-propriedade-industrial', name: 'Propriedade Industrial', description: 'Patentes, marcas, desenhos industriais, indica√ß√µes geogr√°ficas.' }
                        ]
                    },
                    {
                        name: "Direito Ambiental",
                        topics: [
                            { id: 'amb-principios', name: 'Princ√≠pios do Direito Ambiental', description: 'Preven√ß√£o, precau√ß√£o, poluidor-pagador, desenvolvimento sustent√°vel.' },
                            { id: 'amb-sisnama', name: 'Pol√≠tica Nacional do Meio Ambiente (PNMA) e SISNAMA', description: 'Objetivos, instrumentos, √≥rg√£os.' },
                            { id: 'amb-licenciamento', name: 'Licenciamento Ambiental', description: 'Conceito, fases, EIA/RIMA.' },
                            { id: 'amb-responsabilidade', name: 'Responsabilidade Ambiental', description: 'Civil, penal e administrativa, solidariedade, objetividade.' },
                            { id: 'amb-unidades-conservacao', name: 'Unidades de Conserva√ß√£o', description: 'Classifica√ß√£o, categorias, cria√ß√£o, gest√£o.' },
                            { id: 'amb-recursos-hidricos', name: 'Recursos H√≠dricos', description: 'Pol√≠tica Nacional de Recursos H√≠dricos, uso, outorga.' },
                            { id: 'amb-florestal', name: 'Legisla√ß√£o Florestal (C√≥digo Florestal)', description: '√Åreas de Preserva√ß√£o Permanente (APP), Reserva Legal (RL).' }
                        ]
                    },
                    {
                        name: "Direito Internacional P√∫blico",
                        topics: [
                            { id: 'int-pub-fontes', name: 'Fontes do Direito Internacional P√∫blico', description: 'Tratados, costume, princ√≠pios gerais, jurisprud√™ncia.' },
                            { id: 'int-pub-sujeitos', name: 'Sujeitos de Direito Internacional P√∫blico', description: 'Estados, organiza√ß√µes internacionais, indiv√≠duos.' },
                            { id: 'int-pub-tratados', name: 'Tratados Internacionais', description: 'Conceito, classifica√ß√£o, forma√ß√£o, efeitos, extin√ß√£o.' },
                            { id: 'int-pub-solucao-controversias', name: 'Solu√ß√£o Pac√≠fica de Controv√©rsias', description: 'Negocia√ß√£o, media√ß√£o, arbitragem, Corte Internacional de Justi√ßa.' },
                            { id: 'int-pub-dir-humanos', name: 'Direito Internacional dos Direitos Humanos', description: 'Sistemas de prote√ß√£o, tratados, cortes (CIDH).' },
                            { id: 'int-pub-dir-conflitos-armados', name: 'Direito Internacional dos Conflitos Armados (Direito Humanit√°rio)', description: 'Regras de conduta em guerra, prote√ß√£o de v√≠timas.' }
                        ]
                    },
                    {
                        name: "Direito Internacional Privado",
                        topics: [
                            { id: 'int-priv-principios', name: 'Princ√≠pios do Direito Internacional Privado', description: 'Autonomia da vontade, lex fori, locus regit actum.' },
                            { id: 'int-priv-fontes', name: 'Fontes do Direito Internacional Privado', description: 'Lei de Introdu√ß√£o √†s Normas do Direito Brasileiro (LINDB), tratados.' },
                            { id: 'int-priv-competencia-internacional', name: 'Compet√™ncia Internacional', description: 'Jurisdi√ß√£o brasileira, litispend√™ncia, conex√£o.' },
                            { id: 'int-priv-lei-aplicavel', name: 'Lei Aplic√°vel', description: 'Conflito de leis, qualifica√ß√£o, reenvio.' },
                            { id: 'int-priv-condicao-juridica-estrangeiro', name: 'Condi√ß√£o Jur√≠dica do Estrangeiro no Brasil', description: 'Direitos, deveres, naturaliza√ß√£o, extradi√ß√£o.' },
                            { id: 'int-priv-homologacao-sentenca', name: 'Homologa√ß√£o de Senten√ßa Estrangeira', description: 'Requisitos, procedimento, efeitos.' }
                        ]
                    },
                    {
                        name: "Direito Eleitoral",
                        topics: [
                            { id: 'eleit-principios', name: 'Princ√≠pios do Direito Eleitoral', description: 'Soberania popular, voto direto, secreto, universal e peri√≥dico.' },
                            { id: 'eleit-justica-eleitoral', name: 'Organiza√ß√£o da Justi√ßa Eleitoral', description: 'TSE, TREs, Ju√≠zes Eleitorais, Juntas Eleitorais.' },
                            { id: 'eleit-alistamento-eleitoral', name: 'Alistamento Eleitoral e Domic√≠lio Eleitoral', description: 'Capacidade eleitoral ativa e passiva.' },
                            { id: 'eleit-elegibilidade-inelegibilidade', name: 'Elegibilidade e Inelegibilidade', description: 'Condi√ß√µes e causas de inelegibilidade.' },
                            { id: 'eleit-partidos-politicos', name: 'Partidos Pol√≠ticos', description: 'Cria√ß√£o, registro, funcionamento, fidelidade partid√°ria.' },
                            { id: 'eleit-propaganda-eleitoral', name: 'Propaganda Eleitoral', description: 'Regras, limites, il√≠citos eleitorais.' },
                            { id: 'eleit-financiamento-campanhas', name: 'Financiamento de Campanhas Eleitorais', description: 'Fontes, limites, presta√ß√£o de contas.' },
                            { id: 'eleit-crimes-eleitorais', name: 'Crimes Eleitorais', description: 'Principais tipos e san√ß√µes.' },
                            { id: 'eleit-acao-impugnacao', name: 'A√ß√µes Eleitorais (AIME, AIJE, RCED, Representa√ß√£o)', description: 'Finalidade e procedimento de cada a√ß√£o.' }
                        ]
                    },
                    {
                        name: "Direito Digital",
                        topics: [
                            { id: 'dig-principios', name: 'Princ√≠pios do Direito Digital', description: 'Privacidade, seguran√ßa, neutralidade de rede, prote√ß√£o de dados.' },
                            { id: 'dig-marco-civil', name: 'Marco Civil da Internet (Lei 12.965/14)', description: 'Direitos e deveres na internet, provedores.' },
                            { id: 'dig-lgpd', name: 'Lei Geral de Prote√ß√£o de Dados (LGPD - Lei 13.709/18)', description: 'Tratamento de dados pessoais, direitos dos titulares, ANPD.' },
                            { id: 'dig-crimes-ciberneticos', name: 'Crimes Cibern√©ticos', description: 'Invas√£o de dispositivo, interrup√ß√£o de servi√ßo, falsidade ideol√≥gica.' },
                            { id: 'dig-contratos-eletronicos', name: 'Contratos Eletr√¥nicos', description: 'Validade, assinatura digital, prova.' },
                            { id: 'dig-comercio-eletronico', name: 'Com√©rcio Eletr√¥nico', description: 'Direitos do consumidor, seguran√ßa nas transa√ß√µes.' },
                            { id: 'dig-propriedade-intelectual', name: 'Propriedade Intelectual no Ambiente Digital', description: 'Direitos autorais, softwares, pirataria.' }
                        ]
                    },
                    {
                        name: "Direitos Humanos",
                        topics: [
                            { id: 'dh-conceito-geracoes', name: 'Conceito e Gera√ß√µes de Direitos Humanos', description: 'Evolu√ß√£o hist√≥rica, caracter√≠sticas e dimens√µes.' },
                            { id: 'dh-declaracao-universal', name: 'Declara√ß√£o Universal dos Direitos Humanos (DUDH)', description: 'Conte√∫do e import√¢ncia.' },
                            { id: 'dh-tratados-internacionais', name: 'Tratados Internacionais de Direitos Humanos', description: 'Pacta de direitos civis e pol√≠ticos, direitos econ√¥micos, sociais e culturais.' },
                            { id: 'dh-sistemas-protecao', name: 'Sistemas de Prote√ß√£o dos Direitos Humanos', description: 'Sistema global (ONU) e sistemas regionais (OEA, UE).' },
                            { id: 'dh-direitos-humanos-brasil', name: 'Direitos Humanos na Constitui√ß√£o Federal', description: 'Art. 5¬∫ e sua aplicabilidade.' },
                            { id: 'dh-violacao-responsabilidade', name: 'Viola√ß√£o de Direitos Humanos e Responsabilidade', description: 'Crimes contra a humanidade, genoc√≠dio, tortura.' }
                        ]
                    }
                ]
            }
        ];
        
        const educationalLaws = [
            { id: 'ldb', name: 'LDB - Lei de Diretrizes e Bases da Educa√ß√£o Nacional (Lei n¬∫ 9.394/96)', hasQuestions: true },
            { id: 'pne', name: 'PNE - Plano Nacional de Educa√ß√£o (Lei n¬∫ 13.005/14)', hasQuestions: true },
            { id: 'bncc', name: 'BNCC - Base Nacional Comum Curricular', hasQuestions: true },
            { id: 'eca', name: 'ECA - Estatuto da Crian√ßa e do Adolescente (Lei n¬∫ 8.069/90)', hasQuestions: true },
            { id: 'lei-inclusao', name: 'Lei Brasileira de Inclus√£o da Pessoa com Defici√™ncia (Lei n¬∫ 13.146/15)', hasQuestions: true },
            { id: 'lei-libras', name: 'Lei de Libras (Lei n¬∫ 10.436/02)', hasQuestions: true },
            { id: 'lei-historia-afro', name: 'Lei n¬∫ 10.639/03 - Hist√≥ria e Cultura Afro-Brasileira e Africana', hasQuestions: true },
        ];

        function showScreen(screenToShow) {
            [homeScreen, topicSelectionScreen, simuladoSetupScreen, quizScreen, finalScreen, essayCorrectionScreen, lawsScreen].forEach(screen => {
                screen.classList.add('hidden');
            });
            if (screenToShow) {
                screenToShow.classList.remove('hidden');
            }
        }

        function openModal(modalElement) {
            modalElement.classList.remove('hidden');
            setTimeout(() => {
                modalElement.classList.remove('opacity-0');
                if (modalElement.querySelector('.modal-container')) {
                    modalElement.querySelector('.modal-container').classList.remove('opacity-0', 'scale-95');
                }
            }, 10);
        }

        function closeModal(modalElement) {
            modalElement.classList.add('opacity-0');
            if (modalElement.querySelector('.modal-container')) {
                modalElement.querySelector('.modal-container').classList.add('opacity-0', 'scale-95');
            }
            setTimeout(() => {
                modalElement.classList.add('hidden');
            }, 300);
        }

        function updateStartButtonState(buttonElement) {
            const hasSelectedTopics = selectedTopics.length > 0;
            const hasValidQuestionQuantity = questionQuantity !== null && !isNaN(questionQuantity) && questionQuantity > 0;
            const isSimuladoReady = hasSelectedTopics && hasValidQuestionQuantity && difficulty !== null && responseMode !== null;

            if (isSimuladoReady) {
                buttonElement.disabled = false;
                buttonElement.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                buttonElement.disabled = true;
                buttonElement.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function renderTopics() {
            const container = topicContainerSimulado;
            container.innerHTML = '';
            // Filtra as categorias para incluir apenas aquelas que correspondem ao currentLevel
            const categoriesForCurrentLevel = grammarData.filter(category => category.levels.includes(currentLevel));

            categoriesForCurrentLevel.forEach(category => {
                if (category.subCategories) {
                    category.subCategories.forEach(subCategory => {
                        const subCategoryDiv = document.createElement('div');
                        subCategoryDiv.className = 'bg-white p-6 rounded-xl shadow-md topic-card';
                        subCategoryDiv.innerHTML = `
                            <h3 class="text-xl font-bold text-sky-700 mb-4">${category.category} - ${subCategory.name}</h3>
                            <div class="topic-list-grid grid grid-cols-1 md:grid-cols-2 gap-3">
                                ${subCategory.topics.map(topic => `
                                    <label class="flex items-center p-3 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-50 transition-colors">
                                        <input type="checkbox" data-topic-id="${topic.id}" data-topic-name="${topic.name}" class="topic-checkbox w-5 h-5 text-blue-600 rounded focus:ring-blue-500 mr-3">
                                        <span class="text-slate-700 font-medium">${topic.name}</span>
                                        <div class="ml-auto flex gap-2">
                                            <button type="button" class="study-button flex items-center" data-topic-id="${topic.id}" data-topic-name="${topic.name}" title="Estudar este t√≥pico">
                                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                                                <span>Estudar</span>
                                            </button>
                                            <button type="button" class="mind-map-button flex items-center" data-topic-id="${topic.id}" data-topic-name="${topic.name}" title="Ver Mapa Mental">
                                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v4h-2zm0 6h2v2h-2z"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </label>
                                `).join('')}
                            </div>
                        `;
                        container.appendChild(subCategoryDiv);
                    });
                }
            });

            container.querySelectorAll('.topic-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (event) => {
                    const topicId = event.target.dataset.topicId;
                    const topicName = event.target.dataset.topicName;
                    if (event.target.checked) {
                        selectedTopics.push({ id: topicId, name: topicName });
                    } else {
                        selectedTopics = selectedTopics.filter(topic => topic.id !== topicId);
                    }
                    updateStartButtonState(startSimuladoButton);
                });
            });

            container.querySelectorAll('.study-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const topicId = event.currentTarget.dataset.topicId;
                    const topicName = event.currentTarget.dataset.topicName;
                    openStudyModal(topicId, topicName, 'Estudar:');
                });
            });

            container.querySelectorAll('.mind-map-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const topicId = event.currentTarget.dataset.topicId;
                    const topicName = event.currentTarget.dataset.topicName;
                    openMindMapModal(topicId, topicName);
                });
            });
        }
        
        function renderLawsList() {
            const container = document.getElementById('laws-list-container');
            container.innerHTML = '';
            educationalLaws.forEach(law => {
                const lawDiv = document.createElement('div');
                lawDiv.className = 'w-full text-left p-4 bg-white rounded-lg shadow-md hover:bg-slate-50 transition-colors border-l-4 border-indigo-500 flex flex-col sm:flex-row justify-between items-start sm:items-center';
                lawDiv.innerHTML = `
                    <span class="text-slate-700 font-medium mb-2 sm:mb-0">${law.name}</span>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" class="study-button flex items-center" data-law-id="${law.id}" data-law-name="${law.name}" title="Consultar este documento">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                            <span>Consultar</span>
                        </button>
                        ${law.hasQuestions ? `
                        <button type="button" class="mind-map-button flex items-center" data-law-id="${law.id}" data-law-name="${law.name}" title="Praticar quest√µes sobre este documento">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                            </svg>
                            <span>Praticar</span>
                        </button>` : ''}
                    </div>
                `;
                container.appendChild(lawDiv);
            });

            container.querySelectorAll('.study-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const lawId = event.currentTarget.dataset.lawId;
                    const lawName = event.currentTarget.dataset.lawName;
                    openStudyModal(lawId, lawName, 'Consultar:');
                });
            });

            container.querySelectorAll('.mind-map-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const lawId = event.currentTarget.dataset.lawId;
                    const lawName = event.currentTarget.dataset.lawName;
                    startLawQuiz(lawId, lawName);
                });
            });
        }

        async function callGeminiAPI(prompt, isJson = false, schema = null) {
            // Replace "YOUR_API_KEY" with your actual Gemini API key.
            // Ensure the Generative Language API is enabled in your Google Cloud project.
            // Visit https://console.developers.google.com/apis/api/generativelanguage.googleapis.com/overview
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {}
            };

            if (isJson) {
                payload.generationConfig.responseMimeType = "application/json";
                if (schema) {
                    payload.generationConfig.responseSchema = schema;
                }
            }

            console.log('Calling Gemini API with payload:', payload); // Debugging log

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                console.log('Raw API response:', result); // Debugging log

                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    return isJson ? JSON.parse(text) : text;
                } else {
                    console.error("Resposta inesperada da API Gemini:", result);
                    throw new Error("A API n√£o retornou um resultado v√°lido.");
                }
            } catch (error) {
                console.error("Erro ao chamar a API Gemini:", error); // Debugging log
                throw error;
            }
        }

        function applyStudyTextStyling(text) {
            // Replace custom tags with styled HTML spans
            let styledText = text.replace(/<highlight-term>(.*?)<\/highlight-term>/g, '<span class="highlight-term">$1</span>');
            styledText = styledText.replace(/<underline-text>(.*?)<\/underline-text>/g, '<span class="underline-text">$1</span>');
            styledText = styledText.replace(/<important-phrase>(.*?)<\/important-phrase>/g, '<span class="important-phrase">$1</span>');
            return styledText;
        }

        async function openStudyModal(topicId, topicName, modalTitlePrefix) {
            studyModalTitleText.textContent = `${modalTitlePrefix} ${topicName}`;
            studyText.innerHTML = '';
            studyText.classList.add('hidden');
            studyLoadingArea.classList.remove('hidden'); // Show spinner immediately
            openModal(studyModal);

            try {
                let prompt = '';
                const isLaw = educationalLaws.some(law => law.id === topicId);

                if (isLaw) {
                    prompt = `Gere um resumo completo e os pontos mais importantes do seguinte documento: "${topicName}". Organize o conte√∫do de forma clara e did√°tica, usando t√≠tulos e subt√≠tulos em Markdown. Para termos chave, use a tag HTML <highlight-term>termo</highlight-term>. Para sublinhar, use <underline-text>texto a sublinhar</underline-text>. Para destacar frases importantes, use <important-phrase>frase importante</important-phrase>.`;
                } else {
                    let subjectName = "gram√°tica portuguesa";
                    for (const cat of grammarData) {
                        if (cat.subCategories?.some(subCat => subCat.topics.some(t => t.id === topicId))) {
                            subjectName = cat.category;
                            break;
                        }
                    }
                    prompt = `Gere um material de estudo detalhado e did√°tico sobre o t√≥pico de ${subjectName} "${topicName}" para o n√≠vel de concurso p√∫blico. Inclua exemplos claros e, se poss√≠vel, um pequeno exerc√≠cio com gabarito. Formate a resposta usando Markdown. Para termos chave, use a tag HTML <highlight-term>termo</highlight-term>. Para sublinhar, use <underline-text>texto a sublinhar</underline-text>. Para destacar frases importantes, use <important-phrase>frase importante</important-phrase>.`;
                }
                
                const markdownText = await callGeminiAPI(prompt);
                const styledHtml = applyStudyTextStyling(marked.parse(markdownText));
                studyText.innerHTML = styledHtml;
                studyText.classList.remove('hidden');
            } catch (error) {
                studyText.textContent = 'Ocorreu um erro ao carregar o material de estudo.';
                studyText.classList.remove('hidden');
            } finally {
                studyLoadingArea.classList.add('hidden'); // Hide spinner when done
            }
        }

        async function startLawQuiz(lawId, lawName) {
            currentLevel = 'leis'; // Set current level to laws
            selectedTopics = [{ id: lawId, name: lawName }];
            questionQuantity = 5; // Default questions for law quiz
            difficulty = 'intermediario'; // Default difficulty
            responseMode = 'multipla-escolha'; // Default response mode

            // Update display for simulado setup (optional, but good for consistency)
            displayNumQuestions.textContent = `${questionQuantity} Quest√µes`;
            displayDifficulty.textContent = 'Intermedi√°rio';
            displayResponseMode.textContent = 'M√∫ltipla Escolha (5 op√ß√µes)';

            // Directly start the quiz
            await startQuizOrSimulado();
        }


        async function generateQuestions() {
            // Define loadingArea and quizContent here
            const loadingArea = document.getElementById('loading-area');
            const quizContent = document.getElementById('quiz-content');

            loadingArea.classList.remove('hidden');
            quizContent.classList.add('hidden');
            loadingText.textContent = "Gerando Quest√µes...";
            console.log('Generating questions for topics:', selectedTopics); // Debugging log

            const responseSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "textContext": { "type": "STRING" },
                        "question": { "type": "STRING" },
                        "options": { "type": "ARRAY", "items": { "type": "STRING" } },
                        "correctAnswer": { "type": "STRING" }
                    },
                    required: ["question", "options", "correctAnswer"]
                }
            };
            console.log('Response Schema:', responseSchema); // Debugging log
            
            let allGeneratedQuestions = [];
            try {
                for (const topic of selectedTopics) {
                    const numQuestionsForTopic = topic.quantity || Math.ceil(questionQuantity / selectedTopics.length);
                    let prompt = '';

                    if (currentLevel === 'leis') {
                        prompt = `Gere ${numQuestionsForTopic} quest√µes sobre a lei "${topic.name}" para um simulado de n√≠vel ${difficulty}. As quest√µes devem ser elaboradas com o n√≠vel e estilo das bancas de concurso FCC, FGV e Cebraspe. Para cada quest√£o, forne√ßa um enunciado ("question"), ${responseMode === 'multipla-escolha' ? '5 op√ß√µes de resposta ("options")' : 'uma afirma√ß√£o'}, e a resposta correta ("correctAnswer"). Se relevante, inclua um texto de apoio ("textContext").`;
                    } else {
                        let subjectName = "gram√°tica portuguesa";
                        for (const cat of grammarData) {
                            if (cat.subCategories?.some(subCat => subCat.topics.some(t => t.id === topic.id))) {
                                subjectName = cat.category;
                                break;
                            }
                        }
                        prompt = `Gere ${numQuestionsForTopic} quest√µes sobre o t√≥pico de ${subjectName} "${topic.name}" para um simulado de n√≠vel ${difficulty}. As quest√µes devem ser elaboradas com o n√≠vel e estilo das bancas de concurso FCC, FGV e Cebraspe. Para cada quest√£o, forne√ßa um enunciado ("question"), ${responseMode === 'multipla-escolha' ? '5 op√ß√µes de resposta ("options")' : 'uma afirma√ß√£o'}, e a resposta correta ("correctAnswer"). Se relevante, inclua um texto de apoio ("textContext").`;
                    }
                    
                    console.log('Prompt for Gemini:', prompt); // Debugging log
                    
                    const parsedQuestions = await callGeminiAPI(prompt, true, responseSchema);
                    console.log('Parsed questions from API:', parsedQuestions); // Debugging log
                    parsedQuestions.forEach(q => {
                        q.topicId = topic.id;
                        q.topicName = topic.name;
                    });
                    allGeneratedQuestions.push(...parsedQuestions);
                }
                return allGeneratedQuestions.sort(() => Math.random() - 0.5);
            } catch (error) {
                console.error('Error generating questions:', error); // Debugging log
                return [];
            } finally {
                loadingArea.classList.add('hidden');
                quizContent.classList.remove('hidden');
            }
        }

        function displayQuestion() {
            if (currentQuestionIndex >= quizQuestions.length) {
                endQuiz();
                return;
            }
            currentQuestionData = quizQuestions[currentQuestionIndex];
            questionText.innerHTML = currentQuestionData.question;
            optionsContainer.innerHTML = '';
            showTextButton.classList.toggle('hidden', !currentQuestionData.textContext);

            const options = responseMode === 'certo-errado' ? ['Certo', 'Errado'] : currentQuestionData.options;
            options.forEach((optionText, index) => {
                const button = document.createElement('button');
                button.className = 'option-btn bg-blue-50 hover:bg-blue-100 text-blue-800 font-medium py-3 px-4 rounded-lg text-left shadow-sm border border-blue-200';
                button.textContent = optionText;
                button.addEventListener('click', () => checkAnswer(button, currentQuestionData.correctAnswer));
                optionsContainer.appendChild(button);
            });

            questionCounter.textContent = `Quest√£o ${currentQuestionIndex + 1} de ${quizQuestions.length}`;
            nextQuestionButton.classList.add('hidden');
            appealQuestionButton.classList.add('hidden');
            updateProgressBar();
        }

        async function showExplanationForIncorrectAnswer(questionData, selectedText) {
            studyModalTitleText.textContent = `Explica√ß√£o: ${questionData.topicName}`; // Set title
            studyText.innerHTML = ''; // Clear previous content
            studyText.classList.add('hidden'); // Hide text content
            studyLoadingArea.classList.remove('hidden'); // Show spinner
            openModal(studyModal); // Open the modal immediately

            try {
                let subjectName = "gram√°tica portuguesa";
                if (currentLevel === 'leis') {
                    subjectName = "Legisla√ß√£o Educacional";
                } else {
                    for (const cat of grammarData) {
                        if (cat.subCategories?.some(subCat => subCat.topics.some(t => t.id === questionData.topicId))) {
                            subjectName = cat.category;
                            break;
                        }
                    }
                }
                const prompt = `Explique detalhadamente por que a resposta correta para a quest√£o de ${subjectName} '${questionData.question}' √© '${questionData.correctAnswer}', e por que a resposta '${selectedText}' est√° incorreta. Para termos chave, use a tag HTML <highlight-term>termo</highlight-term>. Para sublinhar, use <underline-text>texto a sublinhar</underline-text>. Para destacar frases importantes, use <important-phrase>frase importante</important-phrase>.`;
                const explanationText = await callGeminiAPI(prompt);
                const styledHtml = applyStudyTextStyling(marked.parse(explanationText));
                studyText.innerHTML = styledHtml;
                studyText.classList.remove('hidden'); // Show text content
            } catch (error) {
                studyText.textContent = 'N√£o foi poss√≠vel carregar a explica√ß√£o.';
                studyText.classList.remove('hidden'); // Show error message
            } finally {
                studyLoadingArea.classList.add('hidden'); // Hide spinner
            }
        }

        function checkAnswer(selectedButton, correctAnswer) {
            const isCorrect = selectedButton.textContent.trim() === correctAnswer.trim();
            document.querySelectorAll('#options-container .option-btn').forEach(btn => {
                btn.disabled = true;
                if (btn.textContent.trim() === correctAnswer.trim()) {
                    btn.classList.add('correct');
                } else if (btn === selectedButton) {
                    btn.classList.add('incorrect');
                }
            });

            if (isCorrect) {
                score++;
                scoreDisplay.textContent = score;
                performanceReport[currentQuestionData.topicId].correct++;
            } else {
                performanceReport[currentQuestionData.topicId].incorrect++;
                showExplanationForIncorrectAnswer(currentQuestionData, selectedButton.textContent);
            }

            nextQuestionButton.classList.remove('hidden');
            appealQuestionButton.classList.remove('hidden');
        }

        function nextQuestion() {
            currentQuestionIndex++;
            displayQuestion();
        }

        function updateProgressBar() {
            const progress = (currentQuestionIndex / quizQuestions.length) * 100;
            progressBar.style.width = `${progress}%`;
        }

        function endQuiz() {
            stopTimer();
            finalTimeDisplay.textContent = `Tempo total: ${formatTime(timeLeft)}`;
            finalTimeDisplay.classList.remove('hidden');
            showPerformanceReport();
            finalScoreDisplay.textContent = `${score}/${quizQuestions.length}`;
            finalTopicDisplay.textContent = "Simulado";
            showScreen(finalScreen);
        }

        function startTimer() {
            let seconds = 0;
            timerInterval = setInterval(() => {
                seconds++;
                timeLeft = seconds;
                timerDisplay.textContent = formatTime(seconds);
            }, 1000);
            timerDisplayContainer.classList.remove('hidden');
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timerDisplayContainer.classList.add('hidden');
        }

        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        async function openAppealModal() {
            appealTextArea.value = '';
            appealResponseText.textContent = '';
            appealResponseContainer.classList.add('hidden');
            submitAppealButton.disabled = false;
            openModal(appealModal);
        }

        async function submitAppeal() {
            const userAppeal = appealTextArea.value.trim();
            if (!userAppeal) return;
            submitAppealButton.disabled = true;
            appealResponseContainer.classList.remove('hidden');
            appealResponseText.innerHTML = '<div class="spinner"></div>'; // Show spinner immediately

            try {
                const prompt = `Avalie o seguinte recurso de quest√£o. A quest√£o era: "${currentQuestionData.question}". A resposta correta era: "${currentQuestionData.correctAnswer}". O usu√°rio argumentou: "${userAppeal}". O recurso √© v√°lido? Justifique.`;
                const appealResponse = await callGeminiAPI(prompt);
                appealResponseText.textContent = appealResponse;
            } catch (error) {
                appealResponseText.textContent = 'Erro ao avaliar o recurso.';
            }
        }

        function openQuestionDistributionModal() {
            expectedTotalQuestionsSpan.textContent = questionQuantity;
            distributionTotalDisplay.textContent = '0';
            questionDistributionContainer.innerHTML = '';
            selectedTopics.forEach(topic => {
                const topicDiv = document.createElement('div');
                topicDiv.className = 'flex items-center justify-between bg-slate-50 p-3 rounded-lg border border-slate-200';
                topicDiv.innerHTML = `
                    <span class="text-slate-700 font-medium">${topic.name}:</span>
                    <input type="number" data-topic-id="${topic.id}" class="topic-distribution-input w-20 p-2 border border-slate-300 rounded-lg text-center" value="0" min="0">
                `;
                questionDistributionContainer.appendChild(topicDiv);
            });
            questionDistributionContainer.querySelectorAll('.topic-distribution-input').forEach(input => {
                input.addEventListener('input', updateDistributionTotal);
            });
            openModal(questionDistributionModal);
        }

        function updateDistributionTotal() {
            let currentTotal = Array.from(document.querySelectorAll('.topic-distribution-input')).reduce((sum, input) => sum + (parseInt(input.value) || 0), 0);
            distributionTotalDisplay.textContent = currentTotal;
            const isTotalCorrect = currentTotal === questionQuantity;
            confirmDistributionBtn.disabled = !isTotalCorrect;
            confirmDistributionBtn.classList.toggle('opacity-50', !isTotalCorrect);
            confirmDistributionBtn.classList.toggle('cursor-not-allowed', !isTotalCorrect);
            distributionErrorMessage.classList.toggle('hidden', isTotalCorrect);
        }

        function randomizeDistribution() {
            let total = questionQuantity;
            const inputs = Array.from(document.querySelectorAll('.topic-distribution-input'));
            const numTopics = inputs.length;
            if (numTopics === 0) return;
            const base = Math.floor(total / numTopics);
            let remainder = total % numTopics;
            inputs.forEach((input, index) => {
                input.value = base + (index < remainder ? 1 : 0);
            });
            updateDistributionTotal();
        }

        async function confirmDistributionAndStartSimulado() {
            selectedTopics.forEach(topic => {
                const input = questionDistributionContainer.querySelector(`input[data-topic-id="${topic.id}"]`);
                topic.quantity = parseInt(input.value) || 0;
            });
            closeModal(questionDistributionModal);
            await startQuizOrSimulado();
        }

        function showPerformanceReport() {
            performanceReportContent.innerHTML = '';
            Object.entries(performanceReport).forEach(([topicId, results]) => {
                const topic = selectedTopics.find(t => t.id === topicId) || { name: 'Desconhecido' };
                const p = document.createElement('p');
                p.innerHTML = `<strong>${topic.name}:</strong> Acertos: ${results.correct}, Erros: ${results.incorrect}`;
                performanceReportContent.appendChild(p);
            });
            openModal(performanceReportModal);
        }

        function openTextModal(text) {
            textModalContent.innerHTML = text.replace(/\n/g, '<br>');
            openModal(textModal);
        }

        async function correctEssay() {
            const fullEssay = [essayTitleInput.value, introInput.value, devInput.value, concInput.value].join('\n\n').trim();
            if (!fullEssay) return;
            correctionLoadingArea.classList.remove('hidden');
            correctEssayBtn.disabled = true;
            try {
                const prompt = `Avalie a seguinte reda√ß√£o do tipo "${essayType}", focando em gram√°tica, coes√£o, coer√™ncia e argumenta√ß√£o. Forne√ßa feedback detalhado e uma nota de 0 a 100. Formate com Markdown. Reda√ß√£o:\n\n${fullEssay}`;
                const feedbackMarkdown = await callGeminiAPI(prompt);
                essayFeedback.innerHTML = marked.parse(feedbackMarkdown);
                postCorrectionActions.classList.remove('hidden');
            } catch (error) {
                essayFeedback.innerHTML = '<p class="text-red-500">Erro ao corrigir a reda√ß√£o.</p>';
            } finally {
                correctionLoadingArea.classList.add('hidden');
                correctEssayBtn.disabled = false;
            }
        }

        function redoEssay(keepTheme) {
            [essayTitleInput, introInput, devInput, concInput].forEach(input => input.value = '');
            essayFeedback.innerHTML = '<p class="text-slate-500 italic">Seu feedback aparecer√° aqui.</p>';
            postCorrectionActions.classList.add('hidden');
            if (!keepTheme) {
                generatedEssayTheme = '';
                generatedThemeText.textContent = ''; // Clear the displayed theme text
                themeDisplay.classList.add('hidden'); // Hide the theme display area
                // Do NOT open modalGerarTema here. It should only open when generateThemeBtn is clicked.
            }
        }

        async function downloadEssayPdf() {
            pdfLoadingArea.classList.remove('hidden');
            downloadEssayPdfBtn.disabled = true;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const tempDiv = document.createElement('div');
            tempDiv.style.width = '180mm';
            tempDiv.innerHTML = `<h1>${essayTitleInput.value}</h1><h2>Tema: ${generatedEssayTheme}</h2><div>${introInput.value}</div><div>${devInput.value}</div><div>${concInput.value}</div><hr><h2>Feedback</h2><div>${essayFeedback.innerHTML}</div>`;
            document.body.appendChild(tempDiv);
            try {
                await doc.html(tempDiv, {
                    callback: function (doc) {
                        doc.save('redacao_feedback.pdf');
                    },
                    x: 15,
                    y: 15,
                    width: 180,
                    windowWidth: 650
                });
            } catch (error) {
                console.error("Erro ao gerar PDF:", error);
            } finally {
                document.body.removeChild(tempDiv);
                pdfLoadingArea.classList.add('hidden');
                downloadEssayPdfBtn.disabled = false;
            }
        }
        
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function initializeAppUI() {
            showScreen(homeScreen);
            currentLevel = null;
            selectedTopics = [];
            questionQuantity = 10;
            difficulty = null;
            responseMode = null;
            isSimulado = true;
            levelSelectButtons.forEach(btn => btn.classList.remove('selected', 'ring-4', 'ring-blue-400'));
            enterAppButton.disabled = true;
            enterAppButton.classList.add('opacity-50', 'cursor-not-allowed');
            displayNumQuestions.textContent = '---';
            displayDifficulty.textContent = '---';
            displayResponseMode.textContent = '---';
            updateStartButtonState(startSimuladoButton);
            redoEssay(false); // reseta e oculta campos da reda√ß√£o, mas n√£o abre o modal de tema
            themeDisplay.classList.add('hidden');
        }

        async function startQuizOrSimulado() {
            if (selectedTopics.length === 0) return;
            performanceReport = {};
            selectedTopics.forEach(topic => {
                performanceReport[topic.id] = { correct: 0, incorrect: 0 };
            });
            showScreen(quizScreen);
            quizQuestions = [];
            currentQuestionIndex = 0;
            score = 0;
            scoreDisplay.textContent = score;
            const subject = grammarData.find(cat => cat.levels.includes(currentLevel))?.category || "Simulado";
            quizTopicTitle.textContent = `${subject} - N√≠vel: ${difficulty || 'N/A'}`;
            startTimer();
            quizQuestions = await generateQuestions();
            if (quizQuestions.length > 0) {
                displayQuestion();
            } else {
                questionText.textContent = "N√£o foi poss√≠vel carregar as quest√µes. Verifique o console para mais detalhes."; // Updated error message
            }
        }

        function populateDisciplinaSelect() {
            selectDisciplinaTema.innerHTML = '<option value="">Selecione...</option>';
            ["Pedagogia", "Portugu√™s", "Matem√°tica", "Direito"].forEach(d => {
                selectDisciplinaTema.innerHTML += `<option value="${d}">${d}</option>`;
            });
        }

        const disciplineCategoryMap = { "Portugu√™s": "L√≠ngua Portuguesa", "Pedagogia": "Conhecimentos Pedag√≥gicos", "Direito": "Direito" };

        async function generateEssayTheme(type, specificTheme = '') {
            temaLoadingArea.classList.remove('hidden');
            confirmGerarTemaBtn.disabled = true;
            let prompt;
            if (type === 'current') {
                prompt = `Gere um tema de reda√ß√£o atual sobre "${specificTheme}" para concurso.`;
            } else if (type === 'discipline' && specificTheme) {
                prompt = `Gere um tema de reda√ß√£o para concurso sobre a disciplina de "${specificTheme}".`;
            } else return;

            try {
                const theme = await callGeminiAPI(prompt);
                generatedEssayTheme = theme.replace(/^(Tema:\s*|##\s*\*\*|\*\*)/gi, '').trim();
                generatedThemeText.textContent = generatedEssayTheme;
                themeDisplay.classList.remove('hidden');
                closeModal(modalGerarTema);
                // Enable essay inputs and correction button after theme generation
                [essayTitleInput, introInput, devInput, concInput].forEach(el => el.disabled = false);
                correctEssayBtn.disabled = false;
                helpButtons.forEach(btn => btn.classList.remove('disabled'));
            } catch (error) {
                generatedThemeText.textContent = 'Erro ao gerar tema.';
                themeDisplay.classList.remove('hidden');
            } finally {
                temaLoadingArea.classList.add('hidden');
                confirmGerarTemaBtn.disabled = false;
            }
        }

        async function openHelpTipsModal(section) {
            currentHelpSection = section;
            helpTipsSectionName.textContent = section.charAt(0).toUpperCase() + section.slice(1);
            currentTips = [];
            currentTipIndex = 0;
            helpTipsContent.innerHTML = ''; // Clear previous content
            helpTipsContent.classList.add('hidden'); // Hide text content
            helpTipsLoadingArea.classList.remove('hidden'); // Show spinner
            openModal(helpTipsModal);
            await generateTipsForSection(section, 'initial');
        }

        async function generateTipsForSection(section, type) {
            helpTipsLoadingArea.classList.remove('hidden');
            generateMoreTipsBtn.disabled = true;
            const context = `Considerando a reda√ß√£o tipo "${essayType}" sobre "${generatedEssayTheme}", `;
            const prompt = `${context} gere ${type === 'initial' ? 5 : 3} dicas pr√°ticas para a ${section} da reda√ß√£o. Formate como array JSON de strings.`;
            try {
                const newTips = await callGeminiAPI(prompt, true, { type: "ARRAY", items: { type: "STRING" } });
                currentTips.push(...newTips);
                if (type === 'initial') currentTipIndex = 0;
                displayCurrentTip();
                helpTipsContent.classList.remove('hidden'); // Show text content
            }
            catch (error) {
                helpTipsContent.textContent = 'Erro ao gerar dicas.';
                helpTipsContent.classList.remove('hidden'); // Show error message
            } finally {
                helpTipsLoadingArea.classList.add('hidden'); // Hide spinner
                generateMoreTipsBtn.disabled = false;
            }
        }

        function displayCurrentTip() {
            if (currentTips.length > 0) {
                helpTipsContent.textContent = currentTips[currentTipIndex];
                tipCounter.textContent = `${currentTipIndex + 1} de ${currentTips.length}`;
                prevTipBtn.disabled = currentTipIndex === 0;
                nextTipBtn.disabled = currentTipIndex === currentTips.length - 1;
            } else {
                helpTipsContent.textContent = "Nenhuma dica.";
                tipCounter.textContent = "0 de 0";
                prevTipBtn.disabled = nextTipBtn.disabled = true;
            }
        }

        async function openMindMapModal(topicId, topicName) {
            mindMapTopicName.textContent = topicName;
            mindMapDisplay.innerHTML = '';
            mindMapDisplay.classList.add('hidden');
            mindMapLoadingArea.classList.remove('hidden');
            openModal(mindMapModal);

            try {
                let prompt = '';
                let subjectName = "gram√°tica portuguesa"; // Default
                const isLaw = educationalLaws.some(law => law.id === topicId);

                if (isLaw) {
                    subjectName = "Legisla√ß√£o Educacional";
                } else {
                    for (const cat of grammarData) {
                        if (cat.subCategories?.some(subCat => subCat.topics.some(t => t.id === topicId))) {
                            subjectName = cat.category;
                            break;
                        }
                    }
                }

                prompt = `Gere uma estrutura de mapa mental EXAUSTIVA, altamente detalhada e com uma progress√£o L√ìGICA e HIERARQUIA impec√°vel em formato JSON sobre o t√≥pico "${topicName}" (que pertence √† √°rea de ${subjectName}). O mapa mental DEVE cobrir TODOS os aspectos essenciais do t√≥pico, apresentando informa√ß√µes de forma concisa mas informativa, utilizando frases curtas e diretas que transmitam o conceito. O n√≥ raiz (n√≠vel 0) DEVE ser o pr√≥prio nome do t√≥pico. Cada n√≠vel subsequente DEVE aprofundar o anterior, estabelecendo RELA√á√ïES CLARAS e CONEX√ïES L√ìGICAS entre os n√≥s, seguindo uma ordem did√°tica e sequencial (ex: Defini√ß√£o -> Tipos/Classifica√ß√µes -> Caracter√≠sticas -> Fun√ß√µes/Aplica√ß√µes -> Exemplos -> Implica√ß√µes/Consequ√™ncias). O JSON DEVE ter um campo "title" (o nome do t√≥pico) e um array "nodes". Cada n√≥ DEVE ter "text" (o conte√∫do do n√≥), "color" (escolha entre 'blue', 'green', 'red', 'purple', 'orange', 'cyan', 'emerald', 'amber', 'violet' para diferenciar n√≠veis ou categorias, com cores distintas para cada n√≠vel principal) e opcionalmente "children" (um array de n√≥s aninhados). A profundidade m√°xima DEVE ser de 5 n√≠veis. Garanta que o mapa mental seja EXTREMAMENTE completo, visualmente intuitivo (mesmo em formato textual) e um guia de estudo definitivo para o t√≥pico, com ramos bem definidos e sem redund√¢ncias.`;

                const mindMapSchema = {
                    type: "OBJECT",
                    properties: {
                        "title": { "type": "STRING" },
                        "nodes": {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "text": { "type": "STRING" },
                                    "color": { "type": "STRING", "enum": ["blue", "green", "red", "purple", "orange", "cyan", "emerald", "amber", "violet"] },
                                    "children": {
                                        type: "ARRAY",
                                        items: { "$ref": "#/definitions/Node" }
                                    }
                                },
                                required: ["text", "color"]
                            }
                        }
                    },
                    definitions: {
                        "Node": {
                            type: "OBJECT",
                            properties: {
                                "text": { "type": "STRING" },
                                "color": { "type": "STRING", "enum": ["blue", "green", "red", "purple", "orange", "cyan", "emerald", "amber", "violet"] },
                                "children": {
                                    type: "ARRAY",
                                    items: { "$ref": "#/definitions/Node" }
                                }
                            },
                            required: ["text", "color"]
                        }
                    },
                    required: ["title", "nodes"]
                };

                const mindMapData = await callGeminiAPI(prompt, true, mindMapSchema);
                renderMindMap(mindMapData.nodes, mindMapDisplay, 0);
                mindMapDisplay.classList.remove('hidden');
            } catch (error) {
                mindMapDisplay.textContent = 'Ocorreu um erro ao gerar o mapa mental.';
                mindMapDisplay.classList.remove('hidden');
            } finally {
                mindMapLoadingArea.classList.add('hidden');
            }
        }

        function renderMindMap(nodes, parentElement, level) {
            nodes.forEach(node => {
                const nodeDiv = document.createElement('div');
                nodeDiv.className = `mind-map-node level-${level} bg-${node.color}-500 text-white`;
                nodeDiv.textContent = node.text;
                parentElement.appendChild(nodeDiv);

                if (node.children && node.children.length > 0 && level < 5) { // Limit depth to avoid overflow
                    renderMindMap(node.children, nodeDiv, level + 1); // Changed parentElement to nodeDiv for correct nesting
                }
            });
        }


        levelSelectButtons.forEach(button => button.addEventListener('click', () => {
            currentLevel = button.dataset.level;
            levelSelectButtons.forEach(btn => btn.classList.remove('selected', 'ring-4', 'ring-blue-400'));
            button.classList.add('selected', 'ring-4', 'ring-blue-400');
            enterAppButton.disabled = false;
            enterAppButton.classList.remove('opacity-50', 'cursor-not-allowed');
        }));

        enterAppButton.addEventListener('click', () => {
            if (currentLevel === 'redacao-correcao') {
                openModal(modalConfigRedacao);
            } else if (currentLevel === 'leis') {
                renderLawsList();
                showScreen(lawsScreen);
            } else {
                renderTopics();
                showScreen(simuladoSetupScreen);
            }
        });

        confirmConfigRedacaoBtn.addEventListener('click', () => {
            essayType = selectTipoRedacao.value;
            essayLineQuantity = parseInt(inputQuantidadeLinhas.value);
            closeModal(modalConfigRedacao);
            showScreen(essayCorrectionScreen);
            // Disable essay inputs and correction button until a theme is generated
            [essayTitleInput, introInput, devInput, concInput].forEach(el => el.disabled = true);
            correctEssayBtn.disabled = true;
            helpButtons.forEach(btn => btn.classList.add('disabled'));
        });

        [btnNumQuestions, btnDifficulty, btnResponseMode].forEach(btn => {
            btn.addEventListener('click', () => {
                const modalId = btn.id.replace('btn-', '') + '-modal';
                openModal(document.getElementById(modalId));
            });
        });
        
        // Updated logic for confirmNumQuestionsBtn
        confirmNumQuestionsBtn.addEventListener('click', () => {
            questionQuantity = parseInt(modalQuestionQuantityInput.value);
            displayNumQuestions.textContent = `${questionQuantity} Quest√µes`;
            closeModal(numQuestionsModal);
            updateStartButtonState(startSimuladoButton);
        });

        // Updated logic for confirmDifficultyBtn
        confirmDifficultyBtn.addEventListener('click', () => {
            const selectedRadio = document.querySelector('input[name="modalDifficulty"]:checked');
            if (selectedRadio) {
                difficulty = selectedRadio.value;
                displayDifficulty.textContent = selectedRadio.labels[0].textContent;

                // Remove 'selected' class from all labels first
                document.querySelectorAll('.difficulty-label').forEach(label => {
                    label.classList.remove('selected');
                });

                // Add 'selected' class to the label of the chosen radio button
                const correspondingLabel = document.querySelector(`label[for="${selectedRadio.id}"]`);
                if (correspondingLabel) {
                    correspondingLabel.classList.add('selected');
                }

                closeModal(difficultyModal);
                updateStartButtonState(startSimuladoButton);
            }
        });

        // Event listener for difficulty radio buttons to apply 'selected' class immediately on change
        modalDifficultyRadios.forEach(radio => {
            radio.addEventListener('change', (event) => {
                document.querySelectorAll('.difficulty-label').forEach(label => {
                    label.classList.remove('selected');
                });
                if (event.target.checked) {
                    const correspondingLabel = document.querySelector(`label[for="${event.target.id}"]`);
                    if (correspondingLabel) {
                        correspondingLabel.classList.add('selected');
                    }
                }
            });
        });

        // Updated logic for confirmResponseModeBtn
        confirmResponseModeBtn.addEventListener('click', () => {
            const selectedRadio = document.querySelector('input[name="modalResponseMode"]:checked');
            if (selectedRadio) {
                responseMode = selectedRadio.value;
                displayResponseMode.textContent = selectedRadio.labels[0].textContent;

                // Remove 'selected' class from all labels first
                document.querySelectorAll('.response-mode-label').forEach(label => {
                    label.classList.remove('selected');
                });

                // Add 'selected' class to the label of the chosen radio button
                const correspondingLabel = document.querySelector(`label[for="${selectedRadio.id}"]`);
                if (correspondingLabel) {
                    correspondingLabel.classList.add('selected');
                }

                closeModal(responseModeModal);
                updateStartButtonState(startSimuladoButton);
            }
        });

        // Event listener for response mode radio buttons to apply 'selected' class immediately on change
        modalResponseModeRadios.forEach(radio => {
            radio.addEventListener('change', (event) => {
                document.querySelectorAll('.response-mode-label').forEach(label => {
                    label.classList.remove('selected');
                });
                if (event.target.checked) {
                    const correspondingLabel = document.querySelector(`label[for="${event.target.id}"]`);
                    if (correspondingLabel) {
                        correspondingLabel.classList.add('selected');
                    }
                }
            });
        });

        // Logic to pre-select radio buttons and apply 'selected' class when opening modals
        btnDifficulty.addEventListener('click', () => {
            openModal(document.getElementById('difficulty-modal'));
            document.querySelectorAll('.difficulty-label').forEach(label => {
                label.classList.remove('selected');
            });
            if (difficulty) {
                const radioToSelect = document.getElementById(`modal-difficulty-${difficulty}`);
                if (radioToSelect) {
                    radioToSelect.checked = true;
                    const correspondingLabel = document.querySelector(`label[for="modal-difficulty-${difficulty}"]`);
                    if (correspondingLabel) {
                        correspondingLabel.classList.add('selected');
                    }
                }
            }
        });

        btnResponseMode.addEventListener('click', () => {
            openModal(document.getElementById('response-mode-modal'));
            document.querySelectorAll('.response-mode-label').forEach(label => {
                label.classList.remove('selected');
            });
            if (responseMode) {
                const radioToSelect = document.getElementById(`modal-response-mode-${responseMode}`);
                if (radioToSelect) {
                    radioToSelect.checked = true;
                    const correspondingLabel = document.querySelector(`label[for="modal-response-mode-${responseMode}"]`);
                    if (correspondingLabel) {
                        correspondingLabel.classList.add('selected');
                    }
                }
            }
        });


        startSimuladoButton.addEventListener('click', () => {
            if (selectedTopics.length > 1) {
                openQuestionDistributionModal();
            } else {
                selectedTopics.forEach(t => t.quantity = questionQuantity);
                startQuizOrSimulado();
            }
        });
        
        document.querySelectorAll('.back-to-home').forEach(btn => btn.addEventListener('click', initializeAppUI));
        nextQuestionButton.addEventListener('click', nextQuestion);
        backToMenuButton.addEventListener('click', () => showScreen(simuladoSetupScreen));
        restartQuizButton.addEventListener('click', startQuizOrSimulado);
        backToMenuFinalButton.addEventListener('click', () => showScreen(simuladoSetupScreen));
        appealQuestionButton.addEventListener('click', openAppealModal);
        closeStudyModalButton.addEventListener('click', () => closeModal(studyModal));
        submitAppealButton.addEventListener('click', submitAppeal);
        closeAppealModalButton.addEventListener('click', () => closeModal(appealModal));
        randomizeDistributionBtn.addEventListener('click', randomizeDistribution);
        confirmDistributionBtn.addEventListener('click', confirmDistributionAndStartSimulado);
        cancelDistributionBtn.addEventListener('click', () => closeModal(questionDistributionModal));
        closeReportModalBtn.addEventListener('click', () => closeModal(performanceReportModal));
        showTextButton.addEventListener('click', () => openTextModal(currentQuestionData.textContext));
        closeTextModalButton.addEventListener('click', () => closeModal(textModal));
        correctEssayBtn.addEventListener('click', correctEssay);
        redoSameThemeBtn.addEventListener('click', () => redoEssay(true));
        redoNewThemeBtn.addEventListener('click', () => redoEssay(false));
        downloadEssayPdfBtn.addEventListener('click', downloadEssayPdf);
        generateThemeBtn.addEventListener('click', () => {
            populateDisciplinaSelect();
            openModal(modalGerarTema);
        });
        btnTemasAtuais.addEventListener('click', () => {
            disciplinaSelectContainer.classList.add('hidden');
            currentThemeInputContainer.classList.remove('hidden');
            confirmGerarTemaBtn.disabled = false;
            confirmGerarTemaBtn.dataset.themeType = 'current';
        });
        btnTemasDisciplina.addEventListener('click', () => {
            currentThemeInputContainer.classList.add('hidden');
            disciplinaSelectContainer.classList.remove('hidden');
            confirmGerarTemaBtn.disabled = true;
            confirmGerarTemaBtn.dataset.themeType = 'discipline';
        });
        selectDisciplinaTema.addEventListener('change', () => {
            confirmGerarTemaBtn.disabled = !selectDisciplinaTema.value;
        });
        confirmGerarTemaBtn.addEventListener('click', () => {
            const type = confirmGerarTemaBtn.dataset.themeType;
            const value = type === 'current' ? currentThemeInput.value : selectDisciplinaTema.value;
            generateEssayTheme(type, value);
        });
        cancelGerarTemaBtn.addEventListener('click', () => closeModal(modalGerarTema));
        helpButtons.forEach(btn => btn.addEventListener('click', e => openHelpTipsModal(e.currentTarget.dataset.section)));
        prevTipBtn.addEventListener('click', () => { if (currentTipIndex > 0) { currentTipIndex--; displayCurrentTip(); } });
        nextTipBtn.addEventListener('click', () => { if (currentTipIndex < currentTips.length - 1) { currentTipIndex++; displayCurrentTip(); } });
        generateMoreTipsBtn.addEventListener('click', () => generateTipsForSection(currentHelpSection, 'more'));
        closeHelpTipsModalBtn.addEventListener('click', () => closeModal(helpTipsModal));
        closeMindMapModalButton.addEventListener('click', () => closeModal(mindMapModal));
        
        const markedScript = document.createElement('script');
        markedScript.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
        document.head.appendChild(markedScript);

        const jspdfScript = document.createElement('script');
        jspdfScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        document.head.appendChild(jspdfScript);
        
        const html2canvasScript = document.createElement('script');
        html2canvasScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
        document.head.appendChild(html2canvasScript);

        window.onload = initializeAppUI;
    </script>
</body>
</html>
